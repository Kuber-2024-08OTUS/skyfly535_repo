# –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏–π –∫—É—Ä—Å–∞ "–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ Kubernetes-2024-08" 

# –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–Ω—è—Ç–∏—è:

## skyfly535_repo
skyfly535 kubernetes repository

### –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ:

- [HW1 –ó–Ω–∞–∫–æ–º—Å—Ç–≤–æ —Å —Ä–µ—à–µ–Ω–∏—è–º–∏ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ Kubernetes –∫–ª–∞—Å—Ç–µ—Ä–∞, —Å–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Ä–≤–æ–≥–æ pod.](#hw1-–∑–Ω–∞–∫–æ–º—Å—Ç–≤–æ-—Å-—Ä–µ—à–µ–Ω–∏—è–º–∏-–¥–ª—è-–∑–∞–ø—É—Å–∫–∞-–ª–æ–∫–∞–ª—å–Ω–æ–≥–æ-kubernetes-–∫–ª–∞—Å—Ç–µ—Ä–∞-—Å–æ–∑–¥–∞–Ω–∏–µ-–ø–µ—Ä–≤–æ–≥–æ-pod)

- [HW2 Kubernetes controllers. ReplicaSet, Deployment, DaemonSet.](#hw2-kubernetes-controllers-replicaset-deployment-daemonset)

- [HW3 –°–µ—Ç–µ–≤–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ Pod, —Å–µ—Ä–≤–∏—Å—ã.](#hw3-—Å–µ—Ç–µ–≤–æ–µ-–≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ-pod-—Å–µ—Ä–≤–∏—Å—ã)

- [HW4 Volumes, StorageClass, PV, PVC.](#hw4-volumes-storageclass-pv-pvc)

- [HW5 –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Ä–≤–∏—Å–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø—Ä–∞–≤ –¥–ª—è –Ω–∏—Ö.](#hw5-–Ω–∞—Å—Ç—Ä–æ–π–∫–∞-—Å–µ—Ä–≤–∏—Å–Ω—ã—Ö-–∞–∫–∫–∞—É–Ω—Ç–æ–≤-–∏-–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ-–ø—Ä–∞–≤-–¥–ª—è-–Ω–∏—Ö)

- [HW6 –®–∞–±–ª–æ–Ω–∏–∑–∞—Ü–∏—è –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Helm. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ community Helm charts.](#hw6-—à–∞–±–ª–æ–Ω–∏–∑–∞—Ü–∏—è-–º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è-–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ-helm-—É—Å—Ç–∞–Ω–æ–≤–∫–∞-community-helm-charts)

- [HW7 –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ CRD.](#hw7-—Å–æ–∑–¥–∞–Ω–∏–µ-—Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ-crd)

- [HW8 –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ.](#hw8-–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è-–≤-–∫–ª–∞—Å—Ç–µ—Ä–µ)

- [HW9 –°–µ—Ä–≤–∏—Å—ã —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è Kubernetes.](#hw9-—Å–µ—Ä–≤–∏—Å—ã-—Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ-–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è-–¥–ª—è-kubernetes)

- [HW10 GitOps –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –ø–æ—Å—Ç–∞–≤–∫–∏.](#hw10-gitops-–∏-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã-–ø–æ—Å—Ç–∞–≤–∫–∏)

- [HW11 –•—Ä–∞–Ω–∏–ª–∏—â–µ —Å–µ–∫—Ä–µ—Ç–æ–≤ –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. Vault.](#hw11-—Ö—Ä–∞–Ω–∏–ª–∏—â–µ-—Å–µ–∫—Ä–µ—Ç–æ–≤-–¥–ª—è-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è-vault)

- [HW12 –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ CSI –¥—Ä–∞–π–≤–µ—Ä–∞.](#hw12-—É—Å—Ç–∞–Ω–æ–≤–∫–∞-–∏-–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ-csi-–¥—Ä–∞–π–≤–µ—Ä–∞)

- [HW14 –ü–æ–¥—Ö–æ–¥—ã –∫ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—é production-grade –∫–ª–∞—Å—Ç–µ—Ä–∞.](#hw14-–ø–æ–¥—Ö–æ–¥—ã-–∫-—Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é-–∏-–æ–±–Ω–æ–≤–ª–µ–Ω–∏—é-production-grade-–∫–ª–∞—Å—Ç–µ—Ä–∞)


# HW14 –ü–æ–¥—Ö–æ–¥—ã –∫ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—é production-grade –∫–ª–∞—Å—Ç–µ—Ä–∞.

## –í –ø—Ä–æ—Ü–µ—Å—Å–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –î–ó –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è:

### **1. –ù–∞–ø–∏—Å–∞–Ω—ã –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã Terraform –¥–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –º–∞—à–∏–Ω —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—è—é—â–µ–≥–æ —É—Å–ª–æ–≤–∏—è–º –î–ó –≤ Yandex Cloud.**

–°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª `./kubernetes-prod/terraform_YC_k8s/nods.tf` —Å–æ —Å–ª–µ–¥—É—é—â–∏–º —Å–æ–¥–µ—Ä–∂–∏–º—ã–º:

```hcl
# –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–æ–¥—ã —Å –°ontrol plane (master)
resource "yandex_compute_instance" "master" {
  count = var.cp_nodes_count
  name  = "k8s-master-${count.index}"
  hostname = "master-${count.index}"
  

  resources {
    cores  = var.node_cpu_count_master
    memory = var.node_memory_size_master
  }

  boot_disk {
    initialize_params {
      type = "network-ssd"
      image_id = var.image_id # ID –æ–±—Ä–∞–∑–∞ Ubuntu 20.04 LTS
      size = var.node_disk_size_master
    }
  }

  network_interface {
    subnet_id = var.subnet_id
    nat       = true
  }

  metadata = {
    ssh-keys = "ubuntu:${file(var.public_key_path)}"
    user-data = file("${path.module}/userdata.yaml")
  }
}

# –æ–ø–∏—Å–∞–Ω–∏–µ worker –Ω–æ–¥
resource "yandex_compute_instance" "worker" {
  count = var.workload_nodes_count
  name  = "k8s-worker-${count.index}"
  hostname = "worker${count.index}"

  resources {
    cores  = var.node_cpu_count_worker
    memory = var.node_memory_size_worker
  }

  boot_disk {
    initialize_params {
      type = "network-ssd"
      image_id = var.image_id # ID –æ–±—Ä–∞–∑–∞ Ubuntu 20.04 LTS
      size = var.node_disk_size_worker
    }
  }

  network_interface {
    subnet_id = var.subnet_id
    nat       = true
  }

  metadata = {
    ssh-keys = "ubuntu:${file(var.public_key_path)}"
    user-data = file("${path.module}/userdata.yaml")
  }
}
```
---

### **2. –ù–∞–≥—É–≥–ª–µ–Ω –∏ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω —Ñ–∞–π–ª `./kubernetes-prod/terraform_YC_k8s/userdata.yaml` –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –≤ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –º–∞—à–∏–Ω—ã —Å–∫—Ä–∏–ø—Ç–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è —Å –ø–æ–º–æ—â—å—é Cloud-Init –ø—Ä–∏ –µ—ë –∑–∞–ø—É—Å–∫–µ.**

```yaml
#cloud-config
users:
 - default # –î–æ–±–∞–≤–ª—è–µ—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (default), –∫–æ—Ç–æ—Ä—ã–π –Ω–∞—Å–ª–µ–¥—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã

runcmd:
- |
  #!/bin/bash
  # –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è APT
  systemctl disable apt-daily.service && systemctl disable apt-daily.timer && systemctl disable apt-daily-upgrade.timer &&  systemctl disable apt-daily-upgrade.service
  systemctl stop apt-daily.service && systemctl stop apt-daily.timer && systemctl stop apt-daily-upgrade.timer && systemctl stop apt-daily-upgrade.service
  systemctl kill --kill-who=all apt-daily.service
  while ! (systemctl list-units --all apt-daily.service | egrep -q '(dead|failed)')
  do
    sleep 1;
  done
  # –°–æ–∑–¥–∞–µ—Ç—Å—è —Ñ–∞–π–ª /etc/sysctl.d/k8s.conf —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
  cat <<EOF |  tee /etc/sysctl.d/k8s.conf
  # –í–∫–ª—é—á–µ–Ω–∏–µ —Ñ–æ—Ä–≤–∞—Ä–¥–∏–Ω–≥–∞
  net.bridge.bridge-nf-call-iptables  = 1
  net.ipv4.ip_forward                 = 1
  # –í–∫–ª—é—á–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ –¥–ª—è iptables
  net.bridge.bridge-nf-call-ip6tables = 1
  EOF
  # –ü—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å –ø–æ–º–æ—â—å—é sysctl --system
  sudo sysctl --system
  # –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –º–æ–¥—É–ª–µ–π —è–¥—Ä–∞
  cat <<EOF | tee /etc/modules-load.d/k8s.conf
  overlay
  br_netfilter
  EOF
  modprobe overlay
  modprobe br_netfilter
  # –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –±—Ä–∞–Ω–¥–º–∞—É—ç—Ä–∞ UFW
  systemctl stop ufw && systemctl disable ufw
  # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –∫–ª—é—á —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è Kubernetes
  curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.30/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
  apt-get update
  apt-get install -y apt-transport-https ca-certificates curl gpg
  # –î–æ–±–∞–≤–ª—è–µ—Ç—Å—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–ª—è Kubernetes –≤–µ—Ä—Å–∏–∏ 1.30
  echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.30/deb/ /' | tee /etc/apt/sources.list.d/kubernetes.list
  OS=xUbuntu_20.04
  CRIO_VERSION=1.28
  echo "deb https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/$OS/ /"|sudo tee /etc/apt/sources.list.d/devel:kubic:libcontainers:stable.list
  echo "deb http://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable:/cri-o:/$CRIO_VERSION/$OS/ /"| tee /etc/apt/sources.list.d/devel:kubic:libcontainers:stable:cri-o:$CRIO_VERSION.list
  curl -L https://download.opensuse.org/repositories/devel:kubic:libcontainers:stable:cri-o:$CRIO_VERSION/$OS/Release.key |  apt-key add -
  curl -L https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/$OS/Release.key | apt-key add -
  apt-get update
  # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –ø–∞–∫–µ—Ç—ã: kubelet, kubeadm, kubectl (–æ—Å–Ω–æ–≤–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã Kubernetes), —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –ø–∞–∫–µ—Ç—ã CRI-O: cri-o, cri-o-runc, cri-tools (–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–Ω—ã–π —Ä–∞–Ω—Ç–∞–π–º)
  apt-get install -y kubelet kubeadm kubectl cri-o cri-o-runc cri-tools
  # –í–∫–ª—é—á–∞—é—Ç—Å—è –∏ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è —Å–ª—É–∂–±—ã CRI-O –∏ Kubelet
  systemctl enable crio.service
  systemctl start crio.service
  # –°—Ç–∞–≤–∏—Ç—Å—è "hold" –Ω–∞ –ø–∞–∫–µ—Ç—ã Kubernetes (kubelet, kubeadm, kubectl) –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∏—Ö –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
  apt-mark hold kubelet kubeadm kubectl
  systemctl enable --now kubelet
```

#### –†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–∞:
–ü–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã:
- –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã Kubernetes –∏ CRI-O.
- –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ Kubernetes-–∫–ª–∞—Å—Ç–µ—Ä–∞.
- –û—Ç–∫–ª—é—á–µ–Ω—ã –ª–∏—à–Ω–∏–µ —Å–ª—É–∂–±—ã –¥–ª—è –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ –ø–æ–º–µ—Ö –ø—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ Kubernetes. 

–≠—Ç–æ—Ç –ø–æ–¥—Ö–æ–¥ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä—É–µ—Ç –ø–µ—Ä–≤–∏—á–Ω—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã –∏ —Å–Ω–∏–∂–∞–µ—Ç –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —á–µ–ª–æ–≤–µ—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–∏.

---

### **3. –ù–∞–≥—É–≥–ª–µ–Ω –∏ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω —Ñ–∞–π–ª `./kubernetes-prod/terraform_YC_k8s/apply.sh` —Å–∫—Ä–∏–ø—Ç–∞ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω–æ–≥–æ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è Kubernetes-–∫–ª–∞—Å—Ç–µ—Ä–∞ —Å –ø–æ–º–æ—â—å—é Terraform –∏ kubeadm.**

```bash
# –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å –ø–æ–º–æ—â—å—é Terraform
terraform apply -auto-approve
# –û–∂–∏–¥–∞–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –º–∞—à–∏–Ω
sleep 60
# –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞ –º–∞—Å—Ç–µ—Ä-–Ω–æ–¥–µ
cat install_master.sh | ssh -o StrictHostKeyChecking=no ubuntu@$(terraform output -json | jq  '.master_ip_addr.value' | tr -d '"') 'sudo bash' | tee out/master.log
# –ü—Ä–∏–æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ –Ω–∞ 5 —Å–µ–∫—É–Ω–¥ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω–∞ –º–∞—Å—Ç–µ—Ä-–Ω–æ–¥–µ
sleep 5
# –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–∫—Ä–∏–ø—Ç–∞ –¥–ª—è –≤–æ—Ä–∫–µ—Ä-–Ω–æ–¥
echo 'cloud-init status --wait' > out/install_worker.sh 
cat out/master.log  | grep -A 1 'kubeadm join' >> out/install_worker.sh  
# –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ –Ω–∞ –≤–æ—Ä–∫–µ—Ä-–Ω–æ–¥–∞—Ö
for i in $(terraform output -json | jq  '.worker_ip_addr.value[]' | tr -d '"') ;do cat out/install_worker.sh | ssh  -o StrictHostKeyChecking=no ubuntu@$i sudo bash ; done  
```

## **–û–±—â–∏–π —Ä–∞–±–æ—á–∏–π –ø—Ä–æ—Ü–µ—Å—Å —Å–∫—Ä–∏–ø—Ç–∞**

1. **–†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã:**
   - –°–æ–∑–¥–∞—é—Ç—Å—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –º–∞—à–∏–Ω—ã –¥–ª—è –º–∞—Å—Ç–µ—Ä- –∏ –≤–æ—Ä–∫–µ—Ä-–Ω–æ–¥ —Å –ø–æ–º–æ—â—å—é Terraform.

2. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH-–¥–æ—Å—Ç—É–ø–∞:**
   - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –ø—Ä–∏–≤–∞—Ç–Ω–æ–º—É SSH-–∫–ª—é—á—É.

3. **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–∞—Å—Ç–µ—Ä-–Ω–æ–¥—ã:**
   - –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å–∫—Ä–∏–ø—Ç `install_master.sh` –Ω–∞ –º–∞—Å—Ç–µ—Ä-–Ω–æ–¥–µ, –∫–æ—Ç–æ—Ä—ã–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç Kubernetes-–∫–ª–∞—Å—Ç–µ—Ä.
   - –í—ã–≤–æ–¥ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.

4. **–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–∫—Ä–∏–ø—Ç–∞ –¥–ª—è –≤–æ—Ä–∫–µ—Ä-–Ω–æ–¥:**
   - –°–æ–∑–¥–∞—ë—Ç—Å—è —Å–∫—Ä–∏–ø—Ç `install_worker.sh`, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –∫–æ–º–∞–Ω–¥—É –æ–∂–∏–¥–∞–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è `cloud-init` –∏ –∫–æ–º–∞–Ω–¥—É `kubeadm join`.

5. **–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ—Ä–∫–µ—Ä-–Ω–æ–¥:**
   - –°–∫—Ä–∏–ø—Ç `install_worker.sh` –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –Ω–∞ –∫–∞–∂–¥–æ–π –≤–æ—Ä–∫–µ—Ä-–Ω–æ–¥–µ, –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è—è –∏—Ö –∫ –∫–ª–∞—Å—Ç–µ—Ä—É.

—Ñ–∞–π–ª `./kubernetes-prod/terraform_YC_k8s/install_master.sh`

```bash
# –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ Cloud-Init (–∞—Å—Ç–∞–≤–ª—è–µ—Ç —Å–∫—Ä–∏–ø—Ç –∂–¥–∞—Ç—å, –ø–æ–∫–∞ –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã cloud-init –Ω–µ –∑–∞–≤–µ—Ä—à–∞—Ç—Å—è)
cloud-init status --wait
# –∫–æ–º–∞–Ω–¥–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º–∞—è –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –º–∞—Å—Ç–µ—Ä-–Ω–æ–¥—ã Kubernetes, —Ç–æ –µ—Å—Ç—å –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (control plane)
kubeadm init --upload-certs --pod-network-cidr=10.244.0.0/16
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è kubectl
export KUBECONFIG=/etc/kubernetes/admin.conf
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ç–µ–≤–æ–≥–æ –ø–ª–∞–≥–∏–Ω–∞ Flannel
kubectl apply -f https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml
```

## **–û–±—â–∏–π —Ä–∞–±–æ—á–∏–π –ø—Ä–æ—Ü–µ—Å—Å —Å–∫—Ä–∏–ø—Ç–∞**

1. **–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã:**

   - –£–±–µ–∂–¥–∞–µ—Ç—Å—è, —á—Ç–æ –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã `cloud-init` –∑–∞–≤–µ—Ä—à–µ–Ω—ã, –∏ —Å–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —É—Å—Ç–∞–Ω–æ–≤–∫–µ Kubernetes.

2. **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–∞—Å—Ç–µ—Ä-–Ω–æ–¥—ã Kubernetes:**

   - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è Kubernetes.
   - –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ—Ç –∫–ª–∞—Å—Ç–µ—Ä –¥–ª—è –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –≤–æ—Ä–∫–µ—Ä-–Ω–æ–¥ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–µ—Ç–µ–≤–æ–≥–æ –ø–ª–∞–≥–∏–Ω–∞.

3. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–ª–∞—Å—Ç–µ—Ä—É:**

   - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `KUBECONFIG`, —á—Ç–æ–±—ã –∫–æ–º–∞–Ω–¥—ã `kubectl` –º–æ–≥–ª–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å —Å –∫–ª–∞—Å—Ç–µ—Ä–æ–º —Å –ø—Ä–∞–≤–∞–º–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.

4. **–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ç–µ–≤–æ–≥–æ –ø–ª–∞–≥–∏–Ω–∞ Flannel:**

   - –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Å–µ—Ç–µ–≤–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –º–µ–∂–¥—É –ø–æ–¥–∞–º–∏ –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ.
   - –ó–∞–≤–µ—Ä—à–∞–µ—Ç –±–∞–∑–æ–≤—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É –∫–ª–∞—Å—Ç–µ—Ä–∞, –¥–µ–ª–∞—è –µ–≥–æ –≥–æ—Ç–æ–≤—ã–º –∫ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—é –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —É–∑–ª–æ–≤.

---

### **4. –ù–∞–≥—É–≥–ª–µ–Ω –∏ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω —Ñ–∞–π–ª `./kubernetes-prod/terraform_YC_k8s/upgrade.sh` —Å–∫—Ä–∏–ø—Ç–∞ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω–æ–≥–æ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è Kubernetes-–∫–ª–∞—Å—Ç–µ—Ä–∞ –¥–æ –≤–µ—Ä—Å–∏–∏ v1.31.0, –≤–∫–ª—é—á–∞—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∞—Å—Ç–µ—Ä-–Ω–æ–¥ –∏ –≤–æ—Ä–∫–µ—Ä-–Ω–æ–¥.**

```bash
echo "Start upgrade master"
# –ü–æ–ª—É—á–µ–Ω–∏–µ IP-–∞–¥—Ä–µ—Å–∞ –º–∞—Å—Ç–µ—Ä-–Ω–æ–¥—ã
MASTER_IP=$(terraform output -json | jq  '.master_ip_addr.value' | tr -d '"')
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ SSH-–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥ –Ω–∞ –º–∞—Å—Ç–µ—Ä-–Ω–æ–¥–µ
cat <<  EOF  | ssh -o StrictHostKeyChecking=no ubuntu@$MASTER_IP  'sudo bash'
        # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è Kubernetes –≤–µ—Ä—Å–∏–∏ v1.31
        echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.31/deb/ /' | tee /etc/apt/sources.list.d/kubernetes.list
        # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–∞–∫–µ—Ç–æ–≤
        apt-get update
        # –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–æ–≤ kubeadm –∏ kubectl
        apt-mark unhold kubeadm kubectl
        # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–æ–≤—ã—Ö –≤–µ—Ä—Å–∏–π kubeadm –∏ kubectl
        apt-get install -y kubeadm kubectl
        # –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–æ–≤ kubeadm –∏ kubectl
        apt-mark hold kubeadm kubectl
        # –≠–∫—Å–ø–æ—Ä—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π KUBECONFIG
        export KUBECONFIG=/etc/kubernetes/admin.conf
        # –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è Kubernetes
        kubeadm upgrade plan
        # –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ –≤–µ—Ä—Å–∏–∏ v1.31.0
        echo 'y' | kubeadm upgrade apply v1.31.0
        # –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–∞ kubelet
        apt-mark unhold kubelet 
        # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏ kubelet
        apt-get install -y kubelet
        # –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–∞ kubelet
        apt-mark hold kubelet 
        # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ kubelet
        systemctl daemon-reload
        systemctl restart kubelet
        # –°–æ–∑–¥–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ upgrade-worker.sh –¥–ª—è –≤–æ—Ä–∫–µ—Ä-–Ω–æ–¥
        echo 'echo "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.31/deb/ /" | tee /etc/apt/sources.list.d/kubernetes.list
        apt-get update
        apt-mark unhold kubeadm kubectl kubelet
        apt-get install -y kubeadm kubectl kubelet
        apt-mark hold kubeadm kubectl kubelet
        systemctl daemon-reload
        systemctl restart kubelet' >  upgrade-worker.sh
EOF
# –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–∞—Å—Ç–µ—Ä-–Ω–æ–¥—ã
sleep 60
# –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –≤–æ—Ä–∫–µ—Ä-–Ω–æ–¥ –∏ –∏—Ö IP-–∞–¥—Ä–µ—Å–æ–≤
ssh   -o StrictHostKeyChecking=no ubuntu@$MASTER_IP 'export KUBECONFIG=/etc/kubernetes/admin.conf ; sudo -E kubectl get nodes -o json' | python3 -c "
import json
import sys
data = json.load(sys.stdin)
for i in (data['items']):
   print(i['status']['addresses'][1]['address']+' '+i['status']['addresses'][0]['address'])"  | grep 'worker' | while read a b
 do
    # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–æ—Ä–∫–µ—Ä-–Ω–æ–¥ –≤ —Ü–∏–∫–ª–µ
    echo "Upgrading on $a"
    # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥ –Ω–∞ –º–∞—Å—Ç–µ—Ä-–Ω–æ–¥–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–æ—Ä–∫–µ—Ä-–Ω–æ–¥–æ–π
    cat  << EOF | ssh -A -o StrictHostKeyChecking=no  ubuntu@$MASTER_IP  "bash" 
    # –î—Ä–µ–π–Ω –≤–æ—Ä–∫–µ—Ä-–Ω–æ–¥—ã
    export KUBECONFIG=/etc/kubernetes/admin.conf ; sudo -E kubectl  drain $a --ignore-daemonsets &&
    sleep 10 &&
    # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–æ—Ä–∫–µ—Ä-–Ω–æ–¥—ã
    cat upgrade-worker.sh | ssh -o StrictHostKeyChecking=no  $b 'sudo bash' &&
    sleep 10 &&
    # –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –≤–æ—Ä–∫–µ—Ä-–Ω–æ–¥—ã
    sudo -E kubectl uncordon $a &&
    sleep 10
EOF 
    echo "Upgrade on $a done"
done
```

## **–ò—Ç–æ–≥–æ–≤—ã–π —Ä–∞–±–æ—á–∏–π –ø—Ä–æ—Ü–µ—Å—Å —Å–∫—Ä–∏–ø—Ç–∞**

1. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∞—Å—Ç–µ—Ä-–Ω–æ–¥—ã**:
   - –û–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è Kubernetes –Ω–∞ –º–∞—Å—Ç–µ—Ä-–Ω–æ–¥–µ –¥–æ –≤–µ—Ä—Å–∏–∏ `v1.31.0`.
   - –°–æ–∑–¥–∞–µ—Ç—Å—è —Å–∫—Ä–∏–ø—Ç `upgrade-worker.sh` –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–æ—Ä–∫–µ—Ä-–Ω–æ–¥.

2. **–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –≤–æ—Ä–∫–µ—Ä-–Ω–æ–¥**:
   - –ò–∑–≤–ª–µ–∫–∞—é—Ç—Å—è –∏–º–µ–Ω–∞ –∏ IP-–∞–¥—Ä–µ—Å–∞ –≤–æ—Ä–∫–µ—Ä-–Ω–æ–¥ –∏–∑ –∫–ª–∞—Å—Ç–µ—Ä–∞.

3. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–æ—Ä–∫–µ—Ä-–Ω–æ–¥ –≤ —Ü–∏–∫–ª–µ**:
   - –î–ª—è –∫–∞–∂–¥–æ–π –≤–æ—Ä–∫–µ—Ä-–Ω–æ–¥—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –∫–æ–º–∞–Ω–¥—ã:
     - **–î—Ä–µ–π–Ω —É–∑–ª–∞**: –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –ø–æ–¥–æ–≤ —Å –≤–æ—Ä–∫–µ—Ä-–Ω–æ–¥—ã.
     - **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–∫–µ—Ç–æ–≤ Kubernetes**: –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ `upgrade-worker.sh` –Ω–∞ –≤–æ—Ä–∫–µ—Ä-–Ω–æ–¥–µ.
     - **Uncordon —É–∑–ª–∞**: –í–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ –≤–æ—Ä–∫–µ—Ä-–Ω–æ–¥—ã –≤ –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ.

---

### **5. –ü—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã.**

**5.1** C—Ç–∞—Ç—É—Å –∏ –≤–µ—Ä—Å–∏—è k8s –≤—Å–µ—Ö –Ω–æ–¥ –∫–ª–∞—Å—Ç–µ—Ä–∞ –ø–æ—Å–ª–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è:

```bash
ubuntu@master-0:~$ kubectl get nodes -o wide
NAME       STATUS   ROLES           AGE     VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION      CONTAINER-RUNTIME
master-0   Ready    control-plane   3m39s   v1.30.7   10.115.0.21   <none>        Ubuntu 22.04.3 LTS   5.15.0-91-generic   cri-o://1.28.4
worker0    Ready    <none>          2m29s   v1.30.7   10.115.0.34   <none>        Ubuntu 22.04.3 LTS   5.15.0-91-generic   cri-o://1.28.4
worker1    Ready    <none>          2m21s   v1.30.7   10.115.0.5    <none>        Ubuntu 22.04.3 LTS   5.15.0-91-generic   cri-o://1.28.4
worker2    Ready    <none>          2m12s   v1.30.7   10.115.0.30   <none>        Ubuntu 22.04.3 LTS   5.15.0-91-generic   cri-o://1.28.4
```
**5.2** C—Ç–∞—Ç—É—Å –∏ –≤–µ—Ä—Å–∏—è k8s –≤—Å–µ—Ö –Ω–æ–¥ –∫–ª–∞—Å—Ç–µ—Ä–∞ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:

```bash
ubuntu@master-0:~$ kubectl get nodes -o wide
NAME       STATUS   ROLES           AGE   VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION      CONTAINER-RUNTIME
master-0   Ready    control-plane   24m   v1.31.3   10.115.0.21   <none>        Ubuntu 22.04.3 LTS   5.15.0-91-generic   cri-o://1.28.4
worker0    Ready    <none>          23m   v1.31.3   10.115.0.34   <none>        Ubuntu 22.04.3 LTS   5.15.0-91-generic   cri-o://1.28.4
worker1    Ready    <none>          23m   v1.31.3   10.115.0.5    <none>        Ubuntu 22.04.3 LTS   5.15.0-91-generic   cri-o://1.28.4
worker2    Ready    <none>          23m   v1.31.3   10.115.0.30   <none>        Ubuntu 22.04.3 LTS   5.15.0-91-generic   cri-o://1.28.4
```
---

# HW13 –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∏ –æ—Ç–ª–∞–¥–∫–∞ –≤ Kubernetes.

## –í –ø—Ä–æ—Ü–µ—Å—Å–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –î–ó –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è:

### **1. –ó–∞–ø—É—â–µ–Ω –∫–ª–∞—Å—Ç–µ—Ä minikube –Ω–∞ —Ö–æ—Å—Ç–æ–≤–æ–π –º–∞—à–∏–Ω–µ.**

```bash
minikube start --kubernetes-version=v1.31.0 --driver=virtualbox
üòÑ  minikube v1.34.0 –Ω–∞ Ubuntu 20.04
‚ú®  –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥—Ä–∞–π–≤–µ—Ä virtualbox –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Ñ–∏–≥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
üëç  Starting "minikube" primary control-plane node in "minikube" cluster
üî•  Creating virtualbox VM (CPUs=2, Memory=2200MB, Disk=20000MB) ...
üê≥  –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è Kubernetes v1.31.0 –Ω–∞ Docker 27.2.0 ...
    ‚ñ™ Generating certificates and keys ...
    ‚ñ™ Booting up control plane ...
    ‚ñ™ Configuring RBAC rules ...
üîó  Configuring bridge CNI (Container Networking Interface) ...
üîé  –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã Kubernetes –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è ...
    ‚ñ™ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–±—Ä–∞–∑ gcr.io/k8s-minikube/storage-provisioner:v5
üåü  –í–∫–ª—é—á–µ–Ω–Ω—ã–µ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è: storage-provisioner, default-storageclass

‚ùó  /usr/local/bin/kubectl is version 1.29.1, which may have incompatibilities with Kubernetes 1.31.0.
    ‚ñ™ Want kubectl v1.31.0? Try 'minikube kubectl -- get pods -A'
üèÑ  –ì–æ—Ç–æ–≤–æ! kubectl –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–ª–∞—Å—Ç–µ—Ä–∞ "minikube" –∏ "default" –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ –∏–º—ë–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
```
---

### **2. –°–æ–∑–¥–∞–Ω –º–∞–Ω–∏—Ñ–µ—Å—Ç `./kubernetes-debug/nginx.yaml`, –æ–ø–∏—Å—ã–≤–∞—é—â–∏–π pod —Å `kyos0109/nginx-distroless` –æ–±—Ä–∞–∑–æ–º –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: "nginx-distroless"
  namespace: default
  labels:
    app.kubernetes.io/name: nginx
spec:
  containers:
  - name: nginx-distroless 
    image: kyos0109/nginx-distroless
    resources:
      limits:
        cpu: 100m
        memory: 500Mi
      requests:
        cpu: 100m
        memory: 200Mi
    ports:
    - containerPort: 80
      name: http
    securityContext:
      privileged: true
      capabilities:
        add: ["SYS_PTRACE", "SYS_ADMIN"]
      allowPrivilegeEscalation: true
      seccompProfile:
        type: Unconfined
  restartPolicy: Always
```

–¢–∞–∫ –∂–µ —Å–æ–∑–¥–∞–Ω –º–∞–Ω–∏—Ñ–µ—Å—Ç `./kubernetes-debug/service_nginx.yaml` –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è —Å–µ—Ç–µ–≤–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Ç–µ—Å—Ç–æ–≤–≥–æ Pod

```yaml
apiVersion: v1
kind: Service
metadata:
  name: nginx
spec:
  selector:
    app.kubernetes.io/name: nginx
  ports:
  - name: web
    protocol: TCP
    port: 80
    targetPort: 80
```

–∏ –º–∞–Ω–∏—Ñ–µ—Å—Ç `./kubernetes-debug/curl.yaml` –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–∞–≥—Ä—É–∑–∫–∏ 

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: "curl"
  namespace: default
spec:
  containers:
  - name: curl
    image: curlimages/curl
    command: ["/bin/sh"]
    args: ["-c","while true; do curl http://nginx/; sleep 3; done"]
    resources:
      limits:
        cpu: 100m
        memory: 500Mi
      requests:
        cpu: 100m
        memory: 200Mi
  restartPolicy: Always
```
---

### **3. –ó–∞–ø—É—â–µ–Ω–Ω–∞ –æ–ø–∏—Å–∞–Ω–Ω–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞.**

```bash
kubectl apply -f nginx.yaml 
pod/nginx-distroless created

kubectl apply -f service_nginx.yaml 
service/nginx created

kubectl apply -f curl.yaml 
pod/curl created

kubectl get pod
NAME               READY   STATUS              RESTARTS   AGE
curl               0/1     ContainerCreating   0          9s
nginx-distroless   1/1     Running             0          23s

kubectl get pod
NAME               READY   STATUS    RESTARTS   AGE
curl               1/1     Running   0          26s
nginx-distroless   1/1     Running   0          40s
```

----

### **4. –° –ø–æ–º–æ—â—å—é –∫–æ–º–∞–Ω–¥—ã kubectl debug —Å–æ–∑–¥–∞–π—Ç–µ —ç—Ñ–µ–º–µ—Ä–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –ø–æ–¥–∞.**

```bash 
kubectl debug -it nginx-distroless --image=ubuntu --target=nginx-distroless
Targeting container "nginx-distroless". If you don't see processes from this container it may be because the container runtime doesn't support this feature.
Defaulting debug container name to debugger-w6chs.
If you don't see a command prompt, try pressing enter.

root@nginx-distroless:/# 
```
---

### **5. –í –¥–µ–±–∞–≥ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–∞–∫–µ—Ç—ã –∏ –∑–∞–ø—É—â–µ–Ω–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ tcpdump**

```bash
apt update
apt install -y tcpdump strace
```

```bash
root@nginx-distroless:/# tcpdump -nn -i any -e port 80
tcpdump: data link type LINUX_SLL2
tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
listening on any, link-type LINUX_SLL2 (Linux cooked v2), snapshot length 262144 bytes
06:13:05.759841 eth0  In  ifindex 3 b6:19:c7:a3:ec:41 ethertype IPv4 (0x0800), length 80: 10.244.0.4.36136 > 10.244.0.3.80: Flags [S], seq 3730945754, win 64240, options [mss 1460,sackOK,TS val 29322771 ecr 0,nop,wscale 7], length 0
06:13:05.759884 eth0  Out ifindex 3 26:3c:91:e9:25:51 ethertype IPv4 (0x0800), length 80: 10.244.0.3.80 > 10.244.0.4.36136: Flags [S.], seq 1287817036, ack 3730945755, win 65160, options [mss 1460,sackOK,TS val 1861122678 ecr 29322771,nop,wscale 7], length 0
06:13:05.759975 eth0  In  ifindex 3 b6:19:c7:a3:ec:41 ethertype IPv4 (0x0800), length 72: 10.244.0.4.36136 > 10.244.0.3.80: Flags [.], ack 1, win 502, options [nop,nop,TS val 29322771 ecr 1861122678], length 0
06:13:05.760288 eth0  In  ifindex 3 b6:19:c7:a3:ec:41 ethertype IPv4 (0x0800), length 

...

06:13:08.863029 eth0  In  ifindex 3 b6:19:c7:a3:ec:41 ethertype IPv4 (0x0800), length 72: 10.244.0.4.36154 > 10.244.0.3.80: Flags [F.], seq 70, ack 851, win 501, options [nop,nop,TS val 29325874 ecr 1861125781], length 0
06:13:08.863077 eth0  Out ifindex 3 26:3c:91:e9:25:51 ethertype IPv4 (0x0800), length 72: 10.244.0.3.80 > 10.244.0.4.36154: Flags [F.], seq 851, ack 71, win 509, options [nop,nop,TS val 1861125781 ecr 29325874], length 0
06:13:08.863102 eth0  In  ifindex 3 b6:19:c7:a3:ec:41 ethertype IPv4 (0x0800), length 72: 10.244.0.4.36154 > 10.244.0.3.80: Flags [.], ack 852, win 501, options [nop,nop,TS val 29325874 ecr 1861125781], length 0
^C
24 packets captured
24 packets received by filter
0 packets dropped by kernel
```
---

### **6. –° –ø–æ–º–æ—â—å—é `kubectl debug` —Å–æ–∑–¥–∞–Ω –æ—Ç–ª–∞–¥–æ—á–Ω—ã–π –ø–æ–¥ –¥–ª—è –Ω–æ–¥—ã, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–π –∑–∞–ø—É—â–µ–Ω –ø–æ–¥ —Å distroless nginx –∏ –ø–æ–ª—É—á–µ–Ω –¥–æ—Å—Ç—É–ø –∫ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ –Ω–æ–¥—ã, –∏ –∑–∞—Ç–µ–º –¥–æ—Å—Ç—É–ø –∫ –ª–æ–≥–∞–º –ø–æ–¥–∞ —Å distrolles nginx.**

```bash
kubectl debug node/minikube -it --image=ubuntu
Creating debugging pod node-debugger-minikube-m2hps with container debugger on node minikube.
If you don't see a command prompt, try pressing enter.
root@minikube:/# 
```

```bash
root@minikube:/# cat /host/var/lib/docker/containers/af9027e69d5f8d7111a4d46c82fad31e58f5fec93cb533e27f6e1888a46a7a88/af9027e69d5f8d7111a4d46c82fad31e58f5fec93cb533e27f6e1888a46a7a88-json.log
{"log":"10.244.0.4 - - [01/Dec/2024:13:41:34 +0800] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/8.11.0\" \"-\"\n","stream":"stdout","time":"2024-12-01T05:41:34.051891896Z"}
{"log":"10.244.0.4 - - [01/Dec/2024:13:41:37 +0800] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/8.11.0\" \"-\"\n","stream":"stdout","time":"2024-12-01T05:41:37.068888825Z"}
{"log":"10.244.0.4 - - [01/Dec/2024:13:41:40 +0800] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/8.11.0\" \"-\"\n","stream":"stdout","time":"2024-12-01T05:41:40.151378876Z"}
{"log":"10.244.0.4 - - [01/Dec/2024:13:41:43 +0800] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/8.11.0\" \"-\"\n","stream":"stdout","time":"2024-12-01T05:41:43.253009408Z"}
{"log":"10.244.0.4 - - [01/Dec/2024:13:41:46 +0800] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/8.11.0\" \"-\"\n","stream":"stdout","time":"2024-12-01T05:41:46.4554229Z"}

...

{"log":"10.244.0.4 - - [01/Dec/2024:13:59:00 +0800] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/8.11.0\" \"-\"\n","stream":"stdout","time":"2024-12-01T05:59:00.158234165Z"}
{"log":"10.244.0.4 - - [01/Dec/2024:13:59:03 +0800] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/8.11.0\" \"-\"\n","stream":"stdout","time":"2024-12-01T05:59:03.352100076Z"}
{"log":"10.244.0.4 - - [01/Dec/2024:13:59:06 +0800] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/8.11.0\" \"-\"\n","stream":"stdout","time":"2024-12-01T05:59:06.454069263Z"}
{"log":"10.244.0.4 - - [01/Dec/2024:13:59:09 +0800] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/8.11.0\" \"-\"\n","stream":"stdout","time":"2024-12-01T05:59:09.553745235Z"}
{"log":"10.244.0.4 - - [01/Dec/2024:13:59:12 +0800] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/8.11.0\" \"-\"\n","stream":"stdout","time":"2024-12-01T05:59:12.661940572Z"}
```
---
### P.S. –í —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ –æ—Ç–ª–∞–∂–∏–≤–∞–µ–º–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (kyos0109/nginx-distroless) –∏–∑ —ç—Ñ–µ–º–µ—Ä–Ω–æ–≥–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `/etc/nginx` –Ω–µ—Ç.

```bash
root@nginx-distroless:~#  ls -la /etc   
total 296
drwxr-xr-x 1 root root    4096 Dec  1 07:48 .
drwxr-xr-x 1 root root    4096 Dec  1 07:48 ..
-rw------- 1 root root       0 Oct 16 06:54 .pwd.lock
drwxr-xr-x 2 root root    4096 Oct 16 07:00 alternatives
drwxr-xr-x 8 root root    4096 Oct 16 06:54 apt
-rw-r--r-- 1 root root    2319 Mar 31  2024 bash.bashrc
-rw-r--r-- 1 root root     367 Aug  2  2022 bindresvport.blacklist
drwxr-xr-x 2 root root    4096 Oct 16 07:00 cloud
drwxr-xr-x 2 root root    4096 Oct 16 07:00 cron.d
drwxr-xr-x 2 root root    4096 Oct 16 07:00 cron.daily
-rw-r--r-- 1 root root    2967 Apr 12  2024 debconf.conf
-rw-r--r-- 1 root root      11 Apr 22  2024 debian_version
drwxr-xr-x 2 root root    4096 Oct 16 07:00 default
drwxr-xr-x 4 root root    4096 Oct 16 07:00 dpkg
-rw-r--r-- 1 root root     685 Apr  8  2024 e2scrub.conf
-rw-r--r-- 1 root root     106 Oct 16 06:54 environment
-rw-r--r-- 1 root root      37 Oct 16 06:53 fstab
-rw-r--r-- 1 root root    2584 Jan 31  2024 gai.conf
drwxr-xr-x 2 root root    4096 Oct 16 07:00 gnutls
-rw-r--r-- 1 root root     503 Oct 16 07:00 group
-rw-r--r-- 1 root root     434 Oct 16 06:54 group-
-rw-r----- 1 root shadow   429 Oct 16 07:00 gshadow
-rw-r----- 1 root shadow   364 Oct 16 06:54 gshadow-
-rw-r--r-- 1 root root      92 Apr 22  2024 host.conf
-rw-r--r-- 1 root root      17 Dec  1 07:43 hostname
-rw-r--r-- 1 root root     211 Dec  1 07:48 hosts
drwxr-xr-x 2 root root    4096 Oct 16 07:00 init.d
-rw-r--r-- 1 root root      26 Aug 23 14:20 issue
-rw-r--r-- 1 root root      19 Aug 23 14:20 issue.net
drwxr-xr-x 3 root root    4096 Oct 16 06:54 kernel
-rw-r--r-- 1 root root    5067 Oct 16 07:00 ld.so.cache
-rw-r--r-- 1 root root      34 Aug  2  2022 ld.so.conf
drwxr-xr-x 2 root root    4096 Oct 16 07:00 ld.so.conf.d
-rw-r--r-- 1 root root     267 Apr 22  2024 legal
-rw-r--r-- 1 root root     191 Mar 31  2024 libaudit.conf
-rw-r--r-- 1 root root   12345 Feb 22  2024 login.defs
drwxr-xr-x 2 root root    4096 Oct 16 07:00 logrotate.d
-rw-r--r-- 1 root root     104 Aug 23 14:20 lsb-release
-rw-r--r-- 1 root root       0 Oct 16 07:00 machine-id
-rw-r--r-- 1 root root     744 Apr  8  2024 mke2fs.conf
lrwxrwxrwx 1 root root      12 Dec  1 07:48 mtab -> /proc/mounts
-rw-r--r-- 1 root root      91 Apr 22  2024 networks
-rw-r--r-- 1 root root     494 Aug  2  2022 nsswitch.conf
drwxr-xr-x 2 root root    4096 Oct 16 06:53 opt
lrwxrwxrwx 1 root root      21 Aug 23 14:20 os-release -> ../usr/lib/os-release
-rw-r--r-- 1 root root     552 Oct 13  2022 pam.conf
drwxr-xr-x 2 root root    4096 Oct 16 07:00 pam.d
-rw-r--r-- 1 root root     888 Oct 16 07:00 passwd
-rw-r--r-- 1 root root     839 Oct 16 06:54 passwd-
-rw-r--r-- 1 root root     582 Apr 22  2024 profile
drwxr-xr-x 2 root root    4096 Oct 16 07:00 profile.d
drwxr-xr-x 2 root root    4096 Dec  6  2023 rc0.d
drwxr-xr-x 2 root root    4096 Dec  6  2023 rc1.d
drwxr-xr-x 2 root root    4096 Dec  6  2023 rc2.d
drwxr-xr-x 2 root root    4096 Dec  6  2023 rc3.d
drwxr-xr-x 2 root root    4096 Dec  6  2023 rc4.d
drwxr-xr-x 2 root root    4096 Dec  6  2023 rc5.d
drwxr-xr-x 2 root root    4096 Dec  6  2023 rc6.d
drwxr-xr-x 2 root root    4096 Oct 16 06:54 rcS.d
-rw-r--r-- 1 root root     103 Dec  1 07:43 resolv.conf
lrwxrwxrwx 1 root root      13 Apr  8  2024 rmt -> /usr/sbin/rmt
drwxr-xr-x 4 root root    4096 Oct 16 07:00 security
drwxr-xr-x 2 root root    4096 Oct 16 06:58 selinux
-rw-r----- 1 root shadow   502 Oct 16 07:00 shadow
-rw-r----- 1 root shadow   474 Oct 16 06:54 shadow-
-rw-r--r-- 1 root root     118 Oct 16 06:54 shells
drwxr-xr-x 2 root root    4096 Oct 16 06:54 skel
-rw-r--r-- 1 root root      20 Oct 16 07:00 subgid
-rw-r--r-- 1 root root       0 Oct 16 06:54 subgid-
-rw-r--r-- 1 root root      20 Oct 16 07:00 subuid
-rw-r--r-- 1 root root       0 Oct 16 06:54 subuid-
-rw-r--r-- 1 root root    2209 Mar 24  2024 sysctl.conf
drwxr-xr-x 2 root root    4096 Oct 16 07:00 sysctl.d
drwxr-xr-x 4 root root    4096 Dec  6  2023 systemd
drwxr-xr-x 2 root root    4096 Oct 16 06:59 terminfo
drwxr-xr-x 2 root root    4096 Oct 16 07:00 update-motd.d
-rw-r--r-- 1 root root     681 Apr  8  2024 xattr.conf
```
---

# HW12 –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ CSI –¥—Ä–∞–π–≤–µ—Ä–∞.

## –í –ø—Ä–æ—Ü–µ—Å—Å–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –î–ó –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è:

### **1. –ù–∞–ø–∏—Å–∞–Ω—ã –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã Terraform –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞ Kubernetes –∏ –≤—Å–µ–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—è—é—â–µ–π —É—Å–ª–æ–≤–∏—è–º –î–ó –≤ Yandex Cloud.**

–†–∞–∑–≤–µ—Ä–Ω—É—Ç–∞ —Å–ª–µ–¥—É—é—â–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞:

1. **–†–∞–∑–≤–µ—Ä–Ω—É—Ç `Kubernetes-–∫–ª–∞—Å—Ç–µ—Ä` –≤ Yandex Cloud**

2. **–°–æ–∑–¥–∞–Ω –±–∞–∫–µ—Ç –≤ `Object Storage` Yandex Cloud**

3. **–°–æ–∑–¥–∞–Ω `ServiceAccount` –∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω `–∫–ª—é—á–∏ –¥–æ—Å—Ç—É–ø–∞`**

4. **–°–æ–∑–¥–Ω `Secret` —Å –∫–ª—é—á–∞–º–∏ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ Object Storage**

–§–∞–π–ª `./kubernetes-csi/terraform_YC_k8s/k8s-kltr.tf`

```hcl
# –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ 
resource "yandex_iam_service_account" "otus_sa" {
  name = var.service_account_name
}
# –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ IAM —Ä–æ–ª–µ–π
resource "yandex_resourcemanager_folder_iam_member" "otus_sa_roles" {
  for_each = toset([
    "editor",
    "storage.admin",
    "container-registry.images.puller",
    "container-registry.images.pusher"
  ])

  role      = each.value
  folder_id = var.folder_id
  member    = "serviceAccount:${yandex_iam_service_account.otus_sa.id}"
  depends_on = [yandex_iam_service_account.otus_sa]
}


# –°–æ–∑–¥–∞–Ω–∏–µ Kubernetes-–∫–ª–∞—Å—Ç–µ—Ä–∞
resource "yandex_kubernetes_cluster" "yc_cluster" {
  name                    = var.cluster_name

  master {
    zonal {
      zone      = var.zone
      subnet_id = var.subnet_id
    }
    version               = var.k8s_version
    public_ip             = true
  }

  network_id              = var.network_id

  service_account_id      = var.service_account_id
  node_service_account_id = var.service_account_id

  release_channel         = "RAPID"
  network_policy_provider = "CALICO"

  timeouts {
    create = "30m"
    update = "30m"
  }

  depends_on = [yandex_iam_service_account.otus_sa]
}

# –°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–ø–ø —É–∑–ª–æ–≤ –¥–ª—è —Ä–∞–±–æ—á–∏—Ö –Ω–∞–≥—Ä—É–∑–æ–∫
resource "yandex_kubernetes_node_group" "workload_node_group" {
  cluster_id  = yandex_kubernetes_cluster.yc_cluster.id

  name        = "${var.cluster_name}-workload"
  version     = var.k8s_version
  count       = var.workload_nodes_count

  instance_template {
    platform_id = "standard-v2"

    network_interface {
      nat                = true
      subnet_ids         = [var.subnet_id]
    }

    resources {
      memory = var.node_memory_size
      cores  = var.node_cpu_count
    }

    boot_disk {
      type = "network-ssd"
      size = var.node_disk_size
    }

    scheduling_policy {
      preemptible = false
    }

    # container_runtime {
    #   type = "containerd"
    # }
  }

  scale_policy {
    fixed_scale {
      size = 1
    }
  }
  depends_on = [yandex_kubernetes_cluster.yc_cluster]
  # –°–æ–∑–¥–∞–Ω–∏–µ –º–µ—Ç–∫–∏ –¥–ª—è —É–∑–ª–æ–≤ —ç—Ç–æ–π –≥—Ä—É–ø–ø—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞—Å–∫–∞—Ç–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏
  
  node_labels = {
    worknode = "true"
  }

}
# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ —Å—É—Ñ—Ñ–∏–∫—Å–∞ –¥–ª—è –∏–º–µ–Ω–∏ S3-–±–∞–∫–µ—Ç–∞
resource "random_id" "bucket_suffix" {
  byte_length = 4
}
# –°–æ–∑–¥–∞–Ω–∏–µ S3-–±–∞–∫–µ—Ç–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è 
resource "yandex_storage_bucket" "volume1" {
  access_key = yandex_iam_service_account_static_access_key.s3.access_key
  secret_key = yandex_iam_service_account_static_access_key.s3.secret_key
  bucket        = "volume-${random_id.bucket_suffix.hex}"
  force_destroy = true
  depends_on = [yandex_iam_service_account.otus_sa]
}
# –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∫–ª—é—á–∞ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è S3
resource "yandex_iam_service_account_static_access_key" "s3" {
  service_account_id = yandex_iam_service_account.otus_sa.id
  description        = "S3 access key"
  depends_on = [yandex_iam_service_account.otus_sa]
}
# —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ–∫—Ä–µ—Ç–æ–≤
resource "kubernetes_secret" "csi_s3_secret" {
  metadata {
    name      = "csi-s3-secret"
    namespace = "kube-system"
  }

  data = {
    accessKeyID     = yandex_iam_service_account_static_access_key.s3.access_key
    secretAccessKey = yandex_iam_service_account_static_access_key.s3.secret_key
    endpoint        = "https://storage.yandexcloud.net"
    
  }
  depends_on = [yandex_iam_service_account_static_access_key.s3]
}
# –í—ã—Ö–æ–¥–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è cluster_endpoint –∏ cluster_ca_certificate –∫–ª–∞—Å—Ç–µ—Ä–∞ Kubernetes.
output "cluster_endpoint" {
  value = yandex_kubernetes_cluster.yc_cluster.master.0.external_v4_endpoint
}

output "cluster_ca_certificate" {
  value = yandex_kubernetes_cluster.yc_cluster.master.0.cluster_ca_certificate
}
```
---

### **2. –°–æ–∑–¥–∞–Ω –º–∞–Ω–∏—Ñ–µ—Å—Ç `./kubernetes-csi/manifest/storageClass.yaml` —Å–æ —Å–ª–µ–¥—É—é—â–∏–º —Å–æ–¥–µ—Ä–∂–∏–º—ã–º:**

```yaml
kind: StorageClass
apiVersion: storage.k8s.io/v1
metadata:
  name: homework-csi
provisioner: ru.yandex.s3.csi
parameters:
  mounter: geesefs
  options: "--memory-limit 1000 --dir-mode 0777 --file-mode 0666"
  bucket: volume1
  csi.storage.k8s.io/provisioner-secret-name: csi-s3-secret
  csi.storage.k8s.io/provisioner-secret-namespace: kube-system
  csi.storage.k8s.io/controller-publish-secret-name: csi-s3-secret
  csi.storage.k8s.io/controller-publish-secret-namespace: kube-system
  csi.storage.k8s.io/node-stage-secret-name: csi-s3-secret
  csi.storage.k8s.io/node-stage-secret-namespace: kube-system
  csi.storage.k8s.io/node-publish-secret-name: csi-s3-secret
  csi.storage.k8s.io/node-publish-secret-namespace: kube-system
```
#### –û–ø–∏—Å–∞–Ω–∏–µ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞ StorageClass

–≠—Ç–æ—Ç –º–∞–Ω–∏—Ñ–µ—Å—Ç —Å–æ–∑–¥–∞—ë—Ç **StorageClass** –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º –≤ Kubernetes, –∏—Å–ø–æ–ª—å–∑—É—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä **Yandex Cloud S3** —á–µ—Ä–µ–∑ **CSI (Container Storage Interface)**.

---

#### **–ö–ª—é—á–µ–≤—ã–µ —á–∞—Å—Ç–∏ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞**

1. **kind: StorageClass**
   - –¢–∏–ø —Ä–µ—Å—É—Ä—Å–∞ Kubernetes, –∫–æ—Ç–æ—Ä—ã–π –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫–ª–∞—Å—Å —Ö—Ä–∞–Ω–∏–ª–∏—â–∞. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è PersistentVolume (PV) —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ–º.

2. **apiVersion: storage.k8s.io/v1**
   - –í–µ—Ä—Å–∏—è API –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –æ–±—ä–µ–∫—Ç–æ–º StorageClass.

3. **metadata**
   - **name: homework-csi**: –ò–º—è StorageClass, –∫–æ—Ç–æ—Ä–æ–µ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è —Å—Å—ã–ª–∫–∏ –Ω–∞ —ç—Ç–æ—Ç –∫–ª–∞—Å—Å –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ PersistentVolumeClaim (PVC).

4. **provisioner**
   - **provisioner: ru.yandex.s3.csi**: –£–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ CSI-–¥—Ä–∞–π–≤–µ—Ä –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å S3-—Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º –≤ Yandex Cloud. –≠—Ç–æ—Ç –¥—Ä–∞–π–≤–µ—Ä –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —Å–æ–∑–¥–∞–Ω–∏–µ, –Ω–∞—Å—Ç—Ä–æ–π–∫—É –∏ —É–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–º–æ–≤.

5. **parameters**
   - –°–æ–¥–µ—Ä–∂–∏—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–ª—è S3-—Ö—Ä–∞–Ω–∏–ª–∏—â–∞:
     - **mounter: geesefs**: –£–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ –¥–ª—è –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è S3-—Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —É—Ç–∏–ª–∏—Ç–∞ **geesefs**.
     - **options: "--memory-limit 1000 --dir-mode 0777 --file-mode 0666"**:
       - `--memory-limit 1000`: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ª–∏–º–∏—Ç –ø–∞–º—è—Ç–∏ –¥–ª—è –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
       - `--dir-mode 0777`: –ó–∞–¥–∞—ë—Ç —Ä–µ–∂–∏–º –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è–º.
       - `--file-mode 0666`: –ó–∞–¥–∞—ë—Ç —Ä–µ–∂–∏–º –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª–∞–º.
     - **bucket: volume1**: –ò–º—è S3-–±–∞–∫–µ—Ç–∞ –≤ Yandex Cloud, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö.
     - **csi.storage.k8s.io/...-secret-name**: –£–∫–∞–∑—ã–≤–∞–µ—Ç –∏–º—è —Å–µ–∫—Ä–µ—Ç–∞ Kubernetes –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥—Ä–∞–π–≤–µ—Ä–∞:
       - **csi.storage.k8s.io/provisioner-secret-name**: –î–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –≤—ã–¥–µ–ª–µ–Ω–∏—è —Ç–æ–º–æ–≤.
       - **csi.storage.k8s.io/controller-publish-secret-name**: –î–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–æ–º –∫ —Ç–æ–º–∞–º.
       - **csi.storage.k8s.io/node-stage-secret-name**: –î–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ —É–∑–ª–æ–≤.
       - **csi.storage.k8s.io/node-publish-secret-name**: –î–ª—è –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–º–æ–≤.
     - **csi.storage.k8s.io/...-secret-namespace**: –í—Å–µ —Å–µ–∫—Ä–µ—Ç—ã —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω—ã –≤ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ –∏–º—ë–Ω `kube-system`.

#### **–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç**

1. **CSI-–¥—Ä–∞–π–≤–µ—Ä S3** –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É–µ—Ç —Å Yandex Cloud –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–∞–∫–µ—Ç–∞–º–∏.
2. –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ PVC –¥—Ä–∞–π–≤–µ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —É–∫–∞–∑–∞–Ω–Ω—ã–π –±–∞–∫–µ—Ç `volume1` –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö.
3. –°–µ–∫—Ä–µ—Ç—ã (`csi-s3-secret`) —Å–æ–¥–µ—Ä–∂–∞—Ç —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ S3.
4. –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (`mounter` –∏ `options`) –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç, –∫–∞–∫ S3-—Ç–æ–º –±—É–¥–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ —É–∑–ª–∞–º Kubernetes.

---

#### **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞**

- **–ì–∏–±–∫–æ—Å—Ç—å**: –õ–µ–≥–∫–æ —É–ø—Ä–∞–≤–ª—è—Ç—å —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º —á–µ—Ä–µ–∑ Kubernetes, –Ω–µ —Ç—Ä–µ–±—É—è —Ä—É—á–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–∞–∫–µ—Ç–æ–≤.
- **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–∞ —É–ø—Ä–æ—â–∞–µ—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–æ–º –∫ —Ö—Ä–∞–Ω–∏–ª–∏—â—É.
- **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ CSI-–¥—Ä–∞–π–≤–µ—Ä–∞ –¥–µ–ª–∞–µ—Ç —ç—Ç–æ—Ç –ø–æ–¥—Ö–æ–¥ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–º —Å –¥—Ä—É–≥–∏–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏ Kubernetes.

### **3. –°–æ–∑–¥–∞–Ω –º–∞–Ω–∏—Ñ–µ—Å—Ç `./kubernetes-csi/manifest/pvc.yaml` —Å–æ —Å–ª–µ–¥—É—é—â–∏–º —Å–æ–¥–µ—Ä–∂–∏–º—ã–º:**

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: homework-csi
spec:
  storageClassName: homework-csi
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 2Gi
```
–í –º–∞–Ω–∏—Ñ–µ—Å—Ç–µ PersistentVolumeClaim —É–∫–∞–∑–∞–Ω–∞ —Å—Å—ã–ª–∫–∞ –Ω–∞ —Å–æ–∑–¥–∞–Ω–Ω—ã–π StorageClass.


### **4. –°–æ–∑–¥–∞–Ω –º–∞–Ω–∏—Ñ–µ—Å—Ç `./kubernetes-csi/manifest/s3-test-pod.yaml` —Å–æ —Å–ª–µ–¥—É—é—â–∏–º —Å–æ–¥–µ—Ä–∂–∏–º—ã–º:**

–°–æ–∑–¥–∞—Ç—å Pod, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–π —Å–æ–∑–¥–∞–Ω–Ω—ã–π PVC.

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `s3-test-pod.yaml` —Å–æ —Å–ª–µ–¥—É—é—â–∏–º —Å–æ–¥–µ—Ä–∂–∏–º—ã–º:

```yaml
aapiVersion: v1
kind: Pod
metadata:
  name: s3-test-pod
spec:
  containers:
    - name: app
      image: busybox
      command: ["/bin/sh", "-c", "while true; do echo $(date) >> /mnt/data/log.txt; sleep 5; done"]
      volumeMounts:
        - name: s3-volume
          mountPath: /mnt/data
  volumes:
    - name: s3-volume
      persistentVolumeClaim:
        claimName: homework-csi
```

–°–æ–∑–¥–∞–Ω—ã–π Pod, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã–π PVC.

### **5. –ù–∞–ø–∏—Å–∞–Ω —Å–∫—Ä–∏–ø—Ç `install.sh` –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è —Ç—Ä–µ–±—É–µ–º–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã.**

```bash
# –ü–µ—Ä–µ—Ö–æ–¥ –≤ –∫–∞—Ç–∞–ª–æ–≥ —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Terraform –¥–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
cd terraform_YC_k8s
# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Terraform –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ –∏ –º–æ–¥—É–ª–µ–π –¥–æ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö
terraform init -upgrade
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–ª–∞—Å—Ç–µ—Ä–∞ Kubernetes —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—è—é—â–µ–≥–æ —É—Å–ª–æ–≤–∏—è–º –î–ó –≤ Yandex Cloud (–±–µ–∑ –∑–∞–ø—Ä–æ—Å–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –≤–≤–æ–¥–∞ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
terraform apply -input=false  -compact-warnings -auto-approve
# –ü–æ–ª—É—á–µ–Ω–∏–µ —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö Kubernetes-–∫–ª–∞—Å—Ç–µ—Ä–∞, —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–ª–∞—Å—Ç–µ—Ä –ª–æ–∫–∞–ª—å–Ω–æ
yc k8s cluster get-credentials --id $(yc k8s cluster list  | grep 'RUNNING' | awk -F '|' '{print $2}')  --external --force
# –î–æ–±–∞–≤–ª—è–µ–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è Helm charts –¥–ª—è CSI-–¥—Ä–∞–π–≤–µ—Ä–∞ Yandex S3 —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º URL
helm repo add yandex-s3 https://yandex-cloud.github.io/k8s-csi-s3/charts
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ CSI-–¥—Ä–∞–π–≤–µ—Ä Yandex S3 –≤ Kubernetes-–∫–ª–∞—Å—Ç–µ—Ä, –∏—Å–ø–æ–ª—å–∑—É—è Helm. –†–µ–ª–∏–∑ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è csi-s3.
helm install csi-s3 yandex-s3/csi-s3
# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞ storageClass.yaml, –∫–æ—Ç–æ—Ä—ã–π –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç StorageClass –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è PersistentVolume –Ω–∞ –æ—Å–Ω–æ–≤–µ Yandex S3
cd .. && kubectl apply -f manifest/storageClass.yaml
# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞ pvc.yaml, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–∑–¥–∞–µ—Ç PersistentVolumeClaim, –∑–∞–ø—Ä–∞—à–∏–≤–∞—è —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Å–æ–≥–ª–∞—Å–Ω–æ —Ä–∞–Ω–µ–µ —Å–æ–∑–¥–∞–Ω–Ω–æ–º—É StorageClass
kubectl apply -f  manifest/pvc.yaml
# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞ s3-test-pod.yaml, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∏–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–æ–º –∏–∑ Yandex S3
kubectl apply -f  manifest/s3-test-pod.yaml
```
---

### **6. –ü—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã.**

**6.1** –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ–≥–æ `S3` —Ö—Ä–∞–Ω–∏–ª–∏—â–∞:

```bash
yc storage bucket list
+-----------------+----------------------+----------+-----------------------+---------------------+
|      NAME       |      FOLDER ID       | MAX SIZE | DEFAULT STORAGE CLASS |     CREATED AT      |
+-----------------+----------------------+----------+-----------------------+---------------------+
| volume-7f41354b | b1ghhcttrug793gc11tt |        0 | STANDARD              | 2024-11-25 21:30:13 |
| volume1         | b1ghhcttrug793gc11tt |        0 | STANDARD              | 2024-11-25 21:41:43 |
+-----------------+----------------------+----------+-----------------------+---------------------+
```
**6.2** –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ–≥–æ `PVC` :

```bash
kubectl get pvc
NAME           STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
homework-csi   Bound    pvc-b559e478-ee81-4a05-ac2d-aa39a2262042   2Gi        RWO            homework-csi   17m
```

**6.3** –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª `log.txt` –∏–∑ `S3` —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ —á–µ—Ä–µ–∑ UI YC, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ:

```
Mon Nov 25 21:42:04 UTC 2024
Mon Nov 25 21:42:09 UTC 2024
Mon Nov 25 21:42:14 UTC 2024
Mon Nov 25 21:42:19 UTC 2024

...

Mon Nov 25 21:54:05 UTC 2024
Mon Nov 25 21:54:10 UTC 2024
```
–í–∏–¥–∏–º, —á—Ç–æ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥ –≤ —Ñ–∞–π–ª /mnt/data/log.txt –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è —Ç–µ–∫—É—â–∞—è –¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è.


# HW11 –•—Ä–∞–Ω–∏–ª–∏—â–µ —Å–µ–∫—Ä–µ—Ç–æ–≤ –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. Vault.

## –í –ø—Ä–æ—Ü–µ—Å—Å–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –î–ó –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è:

### **1. –ù–∞–ø–∏—Å–∞–Ω—ã –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã `Terraform` –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞ Kubernetes —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—è—é—â–µ–≥–æ —É—Å–ª–æ–≤–∏—è–º –î–ó –≤ `Yandex Cloud`.**

–°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª `./kubernetes-vault/terraform_YC_k8s/k8s-kltr.tf` —Å–æ —Å–ª–µ–¥—É—é—â–∏–º —Å–æ–¥–µ—Ä–∂–∏–º—ã–º:

```
# –°–æ–∑–¥–∞–Ω–∏–µ Kubernetes-–∫–ª–∞—Å—Ç–µ—Ä–∞

resource "yandex_kubernetes_cluster" "yc_cluster" {
  name                    = var.cluster_name

  master {
    zonal {
      zone      = var.zone
      subnet_id = var.subnet_id
    }
    version               = var.k8s_version
    public_ip             = true
  }

  network_id              = var.network_id

  service_account_id      = var.service_account_id
  node_service_account_id = var.service_account_id

  release_channel         = "RAPID"
  network_policy_provider = "CALICO"
}

# –°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–ø–ø —É–∑–ª–æ–≤ –¥–ª—è —Ä–∞–±–æ—á–∏—Ö –Ω–∞–≥—Ä—É–∑–æ–∫
resource "yandex_kubernetes_node_group" "workload_node_group" {
  cluster_id  = yandex_kubernetes_cluster.yc_cluster.id

  name        = "${var.cluster_name}-workload"
  version     = var.k8s_version
  count       = var.workload_nodes_count

  instance_template {
    platform_id = "standard-v2"

    network_interface {
      nat                = true
      subnet_ids         = [var.subnet_id]
    }

    resources {
      memory = var.node_memory_size
      cores  = var.node_cpu_count
    }

    boot_disk {
      type = "network-ssd"
      size = var.node_disk_size
    }

    scheduling_policy {
      preemptible = false
    }

    container_runtime {
      type = "containerd"
    }
  }

  scale_policy {
    fixed_scale {
      size = 1
    }
  }
  
  # —Å–æ–∑–¥–∞–Ω–∞ –º–µ—Ç–∫–∞ –¥–ª—è —É–∑–ª–æ–≤ —ç—Ç–æ–π –≥—Ä—É–ø–ø—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞—Å–∫–∞—Ç–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏
  
  node_labels = {
    worknode = "true"
  }
  
}
```
---

### **2. –ü—Ä–∏ –ø–æ–º–æ—â–∏ —Ñ–∞–π–ª–∞ `values.yaml` (—á–∞—Ä—Ç–∞ `Consul`) —Å–∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ `Consul` –≤ –æ–¥–Ω–æ–∏–º–µ–Ω–Ω—ã–π namespase.**

**–£—Å—Ç–∞–Ω–æ–≤–∫–∞ Consul –≤ namespace `consul` —Å 3 —Ä–µ–ø–ª–∏–∫–∞–º–∏ —Å–µ—Ä–≤–µ—Ä–∞**

–°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª —á–∞—Ä—Ç–∞ `./kubernetes-vault/consul/helmfile.yaml` —Å–æ —Å–ª–µ–¥—É—é—â–∏–º —Å–æ–¥–µ—Ä–∂–∏–º—ã–º:

```yaml
---
repositories:
- name: hashicorp
  url: https://helm.releases.hashicorp.com

releases:
- name: consul
  namespace: consul
  chart: hashicorp/consul
  values: 
  - values.yaml
```


–°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö `./kubernetes-vault/consul/values.yaml` —Å–æ —Å–ª–µ–¥—É—é—â–∏–º —Å–æ–¥–µ—Ä–∂–∏–º—ã–º:

```yaml
global:
  name: consul
  image: "dockerhub.timeweb.cloud/hashicorp/consul"
  imageK8S: "dockerhub.timeweb.cloud/hashicorp/consul-k8s-control-plane"
server:
  replicas: 3
```

**Consul** ‚Äî —ç—Ç–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å –æ—Ç–∫—Ä—ã—Ç—ã–º –∏—Å—Ö–æ–¥–Ω—ã–º –∫–æ–¥–æ–º, —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π –∫–æ–º–ø–∞–Ω–∏–µ–π HashiCorp, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—É—é, –≤—ã—Å–æ–∫–æ–¥–æ—Å—Ç—É–ø–Ω—É—é —Å–∏—Å—Ç–µ–º—É –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤, —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π –∏ —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏–∏ —Å–µ—Ç–∏. –û–Ω –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è —Å–ª–æ–∂–Ω–æ—Å—Ç–µ–π —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–±–ª–∞—á–Ω—ã—Ö –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ –∫–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:

1. **–û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤**: Consul –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–µ—Ä–≤–∏—Å–∞–º —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –∏ –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞—Ç—å –¥—Ä—É–≥–∏–µ —Å–µ—Ä–≤–∏—Å—ã —Å –ø–æ–º–æ—â—å—é DNS –∏–ª–∏ HTTP –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤. –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫—É—é —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∂–µ—Å—Ç–∫–æ –∑–∞–¥–∞–≤–∞—Ç—å IP-–∞–¥—Ä–µ—Å–∞.

2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏**: –û–Ω –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è –≤ –∏—Ö –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç–µ. –ï—Å–ª–∏ —Å–µ—Ä–≤–∏—Å –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç –ø—Ä–æ–≤–µ—Ä–∫—É, Consul –º–æ–∂–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª–∏—Ç—å –µ–≥–æ –∏–∑ —Ä–µ–µ—Å—Ç—Ä–∞, –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—è –æ—Ç–ø—Ä–∞–≤–∫—É —Ç—Ä–∞—Ñ–∏–∫–∞ –Ω–∞ –Ω–µ–∏—Å–ø—Ä–∞–≤–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã.

3. **–•—Ä–∞–Ω–∏–ª–∏—â–µ –∫–ª—é—á/–∑–Ω–∞—á–µ–Ω–∏–µ**: Consul –≤–∫–ª—é—á–∞–µ—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –∫–ª—é—á/–∑–Ω–∞—á–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, —Ñ–ª–∞–≥–æ–≤ —Ñ—É–Ω–∫—Ü–∏–π –∏–ª–∏ –ª—é–±—ã—Ö –¥—Ä—É–≥–∏—Ö –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤, –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º –≤–æ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.

4. **–ú–Ω–æ–≥–æ–¥–∞—Ç–∞—Ü–µ–Ω—Ç—Ä–æ–≤–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ**: Consul —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –¥–∞—Ç–∞—Ü–µ–Ω—Ç—Ä–∞—Ö, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—è –µ–¥–∏–Ω–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤.

5. **–°–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤**: –° –ø–æ–º–æ—â—å—é –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π —Å–µ—Ä–≤–∏—Å–Ω–æ–π —Å–µ—Ç–∫–∏ (service mesh), Consul –º–æ–∂–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω—ã–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ–º –º–µ–∂–¥—É —Å–µ—Ä–≤–∏—Å–∞–º–∏, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—è —Ñ—É–Ω–∫—Ü–∏–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º mTLS.

–í –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ —Ç–µ–∫—É—â–µ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è Kubernetes:

- **–ë—ç–∫–µ–Ω–¥ –≤—ã—Å–æ–∫–æ–π –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –¥–ª—è Vault**: Vault ‚Äî —ç—Ç–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–µ–∫—Ä–µ—Ç–∞–º –∏ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º –¥–∞–Ω–Ω—ã–º. –ü—Ä–∏ —Ä–∞–±–æ—Ç–µ Vault –≤ —Ä–µ–∂–∏–º–µ –≤—ã—Å–æ–∫–æ–π –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ (HA) —Ç—Ä–µ–±—É–µ—Ç—Å—è —Ö—Ä–∞–Ω–∏–ª–∏—â–µ, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–µ–µ –≤—ã–±–æ—Ä –ª–∏–¥–µ—Ä–∞ –∏ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö. Consul —Å–ª—É–∂–∏—Ç —Ç–∞–∫–∏–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—è –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è –≤—ã—Å–æ–∫–æ–π –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Vault –∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ–π —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É —É–∑–ª–∞–º–∏.

- **–ö–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤**: Consul –ø–æ–º–æ–≥–∞–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã –≤–Ω—É—Ç—Ä–∏ –≤–∞—à–µ–≥–æ –∫–ª–∞—Å—Ç–µ—Ä–∞ Kubernetes. –ë–ª–∞–≥–æ–¥–∞—Ä—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—é —Å–µ—Ä–≤–∏—Å–æ–≤ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞–º –∏—Ö —Å–æ—Å—Ç–æ—è–Ω–∏—è, –æ–Ω –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –Ω–∞–¥–µ–∂–Ω–æ–µ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –º–µ–∂–¥—É –Ω–∏–º–∏.

- **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è**: –° –ø–æ–º–æ—â—å—é —Å–≤–æ–µ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –∫–ª—é—á/–∑–Ω–∞—á–µ–Ω–∏–µ, Consul –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ —É–ø—Ä–∞–≤–ª—è—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è –º–æ–≥—É—Ç –ø–æ–ª—É—á–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–æ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤.

- **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å**: –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Consul –ø–æ–∑–≤–æ–ª—è–µ—Ç –µ–º—É –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤–º–µ—Å—Ç–µ —Å –≤–∞—à–µ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π. –ï–≥–æ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç–∞—Ç—å –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —É–∑–ª–∞—Ö –∏ –¥–∞—Ç–∞—Ü–µ–Ω—Ç—Ä–∞—Ö –ø–æ–≤—ã—à–∞–µ—Ç –æ–±—â—É—é –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å –∏ —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –≤–∞—à–µ–π —Å–∏—Å—Ç–µ–º—ã.

---

### **3. –ü—Ä–∏ –ø–æ–º–æ—â–∏ —Ñ–∞–π–ª–∞ `values.yaml` (—á–∞—Ä—Ç–∞ `Vault`) —Å–∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ `Vault` –≤ –æ–¥–Ω–æ–∏–º–µ–Ω–Ω—ã–π namespase.**

**–£—Å—Ç–∞–Ω–æ–≤–∫–∞ Vault –≤ namespace `vault` —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Consul –≤ —Ä–µ–∂–∏–º–µ HA**

–°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª —á–∞—Ä—Ç–∞ `./kubernetes-vault/vault/helmfile.yaml` —Å–æ —Å–ª–µ–¥—É—é—â–∏–º —Å–æ–¥–µ—Ä–∂–∏–º—ã–º:

```yaml
---
repositories:
- name: hashicorp
  url: https://helm.releases.hashicorp.com

releases:
- name: vault
  namespace: vault
  chart: hashicorp/vault
  values: 
  - values.yaml
```


–°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö `./kubernetes-vault/vault/values.yaml` —Å–æ —Å–ª–µ–¥—É—é—â–∏–º —Å–æ–¥–µ—Ä–∂–∏–º—ã–º:

```yaml
injector:
  image:
    repository: "dockerhub.timeweb.cloud/hashicorp/vault-k8s"
  agentImage:
    repository: "dockerhub.timeweb.cloud/hashicorp/vault"
csi:
  image:
    repository: "dockerhub.timeweb.cloud/hashicorp/vault-csi-provider"
agent:
  image:
    repository: "dockerhub.timeweb.cloud/hashicorp/vault"
server:
   image:
     repository: "dockerhub.timeweb.cloud/hashicorp/vault" 
   ha:
    enabled: true
    replicas: 3
    config: |
      ui = true

      listener "tcp" {
        tls_disable = 1
        address = "[::]:8200"
      }
      storage "consul" {
        path = "vault"
        address = "consul-server.consul:8500"
      }

      service_registration "kubernetes" {}
```

–î–∞–Ω–Ω—ã–π —Ñ–∞–π–ª `values.yaml` –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ HashiCorp Vault —Å –ø–æ–º–æ—â—å—é Helm-—á–∞—Ä—Ç–∞ –≤ Kubernetes. –í –Ω–µ–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ Vault, —Ç–∞–∫–∏—Ö –∫–∞–∫ —Å–µ—Ä–≤–µ—Ä, –∞–≥–µ–Ω—Ç, –∏–Ω–∂–µ–∫—Ç–æ—Ä –∏ CSI-–ø—Ä–æ–≤–∞–π–¥–µ—Ä. –ù–∏–∂–µ –ø–æ–¥—Ä–æ–±–Ω–æ –æ–ø–∏—Å–∞–Ω –∫–∞–∂–¥—ã–π —Ä–∞–∑–¥–µ–ª —Ñ–∞–π–ª–∞:

---

#### **1. –ò–Ω–∂–µ–∫—Ç–æ—Ä (injector):**

```yaml
injector:
  image:
    repository: "dockerhub.timeweb.cloud/hashicorp/vault-k8s"
  agentImage:
    repository: "dockerhub.timeweb.cloud/hashicorp/vault"
```

**–û–ø–∏—Å–∞–Ω–∏–µ:**

- **injector.image.repository**: –£–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π Docker-–æ–±—Ä–∞–∑–∞ –¥–ª—è –∏–Ω–∂–µ–∫—Ç–æ—Ä–∞ Vault Kubernetes. –í –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π `dockerhub.timeweb.cloud/hashicorp/vault-k8s`.
  
- **injector.agentImage.repository**: –£–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π Docker-–æ–±—Ä–∞–∑–∞ –¥–ª—è –∞–≥–µ–Ω—Ç–∞ Vault, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏–Ω–∂–µ–∫—Ç–æ—Ä–æ–º. –ó–¥–µ—Å—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–±—Ä–∞–∑ `dockerhub.timeweb.cloud/hashicorp/vault`.

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**

–ò–Ω–∂–µ–∫—Ç–æ—Ä Vault Kubernetes –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–Ω–µ–¥—Ä—è–µ—Ç —Å–µ–∫—Ä–µ—Ç—ã –∏–∑ Vault –≤ –ø–æ–¥—ã Kubernetes –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–¥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π. –≠—Ç–æ –æ–±–ª–µ–≥—á–∞–µ—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–∞–º–∏ –∏ –ø–æ–≤—ã—à–∞–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π.

---

#### **2. CSI-–ø—Ä–æ–≤–∞–π–¥–µ—Ä (csi):**

```yaml
csi:
  image:
    repository: "dockerhub.timeweb.cloud/hashicorp/vault-csi-provider"
```

**–û–ø–∏—Å–∞–Ω–∏–µ:**

- **csi.image.repository**: –£–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π Docker-–æ–±—Ä–∞–∑–∞ –¥–ª—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ Vault CSI. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–±—Ä–∞–∑ `dockerhub.timeweb.cloud/hashicorp/vault-csi-provider`.

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**

Vault CSI-–ø—Ä–æ–≤–∞–π–¥–µ—Ä –ø–æ–∑–≤–æ–ª—è–µ—Ç Kubernetes –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–µ–∫—Ä–µ—Ç—ã –∏–∑ Vault –≤ –∫–∞—á–µ—Å—Ç–≤–µ —Ç–æ–º–æ–≤ —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å Container Storage Interface (CSI). –≠—Ç–æ –¥–∞–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º –º–æ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–µ–∫—Ä–µ—Ç—ã –∫–∞–∫ —Ñ–∞–π–ª—ã –∏–ª–∏ —Ç–æ–º–∞, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—è –±–æ–ª–µ–µ –≥–∏–±–∫–æ–µ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏.

---

#### **3. –ê–≥–µ–Ω—Ç (agent):**

```yaml
agent:
  image:
    repository: "dockerhub.timeweb.cloud/hashicorp/vault"
```

**–û–ø–∏—Å–∞–Ω–∏–µ:**

- **agent.image.repository**: –£–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π Docker-–æ–±—Ä–∞–∑–∞ –¥–ª—è –∞–≥–µ–Ω—Ç–∞ Vault. –û–±—Ä–∞–∑ –±–µ—Ä–µ—Ç—Å—è –∏–∑ `dockerhub.timeweb.cloud/hashicorp/vault`.

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**

–ê–≥–µ–Ω—Ç Vault —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –ø–æ–¥–∞—Ö –∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–æ–≤, –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –∏–∑ Vault. –û–Ω –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É–µ—Ç —Å –∏–Ω–∂–µ–∫—Ç–æ—Ä–æ–º –∏ –ø–æ–º–æ–≥–∞–µ—Ç –º–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ —Å–µ—Ä–≤–µ—Ä—É Vault, –ø–æ–≤—ã—à–∞—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å.

---

#### **4. –°–µ—Ä–≤–µ—Ä (server):**

```yaml
server:
   image:
     repository: "dockerhub.timeweb.cloud/hashicorp/vault" 
   ha:
    enabled: true
    replicas: 3
    config: |
      ui = true

      listener "tcp" {
        tls_disable = 1
        address = "[::]:8200"
      }
      storage "consul" {
        path = "vault"
        address = "consul-server.consul:8500"
      }

      service_registration "kubernetes" {}
```

**–û–ø–∏—Å–∞–Ω–∏–µ:**

- **server.image.repository**: –£–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π Docker-–æ–±—Ä–∞–∑–∞ –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞ Vault. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–±—Ä–∞–∑ `dockerhub.timeweb.cloud/hashicorp/vault`.

- **ha.enabled**: –í–∫–ª—é—á–∞–µ—Ç —Ä–µ–∂–∏–º –≤—ã—Å–æ–∫–æ–π –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ (High Availability) –¥–ª—è Vault. –ó–Ω–∞—á–µ–Ω–∏–µ `true` –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ HA-—Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω.

- **ha.replicas**: –£–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–ø–ª–∏–∫ —Å–µ—Ä–≤–µ—Ä–∞ Vault –≤ HA-—Ä–µ–∂–∏–º–µ. –ó–¥–µ—Å—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ 3 —Ä–µ–ø–ª–∏–∫–∏ –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏ –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏.

- **ha.config**: –°–æ–¥–µ—Ä–∂–∏—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Å–µ—Ä–≤–µ—Ä–∞ Vault. –í–æ—Ç —á—Ç–æ –≤—Ö–æ–¥–∏—Ç –≤ —ç—Ç—É –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é:

  - **ui = true**: –ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å Vault, –ø–æ–∑–≤–æ–ª—è—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º —É–ø—Ä–∞–≤–ª—è—Ç—å —Å–µ–∫—Ä–µ—Ç–∞–º–∏ —á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä.

  - **listener "tcp" { ... }**: –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç —Å–µ—Ç–µ–≤–æ–π —Å–ª—É—à–∞—Ç–µ–ª—å Vault.
    - **tls_disable = 1**: –û—Ç–∫–ª—é—á–∞–µ—Ç TLS-—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ. –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –±—É–¥—É—Ç –Ω–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–º–∏. *–í–∞–∂–Ω–æ*: –í –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–æ–π —Å—Ä–µ–¥–µ TLS –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∫–ª—é—á–µ–Ω –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.
    - **address = "[::]:8200"**: –£–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ Vault –±—É–¥–µ—Ç —Å–ª—É—à–∞—Ç—å –Ω–∞ –ø–æ—Ä—Ç—É 8200 –Ω–∞ –≤—Å–µ—Ö —Å–µ—Ç–µ–≤—ã—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞—Ö (IPv4 –∏ IPv6).

  - **storage "consul" { ... }**: –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç Consul –≤ –∫–∞—á–µ—Å—Ç–≤–µ –±—ç–∫–µ–Ω–¥–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–ª—è Vault.
    - **path = "vault"**: –£–∫–∞–∑—ã–≤–∞–µ—Ç –ø—É—Ç—å –≤ Consul, –≥–¥–µ Vault –±—É–¥–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ.
    - **address = "consul-server.consul:8500"**: –£–∫–∞–∑—ã–≤–∞–µ—Ç –∞–¥—Ä–µ—Å Consul-—Å–µ—Ä–≤–µ—Ä–∞. –í –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ —ç—Ç–æ —Å–µ—Ä–≤–∏—Å `consul-server` –≤ namespace `consul` –Ω–∞ –ø–æ—Ä—Ç—É 8500.

  - **service_registration "kubernetes" {}**: –í–∫–ª—é—á–∞–µ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é —Å–µ—Ä–≤–∏—Å–∞ Vault –≤ Kubernetes. –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç Vault –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å —Å Kubernetes API –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤ –∏ —É–ø—Ä–æ—â–µ–Ω–∏—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏.

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**

–≠—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç —Å–µ—Ä–≤–µ—Ä–Ω—É—é —á–∞—Å—Ç—å Vault –¥–ª—è —Ä–∞–±–æ—Ç—ã –≤ —Ä–µ–∂–∏–º–µ –≤—ã—Å–æ–∫–æ–π –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Consul –≤ –∫–∞—á–µ—Å—Ç–≤–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –¥–∞–Ω–Ω—ã—Ö. –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –Ω–∞–¥–µ–∂–Ω–æ–µ –∏ —É—Å—Ç–æ–π—á–∏–≤–æ–µ –∫ —Å–±–æ—è–º —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–æ–≤ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–ª–∞—Å—Ç–µ—Ä–∞ Vault.

---

#### **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ—è—Å–Ω–µ–Ω–∏—è:**

- **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –æ–±—Ä–∞–∑–æ–≤:**

  –í—Å–µ –æ–±—Ä–∞–∑—ã Docker –±–µ—Ä—É—Ç—Å—è –∏–∑ —á–∞—Å—Ç–Ω–æ–≥–æ —Ä–µ–µ—Å—Ç—Ä–∞ `dockerhub.timeweb.cloud/hashicorp/`. –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—Ä–∞–∑–æ–≤, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –ø–æ–ª–∏—Ç–∏–∫–∞–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∫–æ–º–ø–∞–Ω–∏–∏ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –≤–µ—Ä—Å–∏–π –æ–±—Ä–∞–∑–æ–≤.

- **–û—Ç–∫–ª—é—á–µ–Ω–∏–µ TLS:**

  –í –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–ª—É—à–∞—Ç–µ–ª—è TLS –æ—Ç–∫–ª—é—á–µ–Ω (`tls_disable = 1`). –≠—Ç–æ —É–ø—Ä–æ—â–∞–µ—Ç –Ω–∞—á–∞–ª—å–Ω—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, –Ω–æ –Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–æ–π —Å—Ä–µ–¥—ã –∏–∑-–∑–∞ —Ä–∏—Å–∫–æ–≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. –í —Ä–µ–∞–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö —Å–ª–µ–¥—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å TLS –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è —Ç—Ä–∞—Ñ–∏–∫–∞ –º–µ–∂–¥—É –∫–ª–∏–µ–Ω—Ç–∞–º–∏ –∏ —Å–µ—Ä–≤–µ—Ä–æ–º Vault.

- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Consul –≤ –∫–∞—á–µ—Å—Ç–≤–µ –±—ç–∫–µ–Ω–¥–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è:**

  Consul –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–µ, —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ, –∫–æ—Ç–æ—Ä–æ–µ Vault –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏ –º–µ–∂–¥—É —Ä–µ–ø–ª–∏–∫–∞–º–∏ –≤ —Ä–µ–∂–∏–º–µ –≤—ã—Å–æ–∫–æ–π –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏. –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ–±–µ—Å–ø–µ—á–∏—Ç—å –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω—É—é —Ä–∞–±–æ—Ç—É Vault –¥–∞–∂–µ –ø—Ä–∏ —Å–±–æ–µ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —É–∑–ª–æ–≤.

- **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–∞ –≤ Kubernetes:**

  –°–µ–∫—Ü–∏—è `service_registration "kubernetes" {}` –ø–æ–∑–≤–æ–ª—è–µ—Ç Vault –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–µ–±—è –≤ Kubernetes. –≠—Ç–æ —É–ø—Ä–æ—â–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å—ã –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, –∞ —Ç–∞–∫–∂–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç –¥—Ä—É–≥–∏–º —Å–µ—Ä–≤–∏—Å–∞–º –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ –Ω–∞—Ö–æ–¥–∏—Ç—å Vault —á–µ—Ä–µ–∑ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã Kubernetes.

---

#### **–ò—Ç–æ–≥–æ–≤–æ–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ `values.yaml`:**

- **–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç Vault –≤ —Ä–µ–∂–∏–º–µ –≤—ã—Å–æ–∫–æ–π –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å 3 —Ä–µ–ø–ª–∏–∫–∞–º–∏.**
- **–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Consul –≤ –∫–∞—á–µ—Å—Ç–≤–µ –±—ç–∫–µ–Ω–¥–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏ –∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö.**
- **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ—Ç –∏–Ω–∂–µ–∫—Ç–æ—Ä –∏ –∞–≥–µ–Ω—Ç Vault –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è —Å–µ–∫—Ä–µ—Ç–æ–≤ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Kubernetes.**
- **–í–∫–ª—é—á–∞–µ—Ç –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å Vault –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è.**
- **–ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –æ–±—Ä–∞–∑—ã Docker –∏–∑ —á–∞—Å—Ç–Ω–æ–≥–æ —Ä–µ–µ—Å—Ç—Ä–∞.**

---

**–≠—Ç–æ—Ç —Ñ–∞–π–ª `values.yaml` –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å Vault –≤ Kubernetes —Å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—è –ø—Ä–∏ —ç—Ç–æ–º –æ—Å–Ω–æ–≤—ã –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—É—é —Å—Ä–µ–¥—É —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏.**

---
### **4. –°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª  `./skyfly535_repo/kubernetes-vault/external-secrets-operator/helmfile.yaml` –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ (—á–∞—Ä—Ç–∞ `external-secrets`) `external-secrets` –≤ namespase `Vault`.**

```yaml
---
repositories:
- name: external-secrets
  url: https://charts.external-secrets.io

releases:
- name: external-secrets
  namespace: vault
  chart: external-secrets/external-secrets
```

 `External Secret Operator` ‚Äî —ç—Ç–æ, –ø–æ —Å—É—Ç–∏, `–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä Kubernetes`, –∫–æ—Ç–æ—Ä—ã–π —É–ø—Ä–∞–≤–ª—è–µ—Ç —Å–µ–∫—Ä–µ—Ç–∞–º–∏, —Ö—Ä–∞–Ω—è—â–∏–º–∏—Å—è –∑–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ `HashiCorp Vault` –∏–ª–∏ –æ–±–ª–∞—á–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ–∫—Ä–µ—Ç–∞–º–∏, —Ç–∞–∫–æ–π –∫–∞–∫ AWS Secrets Manager. –ö–æ–≥–¥–∞ –º–æ–¥—É–ª—é —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–æ—Å—Ç—É–ø –∫ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–º—É —Å–µ–∫—Ä–µ—Ç—É, –≤–Ω–µ—à–Ω–∏–π –æ–ø–µ—Ä–∞—Ç–æ—Ä —Å–µ–∫—Ä–µ—Ç–æ–≤ –∏–∑–≤–ª–µ–∫–∞–µ—Ç –µ–≥–æ –∏–∑ –≤–Ω–µ—à–Ω–µ–π —Å–∏—Å—Ç–µ–º—ã –∏ –¥–µ–ª–∞–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã–º –¥–ª—è –º–æ–¥—É–ª—è –≤ –∫–∞—á–µ—Å—Ç–≤–µ —Å–µ–∫—Ä–µ—Ç–∞ Kubernetes.

External Secret Operator —Ä–∞–±–æ—Ç–∞–µ—Ç, —Å–æ–∑–¥–∞–≤–∞—è —Ç—Ä–∏ `custom resource definitions (CRDs)`: ClusterSecretStore, SecretStore –∏ ExternalSecret.

CRD ClusterSecretStore –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –≤–Ω–µ—à–Ω–µ–º—É —Ö—Ä–∞–Ω–∏–ª–∏—â—É —Å–µ–∫—Ä–µ—Ç–æ–≤, —Ç–∞–∫–∏—Ö –∫–∞–∫ –∫–æ–Ω–µ—á–Ω–∞—è —Ç–æ—á–∫–∞, –¥–∞–Ω–Ω—ã–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ –¥—Ä—É–≥–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏. CRD SecretStore –ø–æ—Ö–æ–∂ –Ω–∞ —Ä–µ—Å—É—Ä—Å ClusterSecretStore, –Ω–æ –∏–º–µ–µ—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –∏–º—ë–Ω. CRD ExternalSecret –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ–∫—Ä–µ—Ç–æ–≤ Kubernetes –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–º–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏, –∑–∞–¥–∞–Ω–Ω–æ–π –≤ CRD ClusterSecretStore –∏–ª–∏ CRD SecretStore.

External Secret Operator –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ä–µ—Å—É—Ä—Å–∞—Ö ExternalSecret –∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç —Å–µ–∫—Ä–µ—Ç—ã Kubernetes, –∑–∞–ø–æ–ª–Ω—è—è –∏—Ö –ø–æ–ª—É—á–µ–Ω–Ω—ã–º–∏ —Å–µ–∫—Ä–µ—Ç–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏. –¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, —Å–µ–∫—Ä–µ—Ç—ã –æ—Å—Ç–∞—é—Ç—Å—è –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ –º–æ–≥—É—Ç —Ä–µ–≥—É–ª—è—Ä–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è –±–µ–∑ —É—â–µ—Ä–±–∞ –¥–ª—è –∏—Å–ø–æ–ª—å–∑—É—é—â–∏—Ö –∏—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π.

![Alt text](./kubernetes-vault/image/ESO.jpg)

---
### **5. –°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª  `./skyfly535_repo/kubernetes-vault/sa.yaml` –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è `serviceAccount` —Å –∏–º–µ–Ω–µ–º `vault-auth` –∏ `ClusterRoleBinding` –¥–ª—è –Ω–µ–≥–æ —Å —Ä–æ–ª—å—é `system:auth-delegator` –≤ namespase `Vault`.**

```yaml
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: vault-auth
  namespace: vault

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: vault-auth-system-auth-delegator
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:auth-delegator
subjects:
- kind: ServiceAccount
  namespace: vault
  name: vault-auth
```

### **6. –°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª  `./skyfly535_repo/kubernetes-vault/otus-policy.hcl` –¥–ª—è  –ø—Ä–∏–º–µ–Ω–∏—Ç—è –ø–æ–ª–∏—Ç–∏–∫–∏ `otus-policy` —Å–µ–∫—Ä–µ—Ç–æ–≤ `/otus/cred` —Å `capabilities = [‚Äúread‚Äù, ‚Äúlist‚Äù]`.**

```
path "/otus/data/cred" {
  capabilities = ["read","list"]
}

path "/otus/metadata/cred" {
    capabilities = ["read", "list"]
}

path "auth/token/renew-self" {
    capabilities = ["update"]
}
```

### **7. –°–æ–∑–¥–∞–Ω –º–∞–Ω–∏—Ñ–µ—Å—Ç  `./skyfly535_repo/kubernetes-vault/secretStore.yaml` –≤ namespace `vault`, —Å–∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ `KV —Å–µ–∫—Ä–µ—Ç–∞–º Vault` —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Ä–∞–Ω–µ–µ —Å–æ–∑–¥–∞–Ω–Ω–æ–π —Ä–æ–ª–∏ `otus` –∏ —Å–µ—Ä–≤–∏—Å –∞–∫–∫–∞—É–Ω—Ç–∞ `vault-auth`.**

```yaml
---
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: otus
  namespace: vault
spec:
  provider:
    vault:
      server: "http://vault.vault:8200"
      namespace: "vault"
      path: "otus"
      version: "v2"
      auth:
        kubernetes:
          mountPath: "kubernetes"
          role: "otus"
          serviceAccountRef:
            name: "vault-auth"
```

### **8. –°–æ–∑–¥–∞–Ω –º–∞–Ω–∏—Ñ–µ—Å—Ç  `./skyfly535_repo/kubernetes-vault/externalSecret.yaml` —É–¥–æ–≤–ª–µ—Ç–≤–∞—Ä—è—é—â–∏–π –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º –î–ó.**

‚óè ns ‚Äì vault–∂;

‚óè SecretStore ‚Äì —Å–æ–∑–¥–∞–Ω–Ω—ã–π –Ω–∞ –ø—Ä–æ—à–ª–æ–º —à–∞–≥–µ;

‚óè Target.name = otus-cred;

‚óè –ü–æ–ª—É—á–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è KV —Å–µ–∫—Ä–µ—Ç–∞ /otus/cred –∏–∑ vault –∏
–æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –∏—Ö –≤ –¥–≤–∞ –∫–ª—é—á–∞ ‚Äì username –∏ password
—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ.

```yaml
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: otus
  namespace: vault
spec:
  refreshInterval: 1h           
  secretStoreRef:
    kind: SecretStore
    name: otus   
  target:
    name: otus-cred 
    creationPolicy: Owner
  dataFrom:
  - extract:
      key: cred
```

### **9. –ù–∞–ø–∏—Å–∞–Ω —Å–∫—Ä–∏–ø—Ç `install.sh` –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è —Ç—Ä–µ–±—É–µ–º–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã.**

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–ª–∞—Å—Ç–µ—Ä–∞ Kubernetes —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—è—é—â–µ–≥–æ —É—Å–ª–æ–≤–∏—è–º –î–ó –≤ Yandex Cloud
cd terraform_YC_k8s && terraform apply -auto-approve
# –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–ª–∞—Å—Ç–µ—Ä –ª–æ–∫–∞–ª—å–Ω–æ
yc managed-kubernetes cluster get-credentials skyfly535 --external
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏–∑ Helm —á–∞—Ä—Ç–∞ consul —Å —Ç—Ä–µ–±—É–µ–º—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
cd ../consul && helmfile apply . && cd ..
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏–∑ Helm —á–∞—Ä—Ç–∞ vault —Å —Ç—Ä–µ–±—É–µ–º—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
cd vault && helmfile apply . && cd ..
#–û–∂–∏–¥–∞–Ω–∏–µ (–ø—Ä–æ–≤–µ—Ä–∫–∞) –∑–∞–ø—É—Å–∫–∞ Pod'–æ–≤ Vault
while [[ "$(kubectl get pod -n vault  | grep -E 'vault-[0-9]' | grep  Running | wc -l)"  -lt "3" ]]; do echo 'waiting for all pod is running'; sleep 1 ;done
# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Vault (–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç Vault —Å —Ç—Ä–µ–º—è –∫–ª—é—á–∞–º–∏ –∏ –ø–æ—Ä–æ–≥–æ–º –≤ —Ç—Ä–∏ –¥–ª—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (unseal))
kubectl -n vault exec -it vault-0 -- vault operator init \
          -key-shares=3 \
          -key-threshold=3 
# –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ (Unseal) –≤—Å–µ—Ö —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ Vault (–ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –≤—Ä—É—á–Ω—É—é –≤–≤–æ–¥–∏—Ç—å unseal-–∫–ª—é—á–∏, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞ —ç—Ç–∞–ø–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏)
for i in 0 1 2; do
  for j in 1 2 3; do
    echo "Enter key number $j"
    kubectl -n vault exec -it  vault-$i -- vault operator unseal 
  done
done
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ—Ä—Ç-—Ñ–æ—Ä–≤–∞—Ä–¥–∏–Ω–≥–∞ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ Vault
kubectl -n vault  port-forward svc/vault 8200:8200 >/dev/null 2>&1 &
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ Vault
echo "Enter Token"
read token
export VAULT_TOKEN=$token
export VAULT_ADDR=http://127.0.0.1:8200
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–æ–≤ –≤ Vault
vault secrets enable -path otus/ kv-v2
vault kv put otus/cred 'username=otus'
vault kv patch otus/cred 'password=asajkjkahs'
# –°–æ–∑–¥–∞–µ—Ç—Å—è ServiceAccount vault-auth –≤ namespace vault (—ç—Ç–æ—Ç ServiceAccount –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ Pod'–æ–≤ –≤ Kubernetes –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ Vault)
kubectl apply -f sa.yaml
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ Vault —á–µ—Ä–µ–∑ Kubernetes
# –í–∫–ª—é—á–∞–µ—Ç –º–µ—Ç–æ–¥ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ Kubernetes –≤ Vault
vault auth enable kubernetes
# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Kubernetes API –∏–∑ Vault
vault write auth/kubernetes/config \
    kubernetes_host=https://kubernetes.default.svc
# –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª–∏—Ç–∏–∫–∏ vault —Å –∏–º–µ–Ω–µ–º otus-policy     
vault policy write otus-policy otus-policy.hcl
# –°–æ–∑–¥–∞–Ω–∏–µ —Ä–æ–ª–∏ otus –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Kubernetes, —Å–≤—è–∑—ã–≤–∞—è –µ–µ —Å ServiceAccount vault-auth –≤ namespace vault –∏ –Ω–∞–∑–Ω–∞—á–∞—è –ø–æ–ª–∏—Ç–∏–∫–∏ default –∏ otus-policy
vault write auth/kubernetes/role/otus \
      bound_service_account_names=vault-auth \
      bound_service_account_namespaces=vault \
      policies=default,otus-policy \
      ttl=24h
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ External Secrets Operator —Å –ø–æ–º–æ—â—å—é Helm (–ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–µ–∫—Ä–µ—Ç—ã –∏–∑ –≤–Ω–µ—à–Ω–∏—Ö —Å–∏—Å—Ç–µ–º (—Ç–∞–∫–∏—Ö –∫–∞–∫ Vault) –≤ Kubernetes Secrets)
helmfile apply -f external-secrets-operator/
#  –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ Pod'–æ–≤ –≤ namespace vault
kubectl wait pod \
  --all \
  --for=condition=Ready \
  --namespace=vault
# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π –¥–ª—è SecretStore –∏ ExternalSecret
kubectl apply -f secretStore.yaml
kubectl apply -f externalSecret.yaml
```

### **10. –ü—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã.**

**10.1** –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ ExternalSecret:

  ```bash
  kubectl get externalsecret -n vault
  NAME   STORE   REFRESH INTERVAL   STATUS         READY
  otus   otus    1h                 SecretSynced   True
  ```

**10.2** –°–º–æ—Ç—Ä–∏–º –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –æ ExternalSecret `otus`:

  ```bash
  kubectl describe externalsecret otus -n vault
  Name:         otus
  Namespace:    vault
  Labels:       <none>
  Annotations:  <none>
  API Version:  external-secrets.io/v1beta1
  Kind:         ExternalSecret
  Metadata:
    Creation Timestamp:  2024-11-06T10:11:21Z
    Generation:          1
    Resource Version:    42565
    UID:                 891bb4d9-b49c-4111-a215-cc7d33c24d06
  Spec:
    Data From:
      Extract:
        Conversion Strategy:  Default
        Decoding Strategy:    None
        Key:                  cred
        Metadata Policy:      None
    Refresh Interval:         1h
    Secret Store Ref:
      Kind:  SecretStore
      Name:  otus
    Target:
      Creation Policy:  Owner
      Deletion Policy:  Retain
      Name:             otus-cred
  Status:
    Binding:
      Name:  otus-cred
    Conditions:
      Last Transition Time:   2024-11-06T10:11:22Z
      Message:                Secret was synced
      Reason:                 SecretSynced
      Status:                 True
      Type:                   Ready
    Refresh Time:             2024-11-06T12:11:22Z
    Synced Resource Version:  1-71fd60287f5d3c8404ee31701921fc75
  Events:                     <none>
  ```

**10.3** –ü–æ–ª—É—á–∞–µ–º YAML-—Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—é ExternalSecret `otus`:

  ```bash
  kubectl get externalsecret otus -n vault -o yaml
  apiVersion: external-secrets.io/v1beta1
  kind: ExternalSecret
  metadata:
    annotations:
      kubectl.kubernetes.io/last-applied-configuration: |
        {"apiVersion":"external-secrets.io/v1beta1","kind":"ExternalSecret","metadata":{"annotations":{},"name":"otus","namespace":"vault"},"spec":{"dataFrom":[{"extract":{"key":"cred"}}],"refreshInterval":"1h","secretStoreRef":{"kind":"SecretStore","name":"otus"},"target":{"creationPolicy":"Owner","name":"otus-cred"}}}
    creationTimestamp: "2024-11-06T10:11:21Z"
    generation: 1
    name: otus
    namespace: vault
    resourceVersion: "42565"
    uid: 891bb4d9-b49c-4111-a215-cc7d33c24d06
  spec:
    dataFrom:
    - extract:
        conversionStrategy: Default
        decodingStrategy: None
        key: cred
        metadataPolicy: None
    refreshInterval: 1h
    secretStoreRef:
      kind: SecretStore
      name: otus
    target:
      creationPolicy: Owner
      deletionPolicy: Retain
      name: otus-cred
  status:
    binding:
      name: otus-cred
    conditions:
    - lastTransitionTime: "2024-11-06T10:11:22Z"
      message: Secret was synced
      reason: SecretSynced
      status: "True"
      type: Ready
    refreshTime: "2024-11-06T12:11:22Z"
    syncedResourceVersion: 1-71fd60287f5d3c8404ee31701921fc75
  ```

**10.4** –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:

  ```bash
  kubectl get externalsecret otus -n vault -o jsonpath="{.status.conditions}"
  [{"lastTransitionTime":"2024-11-06T10:11:22Z","message":"Secret was synced","reason":"SecretSynced","status":"True","type":"Ready"}]
  ```

**10.5** –°–º–æ—Ç—Ä–∏–º —Å–æ–∑–¥–∞–Ω–Ω—ã–π Secret `otus-cred`:

  ```bash
  kubectl describe secret otus-cred -n vault
  Name:         otus-cred
  Namespace:    vault
  Labels:       reconcile.external-secrets.io/created-by=8217762423a09404adc9755e1c595e56
  Annotations:  reconcile.external-secrets.io/data-hash: f445955da15f3ae1278448facb7667cf

  Type:  Opaque

  Data
  ====
  password:  10 bytes
  username:  4 bytes
  ```

**10.6** –î–µ–∫–æ–¥–∏—Ä—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è Secret (–µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ):

  ```bash
  kubectl get secret otus-cred -n vault -o jsonpath="{.data.username}" | base64 --decode
  otus
  kubectl get secret otus-cred -n vault -o jsonpath="{.data.password}" | base64 --decode
  asajkjkahs
  ```

---

![Alt text](./kubernetes-vault/image/vault1.jpg)

–•—Ä–∞–Ω–∏–ª–∏—â–µ —Å–µ–∫—Ä–µ—Ç–æ–≤ otus/ —Å Secret Engine KV –∏ —Å–µ–∫—Ä–µ—Ç–æ–º otus/cred

![Alt text](./kubernetes-vault/image/vault2.jpg)

–ú–µ—Ç–æ–¥ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ Kubernetes

---

# HW10 GitOps –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –ø–æ—Å—Ç–∞–≤–∫–∏.

## –í –ø—Ä–æ—Ü–µ—Å—Å–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –î–ó –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è:

### **1. –ù–∞–ø–∏—Å–∞–Ω—ã –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã `Terraform` –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞ Kubernetes —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—è—é—â–µ–≥–æ —É—Å–ª–æ–≤–∏—è–º –î–ó –≤ `Yandex Cloud`.**

```
# –°–æ–∑–¥–∞–Ω–∏–µ Kubernetes-–∫–ª–∞—Å—Ç–µ—Ä–∞

resource "yandex_kubernetes_cluster" "yc_cluster" {
  name                    = var.cluster_name

  master {
    zonal {
      zone      = var.zone
      subnet_id = var.subnet_id
    }
    version               = var.k8s_version
    public_ip             = true
  }

  network_id              = var.network_id

  service_account_id      = var.service_account_id
  node_service_account_id = var.service_account_id

  release_channel         = "RAPID"
  network_policy_provider = "CALICO"
}

# –°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–ø–ø —É–∑–ª–æ–≤ –¥–ª—è —Ä–∞–±–æ—á–∏—Ö –Ω–∞–≥—Ä—É–∑–æ–∫
resource "yandex_kubernetes_node_group" "workload_node_group" {
  cluster_id  = yandex_kubernetes_cluster.yc_cluster.id

  name        = "${var.cluster_name}-workload"
  version     = var.k8s_version
  count       = var.workload_nodes_count

  instance_template {
    platform_id = "standard-v2"

    network_interface {
      nat                = true
      subnet_ids         = [var.subnet_id]
    }

    resources {
      memory = var.node_memory_size
      cores  = var.node_cpu_count
    }

    boot_disk {
      type = "network-ssd"
      size = var.node_disk_size
    }

    scheduling_policy {
      preemptible = false
    }

    container_runtime {
      type = "containerd"
    }
  }

  scale_policy {
    fixed_scale {
      size = 1
    }
  }
  
  # —Å–æ–∑–¥–∞–Ω–∞ –º–µ—Ç–∫–∞ –¥–ª—è —É–∑–ª–æ–≤ —ç—Ç–æ–π –≥—Ä—É–ø–ø—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞—Å–∫–∞—Ç–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏
  
  node_labels = {
    homework = "true"
  }

  
}

# –°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–ø–ø —É–∑–ª–æ–≤ –¥–ª—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
resource "yandex_kubernetes_node_group" "infra_node_group" {
  cluster_id  = yandex_kubernetes_cluster.yc_cluster.id

  name        = "${var.cluster_name}-infra"
  version     = var.k8s_version
  count       = var.infra_nodes_count

  instance_template {
    platform_id = "standard-v2"

    network_interface {
      nat                = true
      subnet_ids         = [var.subnet_id]
    }

    resources {
      memory = var.node_memory_size
      cores  = var.node_cpu_count
    }

    boot_disk {
      type = "network-ssd"
      size = var.node_disk_size
    }

    scheduling_policy {
      preemptible = false
    }

    container_runtime {
      type = "containerd"
    }
  }

  scale_policy {
    fixed_scale {
      size = 1
    }
  }

  # —Å–æ–∑–¥–∞–Ω–∞ –º–µ—Ç–∫–∞ –¥–ª—è —É–∑–ª–æ–≤ —ç—Ç–æ–π –≥—Ä—É–ø–ø—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞—Å–∫–∞—Ç–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏

  node_labels = {
    node-role = "infra"
  }

  # –¥–æ–±–∞–≤–ª–µ–Ω taint, –∑–∞–ø—Ä–µ—â–∞—é—â–∏–π –Ω–∞ –Ω–µ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–æ–≤ —Å –ø–æ—Å—Ç–æ—Ä–æ–Ω–Ω–µ–π –Ω–∞–≥—Ä—É–∑–∫–æ–π

  node_taints = [
    "node-role=infra:NoSchedule"
  ]
 

}
```
---

### **2. –ü—Ä–∏ –ø–æ–º–æ—â–∏ —Ñ–∞–π–ª–∞ `values.yaml` (—á–∞—Ä—Ç–∞ `Argocd`) —Å–∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∞   –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ argoCD –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –Ω–∞ infra-–Ω–æ–¥—ã (–¥–æ–±–∞–≤–ª–µ–Ω—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ `toleration` –¥–ª—è –æ–±—Ö–æ–¥–∞ `taint`, –∞ —Ç–∞–∫–∂–µ `nodeSelector` –∏ `nodeAffinity`).**

–§–∞–π–ª `./kubernetes-gitops/argocd/values.yaml`

```yaml
global:
  tolerations:
  - key: "node-role"
    operator: "Equal"
    value: "infra"
    effect: "NoSchedule"
  affinity: 
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: node-role
            operator: In
            values:
            - infra

...
  
notifications:
  tolerations:
  - key: "node-role"
    operator: "Equal"
    value: "infra"
    effect: "NoSchedule"
  affinity: 
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: node-role
            operator: In
            values:
            - infra
   
```
### **3. –°–æ–∑–¥–∞–Ω –º–∞–Ω–∏—Ñ–µ—Å—Ç `appproject.yaml` –¥–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –≤ Argocd `project` —Å –∏–º–µ–Ω–µ–º `Otus`.**

–§–∞–π–ª `./kubernetes-gitops/appproject.yaml`

```yaml
apiVersion: argoproj.io/v1alpha1
kind: AppProject
metadata:
  name: otus
  namespace: default
spec:
  clusterResourceWhitelist:
  - group: '*'
    kind: '*'
  destinations:
  - namespace: '*'
    server: '*'
  sourceRepos:
  - '*'
```
---

### **4. –°–æ–∑–¥–∞–Ω –º–∞–Ω–∏—Ñ–µ—Å—Ç `kubernetes-network.yaml` –¥–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –≤ Argocd —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è `kubernetes-network` –æ–ø–∏—Å–∞–Ω–Ω–æ–≥–æ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ `https://github.com/Kuber-2024-08OTUS/skyfly535_repo.git`.**

–§–∞–π–ª `./kubernetes-gitops/kubernetes-network.yaml`

```yaml
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: kubernetes-networks
spec:
  destination:
    namespace: homework
    server: 'https://kubernetes.default.svc'
  source:
    path: kubernetes-networks
    repoURL: 'https://github.com/Kuber-2024-08OTUS/skyfly535_repo.git'
    targetRevision: HEAD
  project: otus
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
```

---

### **5. –°–æ–∑–¥–∞–Ω –º–∞–Ω–∏—Ñ–µ—Å—Ç `kubernetes-templating.yaml` –¥–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –≤ Argocd. —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è `kubernetes-templating.yaml` –æ–ø–∏—Å–∞–Ω–Ω–æ–≥–æ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ `https://github.com/Kuber-2024-08OTUS/skyfly535_repo.git`.**

–§–∞–π–ª `./kubernetes-gitops/kubernetes-templating.yaml`

```yaml
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: kubernetes-templating
spec:
  destination:
    namespace: homeworkhelm
    server: 'https://kubernetes.default.svc'
  source:
    path: kubernetes-templating/homework-app
    repoURL: 'https://github.com/Kuber-2024-08OTUS/skyfly535_repo.git'
    targetRevision: HEAD
    helm:
      valueFiles:
      - values.yaml
      valuesObject:
        namespace: homeworkhelm
        replicaCount: 2
        imageInit:
          repository: alpine/curl
  syncPolicy:
    automated: 
      prune: true 
      selfHeal: true 
    syncOptions:
    - CreateNamespace=true
  project: otus
```
---

### **5. –ù–∞–ø–∏—Å–∞–Ω —Å–∫—Ä–∏–ø—Ç `install.sh` –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è —Ç—Ä–µ–±—É–µ–º–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã.**

–§–∞–π–ª `./kubernetes-gitops/install.sh`

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–ª–∞—Å—Ç–µ—Ä–∞ Kubernetes —É–¥–æ–≤–ª–µ—Ç–≤–∞—Ä—è—é—â–µ–≥–æ —É—Å–ª–æ–≤–∏—è–º –î–ó –≤ Yandex Cloud
cd terraform_YC_k8s && terraform apply -auto-approve
# –†–µ–≥–∏—Å—Ç—Ä—Ä–∞—Ü–∏—è –∫–ª–∞—Å—Ç–µ—Ä –ª–æ–∫–∞–ª—å–Ω–æ
yc managed-kubernetes cluster get-credentials skyfly535 --external
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏–∑ Helm —á–∞—Ä—Ç–∞ argocd —Å —Ç—Ä–µ–±—É–µ–º—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
cd ../argocd && helmfile apply && cd ..
# —É—Å—Ç–∞–Ω–æ–≤–∫ –∏–∑ Helm —á–∞—Ä—Ç–∞ ingress-nginx –¥–ª—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –ø–æ–¥–Ω–∏–º–∞–µ–º—ã—Ö –∞ argocd
helm upgrade --install ingress-nginx ingress-nginx \
  --repo https://kubernetes.github.io/ingress-nginx \
  --namespace ingress-nginx --create-namespace
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤ Argocd `project` —Å –∏–º–µ–Ω–µ–º `Otus`
kubectl apply -f appproject.yaml
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤ Argocd —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è `kubernetes-network`
kubectl apply -f kubernetes-network.yaml
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤ Argocd —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è `kubernetes-templating`
kubectl apply -f kubernetes-templating.yaml
```
---
–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã —Å–∫—Ä–∏–ø—Ç–∞ –ø–æ–ª–µ–∑–Ω–æ –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è "–≤—ã—Ö–ª–æ–ø–æ–º" —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —á–∞—Ä—Ç–∞ `Argocd`

```bash
Release "argocd" does not exist. Installing it now.
NAME: argocd
LAST DEPLOYED: Tue Oct 22 17:59:39 2024
NAMESPACE: default
STATUS: deployed
REVISION: 1
TEST SUITE: None
NOTES:
In order to access the server UI you have the following options:

1. kubectl port-forward service/argocd-server -n default 8080:443

    and then open the browser on http://localhost:8080 and accept the certificate

2. enable ingress in the values file `server.ingress.enabled` and either
      - Add the annotation for ssl passthrough: https://argo-cd.readthedocs.io/en/stable/operator-manual/ingress/#option-1-ssl-passthrough
      - Set the `configs.params."server.insecure"` in the values file and terminate SSL at your ingress: https://argo-cd.readthedocs.io/en/stable/operator-manual/ingress/#option-2-multiple-ingress-objects-and-hosts


After reaching the UI the first time you can login with username: admin and the random password generated during the installation. You can find the password by running:

kubectl -n default get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d

(You should delete the initial secret afterwards as suggested by the Getting Started Guide: https://argo-cd.readthedocs.io/en/stable/getting_started/#4-login-using-the-cli)

Listing releases matching ^argocd$
argocd	default  	1       	2024-10-22 17:59:39.378831107 +1000 +10	deployed	argo-cd-7.6.12	v2.12.6    


UPDATED RELEASES:
NAME     CHART               VERSION   DURATION
argocd   argo-helm/argo-cd   7.6.12       1m24s

```
---

### **6. –ü—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã.**

- **6.1** –í—Å—è –Ω–∞–≥—Ä—É–∑–∫–∞ `Argocd` —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–∞ –Ω–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ–π –Ω–æ–¥–µ, –∞ –Ω–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –Ω–∞ –Ω–æ–¥–µ –¥–ª—è —Ä–∞–±–æ—á–µ–π –Ω–∞–≥—Ä—É–∑–∫–∏. 

```bash
$ kubectl get nodes -o custom-columns=NAME:.metadata.name,TAINTS:.spec.taints
NAME                        TAINTS
cl16v4tv903vlmfhnidt-utel   [map[effect:NoSchedule key:node-role value:infra]]
cl1u5t8pmkfkr7gn26pi-uhyh   <none>

$ kubectl get pods -o wide
NAME                                               READY   STATUS    RESTARTS   AGE   IP              NODE                        NOMINATED NODE   READINESS GATES
argocd-application-controller-0                    1/1     Running   0          72m   10.112.128.4    cl16v4tv903vlmfhnidt-utel   <none>           <none>
argocd-applicationset-controller-c9697658-gxp4n    1/1     Running   0          72m   10.112.128.7    cl16v4tv903vlmfhnidt-utel   <none>           <none>
argocd-dex-server-76d5bdcbf4-2bw2z                 1/1     Running   0          72m   10.112.128.10   cl16v4tv903vlmfhnidt-utel   <none>           <none>
argocd-notifications-controller-79f78d44bc-dchsp   1/1     Running   0          72m   10.112.128.5    cl16v4tv903vlmfhnidt-utel   <none>           <none>
argocd-redis-5bdf85566c-9zqrs                      1/1     Running   0          72m   10.112.128.6    cl16v4tv903vlmfhnidt-utel   <none>           <none>
argocd-repo-server-76d6bcf6c7-w45dg                1/1     Running   0          72m   10.112.128.8    cl16v4tv903vlmfhnidt-utel   <none>           <none>
argocd-server-bc65fdd6c-scmn6                      1/1     Running   0          72m   10.112.128.9    cl16v4tv903vlmfhnidt-utel   <none>           <none>

$ kubectl get pods -n homeworkhelm -o wide
NAME                                                  READY   STATUS    RESTARTS   AGE     IP              NODE                        NOMINATED NODE   READINESS GATES
kubernetes-templating-homework-app-5665d68f57-b2nts   1/1     Running   0          8m11s   10.112.129.23   cl1u5t8pmkfkr7gn26pi-uhyh   <none>           <none>
kubernetes-templating-homework-app-5665d68f57-shmgs   1/1     Running   0          8m11s   10.112.129.24   cl1u5t8pmkfkr7gn26pi-uhyh   <none>           <none>
kubernetes-templating-redis-master-0                  1/1     Running   0          8m11s   10.112.129.25   cl1u5t8pmkfkr7gn26pi-uhyh   <none>           <none>
kubernetes-templating-redis-replicas-0                1/1     Running   0          8m11s   10.112.129.26   cl1u5t8pmkfkr7gn26pi-uhyh   <none>           <none>
kubernetes-templating-redis-replicas-1                1/1     Running   0          7m      10.112.129.27   cl1u5t8pmkfkr7gn26pi-uhyh   <none>           <none>
kubernetes-templating-redis-replicas-2                1/1     Running   0          6m18s   10.112.129.28   cl1u5t8pmkfkr7gn26pi-uhyh   <none>           <none>
```
---

- **6.2** –°–º–æ—Ç—Ä–∏–º —á–µ—Ä–µ–∑ `Argocd` –Ω–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é –∑–∞–ø—É—â–µ–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è `kubernetes-network`.

![Alt text](./kubernetes-gitops/image/argo_net.jpg)

–°—Ç—É—á–∏–º—Å—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

```bash
$ curl http://homework.otus-skyfly.ru/homepage
Hello, OTUS! Homework 3!
$ curl http://homework.otus-skyfly.ru/index.html
Hello, OTUS! Homework 3!
```
---

- **6.3** –°–º–æ—Ç—Ä–∏–º —á–µ—Ä–µ–∑ `Argocd` –Ω–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é –∑–∞–ø—É—â–µ–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è `kubernetes-templating`.

![Alt text](./kubernetes-gitops/image/argo_templ.jpg)

–°—Ç—É—á–∏–º—Å—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

```bash 
$ curl http://homework.otus-skyfly.ru/homepage
Hello, OTUS! Homework 6! ConfigMap Text.
$ curl http://homework.otus-skyfly.ru/index.html
Hello, OTUS! Homework 6! ConfigMap Text.
```
---

# HW9 –°–µ—Ä–≤–∏—Å—ã —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è Kubernetes.

## –í –ø—Ä–æ—Ü–µ—Å—Å–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –î–ó –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è:

### **1. –ü—Ä–æ–≤–µ—Ä–µ–Ω–∞ —Ä–∞–±–æ—Ç —Ä–∞–Ω–µ–µ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ Yandex Cloud.**


```bash
yc vpc network list
+----------------------+---------+
|          ID          |  NAME   |
+----------------------+---------+
| enpj03ta8*********** | default |
+----------------------+---------+
```

### **2. –ù–∞–≥—É–≥–ª–µ–Ω –∏ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω —Å–∫—Ä–∏–ø—Ç, —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞—é—â–∏–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—è—é—â—É—é —É—Å–ª–æ–≤–∏—è–º –î–ó.**

```sh
# –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã –≤ YC
yc iam service-account create --name k8s-cluster-logging
FOLDER_ID=$(yc config get folder-id)
SA_ID=$(yc iam service-account get --name k8s-cluster-logging --format json | jq .id -r)
# –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ä–æ–ª–∏ admin —Å–µ—Ä–≤–∏—Å–Ω–æ–º—É –∞–∫–∫–∞—É–Ω—Ç—É
yc resource-manager folder add-access-binding --id $FOLDER_ID  --role admin --subject serviceAccount:$SA_ID
# –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∫–ª—é—á–∞ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ Yandex Object Storage
if [ ! -f .sa.secret ]; then
  yc iam access-key create  --service-account-id $SA_ID >  .sa.secret
fi 
# –°–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ —Å–µ–∫—Ä–µ—Ç–∞
export accessKeyId=$(cat .sa.secret | grep 'key_id' | awk -F ':' '{print $2}')
export secretAccessKey=$(cat .sa.secret | grep 'secret' | awk -F ':' '{print $2}')

# –®–∞–±–ª–æ–Ω–∏–∑–∏—Ä–æ–≤–æ–Ω–∏–µ —Ñ–∞–π–ª–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–ª—è loki
cat loki/values.yaml.tpl | envsubst > loki/values.yaml

# –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∞—Å—Ç–µ—Ä–∞ managed-kubernetes –≤ YC
yc managed-kubernetes cluster create \
 --name k8s-logging --network-name default \
 --zone ru-central1-a  --subnet-name k8s \
 --public-ip \
 --service-account-id ${SA_ID} --node-service-account-id ${SA_ID} 

# –°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–ø–ø —É–∑–ª–æ–≤ (Node Groups)
# –ì—Ä—É–ø–ø–∞ —É–∑–ª–æ–≤ –¥–ª—è —Ä–∞–±–æ—á–∏—Ö –Ω–∞–≥—Ä—É–∑–æ–∫
 yc managed-kubernetes node-group create   \
 --name  k8s-logging-workers \
 --cluster-name k8s-logging \
 --cores 2 \
 --memory 4 \
 --core-fraction 5 \
 --preemptible \
 --fixed-size 1 \
 --network-interface subnets=k8s,ipv4-address=nat
# –ì—Ä—É–ø–ø–∞ —É–∑–ª–æ–≤ –¥–ª—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
 yc managed-kubernetes node-group create \
 --name  k8s-logging-infra \
 --cluster-name k8s-logging \
 --cores 2 \
 --memory 4 \
 --core-fraction 5 \
 --fixed-size 1 \
 --preemptible \
 --node-labels node-role=infra \
 --network-interface subnets=k8s,ipv4-address=nat
# –†–µ–≥–∏—Å—Ç—Ä—Ä–∞—Ü–∏—è –∫–ª–∞—Å—Ç–µ—Ä –ª–æ–∫–∞–ª—å–Ω–æ
yc managed-kubernetes cluster get-credentials --external --name k8s-logging --force
# –°–æ–∑–¥–∞–Ω–∏–µ taint –¥–ª—è —É–∑–ª–æ–≤ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
kubectl taint nodes -l node-role=infra node-role=infra:NoSchedule
# –°–æ–∑–¥–∞–Ω–∏–µ namespase monitoring
kubectl create ns monitoring

# –°–æ–∑–¥–∞–Ω–∏–µ S3 –±–∞–∫–µ—Ç–æ–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ª–æ–≥–æ–≤
yc storage bucket create  monitoring-loki-chunks
yc storage bucket create  monitoring-loki-ruler
yc storage bucket create  monitoring-loki-admin
# –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–Ω–æ–º—É —Å–µ—Ä–≤–∏—Å–Ω–æ–º—É –∞–∫–∞—É–Ω—Ç—É –ø—Ä–∞–≤ –Ω–∞ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ S3 –±–∞–∫–µ—Ç—ã
yc storage bucket update --name monitoring-loki-chunks  \
    --grants grant-type=grant-type-account,grantee-id=${SA_ID},permission=permission-full-control

yc storage bucket update --name monitoring-loki-ruler   \
    --grants grant-type=grant-type-account,grantee-id=${SA_ID},permission=permission-full-control

yc storage bucket update --name monitoring-loki-admin  \
    --grants grant-type=grant-type-account,grantee-id=${SA_ID},permission=permission-full-control

# –ó–∞–ø—É—Å–∫ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Helm loki
cd loki && helmfile apply; cd ..
# –ó–∞–ø—É—Å–∫ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Helm promtail
cd promtail && helmfile apply; cd ..
# –ó–∞–ø—É—Å–∫ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Helm grafana
cd grafana && helmfile apply; cd ..
```

```bash
/kubernetes-logging$ sh install.sh 
done (1s)
id: ajei14g8nj**********
folder_id: b1ghhcttru**********
created_at: "2024-10-18T12:29:44.867445870Z"
name: k8s-cluster-logging

done (3s)
effective_deltas:
  - action: ADD
    access_binding:
      role_id: admin
      subject:
        id: ajei14g8nj**********
        type: serviceAccount

done (8m2s)

...

Listing releases matching ^grafana$
grafana	monitoring	1       	2024-10-18 22:46:02.737090945 +1000 +10	deployed	grafana-7.3.8	10.4.1     


UPDATED RELEASES:
NAME      CHART             VERSION   DURATION
grafana   grafana/grafana   7.3.8          23s
```


### **3. –ü—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã.**

- **3.1** –í—Å—è –Ω–∞–≥—Ä—É–∑–∫–∞ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–∞ (–∑–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ–º –æ–¥–Ω–æ–≥–æ poda promatil) –Ω–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ–π –Ω–æ–¥–µ.

```bash
$ kubectl get nodes -o custom-columns=NAME:.metadata.name,TAINTS:.spec.taints
NAME                        TAINTS
cl128qd0q29qcm4ckion-ohim   [map[effect:NoSchedule key:node-role value:infra]]
cl1bl0ebne1kivk33qbc-ymoq   <none>

$ kubectl get pods -n monitoring -o wide
NAME                            READY   STATUS    RESTARTS   AGE   IP              NODE                        NOMINATED NODE   READINESS GATES
grafana-77d7446cb4-lkrq6        1/1     Running   0          43m   10.112.129.10   cl128qd0q29qcm4ckion-ohim   <none>           <none>
loki-backend-0                  2/2     Running   0          44m   10.112.129.8    cl128qd0q29qcm4ckion-ohim   <none>           <none>
loki-chunks-cache-0             2/2     Running   0          44m   10.112.129.6    cl128qd0q29qcm4ckion-ohim   <none>           <none>
loki-gateway-5c7d554f54-zlh2r   1/1     Running   0          44m   10.112.129.3    cl128qd0q29qcm4ckion-ohim   <none>           <none>
loki-read-7d75cc8694-br594      1/1     Running   0          44m   10.112.129.4    cl128qd0q29qcm4ckion-ohim   <none>           <none>
loki-results-cache-0            2/2     Running   0          44m   10.112.129.5    cl128qd0q29qcm4ckion-ohim   <none>           <none>
loki-write-0                    1/1     Running   0          44m   10.112.129.7    cl128qd0q29qcm4ckion-ohim   <none>           <none>
promatil-promtail-hwhlh         1/1     Running   0          43m   10.112.128.8    cl1bl0ebne1kivk33qbc-ymoq   <none>           <none>
promatil-promtail-z6dsx         1/1     Running   0          43m   10.112.129.9    cl128qd0q29qcm4ckion-ohim   <none>           <none>
```

- **3.2** –°–æ–∑–¥–∞–Ω—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ `S3` –±–∞–∫–µ—Ç—ã.

```bash
$ yc storage bucket list
+------------------------+----------------------+----------+-----------------------+---------------------+
|          NAME          |      FOLDER ID       | MAX SIZE | DEFAULT STORAGE CLASS |     CREATED AT      |
+------------------------+----------------------+----------+-----------------------+---------------------+
| monitoring-loki-chunks | b1ghhcttrug793gc11tt |        0 | STANDARD              | 2024-10-18 12:24:35 |
| monitoring-loki-ruler  | b1ghhcttrug793gc11tt |        0 | STANDARD              | 2024-10-18 12:24:41 |
| monitoring-loki-admin  | b1ghhcttrug793gc11tt |        0 | STANDARD              | 2024-10-18 12:24:47 |
+------------------------+----------------------+----------+-----------------------+---------------------+

```

- **3.3** –ü—Ä–æ–≤–µ—Ä–µ–Ω–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤ Grafana.

–ü–æ–ª—å–∑—É–µ–º—Å—è "–≤—ã—Ö–ª–æ–ø–æ–º" `Helm —á–∞—Ä—Ç–∞ Grafana`

```bash
1. Get your 'admin' user password by running:

   kubectl get secret --namespace monitoring grafana -o jsonpath="{.data.admin-password}" | base64 --decode ; echo


2. The Grafana server can be accessed via port 80 on the following DNS name from within your cluster:

   grafana.monitoring.svc.cluster.local

   Get the Grafana URL to visit by running these commands in the same shell:
     export POD_NAME=$(kubectl get pods --namespace monitoring -l "app.kubernetes.io/name=grafana,app.kubernetes.io/instance=grafana" -o jsonpath="{.items[0].metadata.name}")
     kubectl --namespace monitoring port-forward $POD_NAME 3000

3. Login with the password from step 1 and the username: admin
#################################################################################
######   WARNING: Persistence is disabled!!! You will lose your data when   #####
######            the Grafana pod is terminated.                            #####
#################################################################################
```
–Ω–∞–±–ª—é–¥–∞–µ–º —Å–ª–µ–¥—É—é—â—É—é –∫–∞—Ä—Ç–∏–Ω—É

![Alt text](./kubernetes-logging/image/logining.jpg)

# HW8 –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ.

## –í –ø—Ä–æ—Ü–µ—Å—Å–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –î–ó –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è:

### 1. –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω `Prometheus Operator` —á–µ—Ä–µ–∑ Helm-—á–∞—Ä—Ç.

**1.1 –î–æ–±–∞–≤–∫–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –µ–≥–æ:**

```bash
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm repo update
```

**1.2 –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Prometheus Operator:**

```bash
helm install prometheus-operator prometheus-community/kube-prometheus-stack
```
### 2. –°–æ–∑–¥–∞–Ω –º–∞–Ω–∏—Ñ–µ—Å—Ç `CM-Nginx.yaml (ConfigMap)`, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—É—é `–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é NGINX` –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è `Deployment`.

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
  namespace: default
data:
  nginx.conf: |
    events {}

    http {
        server {
            listen 80;

            location / {
                root /usr/share/nginx/html;  # –ü—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏, –æ—Ç–∫—É–¥–∞ NGINX –±—É–¥–µ—Ç –æ–±—Å–ª—É–∂–∏–≤–∞—Ç—å —Ñ–∞–π–ª—ã
                index index.html;            # –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞, –∫–æ—Ç–æ—Ä—É—é NGINX –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å –ø–æ –∑–∞–ø—Ä–æ—Å—É "/"
                try_files $uri $uri/ =404;   # –ï—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω, –≤–µ—Ä–Ω–µ—Ç—Å—è –æ—à–∏–±–∫–∞ 404
            }

            # Endpoint –¥–ª—è –º–µ—Ç—Ä–∏–∫
            location /stub_status {
                stub_status;
                allow all;  # –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –ø–æ IP –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
            }
        }
    }
```
### **3. –°–æ–∑–¥–∞–Ω `Deployment` –¥–ª—è nginx —Å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –¥–ª—è `Prometheus Exporter`.**

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –≤–∞—Ä–∏–∞–Ω—Ç –≤–∫–ª—é—á–µ–Ω–∏—è —ç–∫—Å–ø–æ—Ä—Ç–µ—Ä–∞ –ø—Ä–∏ –ø–æ–º–æ—â–∏ `sidecar –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º`.

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: homework-deployment
  labels:
    app: nginx
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:alpine
        ports:
        - containerPort: 80
        volumeMounts:
        - name: nginx-config-volume
          mountPath: /etc/nginx/nginx.conf
          subPath: nginx.conf
        - name: homework-volume
          mountPath: /homework
        lifecycle:
          preStop:
            exec:
              command: ["rm", "/homework/index.html"]
        command: ["/bin/sh", "-c"]
        args:
          - |
            cp /homework/index.html /usr/share/nginx/html/index.html && \
            exec nginx -g 'daemon off;' -c /etc/nginx/nginx.conf
        readinessProbe:
          exec:
            command:
            - cat
            - /homework/index.html
          initialDelaySeconds: 5
          periodSeconds: 10
      - name: nginx-prometheus-exporter # –≤–∫–ª—é—á–µ–Ω–∏–µ —ç–∫—Å–ø–æ—Ä—Ç–µ—Ä–∞
        image: nginx/nginx-prometheus-exporter:latest
        args:
          - -nginx.scrape-uri=http://localhost/stub_status
        ports:
        - containerPort: 9113
      initContainers:
      - name: init-container
        image: busybox
        command: ["/bin/sh", "-c"]
        args:
          - echo "Hello, OTUS! Homework 8.0 Metrics." > /homework/index.html
        volumeMounts:
        - name: homework-volume
          mountPath: /homework
      volumes:
      - name: nginx-config-volume
        configMap:
          name: nginx-config
      - name: homework-volume
        emptyDir: {}

```

### **4. –°–æ–∑–¥–∞–Ω `Service` Deployment-–∞ –¥–ª—è —ç–∫—Å–ø–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –º–µ—Ç—Ä–∏–∫.**

**b. Service (`nginx-service.yaml`):**

```yaml
apiVersion: v1
kind: Service
metadata:
  name: nginx-service
  labels:
    app: nginx
spec:
  selector:
    app: nginx
  ports:
    - name: http 
      protocol: TCP
      port: 80
      targetPort: 80
    - name: metrics
      port: 9113
      targetPort: 9113
  type: LoadBalancer
```

---

### **5. –°–æ–∑–¥–∞–Ω `ServiceMonitor` –¥–ª—è —Å–±–æ—Ä–∞ –º–µ—Ç—Ä–∏–∫.**

ServiceMonitor (`nginx-servicemonitor.yaml`)

```yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: nginx-servicemonitor
  labels:
    app: nginx
spec:
  selector:
    matchLabels:
      app: nginx
  endpoints:
  - port: metrics
    interval: 15s
```

---

### **–ü—Ä–∏–º–µ–Ω—è–µ–º –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã **

```bash
kubectl apply -f CM-Nginx.yaml
kubectl apply -f deployment.yaml
kubectl apply -f service.yaml
kubectl apply -f nginx-servicemonitor.yaml
```

---

### **–ü—Ä–æ–≤–µ—Ä—è–µ–º**

```bash
$ minikube service nginx-service
|-----------|---------------|--------------|---------------------------|
| NAMESPACE |     NAME      | TARGET PORT  |            URL            |
|-----------|---------------|--------------|---------------------------|
| default   | nginx-service | http/80      | http://192.168.49.2:30246 |
|           |               | metrics/9113 | http://192.168.49.2:31544 |
|-----------|---------------|--------------|---------------------------|

[default nginx-service http/80
metrics/9113 http://192.168.49.2:30246
http://192.168.49.2:31544]

$ curl http://192.168.49.2:30246/
Hello, OTUS! Homework 8.0 Metrics.

$ curl http://192.168.49.2:31544/metrics
# HELP go_gc_duration_seconds A summary of the pause duration of garbage collection cycles.
# TYPE go_gc_duration_seconds summary
go_gc_duration_seconds{quantile="0"} 0
go_gc_duration_seconds{quantile="0.25"} 0
go_gc_duration_seconds{quantile="0.5"} 0
go_gc_duration_seconds{quantile="0.75"} 0
go_gc_duration_seconds{quantile="1"} 0
go_gc_duration_seconds_sum 0
go_gc_duration_seconds_count 0
# HELP go_goroutines Number of goroutines that currently exist.
# TYPE go_goroutines gauge
go_goroutines 13
# HELP go_info Information about the Go environment.
# TYPE go_info gauge
go_info{version="go1.22.5"} 1
# HELP go_memstats_alloc_bytes Number of bytes allocated and still in use.
# TYPE go_memstats_alloc_bytes gauge
go_memstats_alloc_bytes 1.40464e+06
# HELP go_memstats_alloc_bytes_total Total number of bytes allocated, even if freed.
# TYPE go_memstats_alloc_bytes_total counter
go_memstats_alloc_bytes_total 1.40464e+06
# HELP go_memstats_buck_hash_sys_bytes Number of bytes used by the profiling bucket hash table.
# TYPE go_memstats_buck_hash_sys_bytes gauge
go_memstats_buck_hash_sys_bytes 8154
# HELP go_memstats_frees_total Total number of frees.
# TYPE go_memstats_frees_total counter
go_memstats_frees_total 0
# HELP go_memstats_gc_sys_bytes Number of bytes used for garbage collection system metadata.
# TYPE go_memstats_gc_sys_bytes gauge
go_memstats_gc_sys_bytes 1.478384e+06
# HELP go_memstats_heap_alloc_bytes Number of heap bytes allocated and still in use.
# TYPE go_memstats_heap_alloc_bytes gauge
go_memstats_heap_alloc_bytes 1.40464e+06
# HELP go_memstats_heap_idle_bytes Number of heap bytes waiting to be used.
# TYPE go_memstats_heap_idle_bytes gauge
go_memstats_heap_idle_bytes 3.93216e+06
# HELP go_memstats_heap_inuse_bytes Number of heap bytes that are in use.
# TYPE go_memstats_heap_inuse_bytes gauge
go_memstats_heap_inuse_bytes 3.784704e+06
# HELP go_memstats_heap_objects Number of allocated objects.
# TYPE go_memstats_heap_objects gauge
go_memstats_heap_objects 1334
# HELP go_memstats_heap_released_bytes Number of heap bytes released to OS.
# TYPE go_memstats_heap_released_bytes gauge
go_memstats_heap_released_bytes 3.93216e+06
# HELP go_memstats_heap_sys_bytes Number of heap bytes obtained from system.
# TYPE go_memstats_heap_sys_bytes gauge
go_memstats_heap_sys_bytes 7.716864e+06
# HELP go_memstats_last_gc_time_seconds Number of seconds since 1970 of last garbage collection.
# TYPE go_memstats_last_gc_time_seconds gauge
go_memstats_last_gc_time_seconds 0
# HELP go_memstats_lookups_total Total number of pointer lookups.
# TYPE go_memstats_lookups_total counter
go_memstats_lookups_total 0
# HELP go_memstats_mallocs_total Total number of mallocs.
# TYPE go_memstats_mallocs_total counter
go_memstats_mallocs_total 1334
# HELP go_memstats_mcache_inuse_bytes Number of bytes in use by mcache structures.
# TYPE go_memstats_mcache_inuse_bytes gauge
go_memstats_mcache_inuse_bytes 4800
# HELP go_memstats_mcache_sys_bytes Number of bytes used for mcache structures obtained from system.
# TYPE go_memstats_mcache_sys_bytes gauge
go_memstats_mcache_sys_bytes 15600
# HELP go_memstats_mspan_inuse_bytes Number of bytes in use by mspan structures.
# TYPE go_memstats_mspan_inuse_bytes gauge
go_memstats_mspan_inuse_bytes 64320
# HELP go_memstats_mspan_sys_bytes Number of bytes used for mspan structures obtained from system.
# TYPE go_memstats_mspan_sys_bytes gauge
go_memstats_mspan_sys_bytes 65280
# HELP go_memstats_next_gc_bytes Number of heap bytes when next garbage collection will take place.
# TYPE go_memstats_next_gc_bytes gauge
go_memstats_next_gc_bytes 4.194304e+06
# HELP go_memstats_other_sys_bytes Number of bytes used for other system allocations.
# TYPE go_memstats_other_sys_bytes gauge
go_memstats_other_sys_bytes 1.15951e+06
# HELP go_memstats_stack_inuse_bytes Number of bytes in use by the stack allocator.
# TYPE go_memstats_stack_inuse_bytes gauge
go_memstats_stack_inuse_bytes 655360
# HELP go_memstats_stack_sys_bytes Number of bytes obtained from system for stack allocator.
# TYPE go_memstats_stack_sys_bytes gauge
go_memstats_stack_sys_bytes 655360
# HELP go_memstats_sys_bytes Number of bytes obtained from system.
# TYPE go_memstats_sys_bytes gauge
go_memstats_sys_bytes 1.1099152e+07
# HELP go_threads Number of OS threads created.
# TYPE go_threads gauge
go_threads 9
# HELP nginx_connections_accepted Accepted client connections
# TYPE nginx_connections_accepted counter
nginx_connections_accepted 6
# HELP nginx_connections_active Active client connections
# TYPE nginx_connections_active gauge
nginx_connections_active 1
# HELP nginx_connections_handled Handled client connections
# TYPE nginx_connections_handled counter
nginx_connections_handled 6
# HELP nginx_connections_reading Connections where NGINX is reading the request header
# TYPE nginx_connections_reading gauge
nginx_connections_reading 0
# HELP nginx_connections_waiting Idle client connections
# TYPE nginx_connections_waiting gauge
nginx_connections_waiting 0
# HELP nginx_connections_writing Connections where NGINX is writing the response back to the client
# TYPE nginx_connections_writing gauge
nginx_connections_writing 1
# HELP nginx_exporter_build_info A metric with a constant '1' value labeled by version, revision, branch, goversion from which nginx_exporter was built, and the goos and goarch for the build.
# TYPE nginx_exporter_build_info gauge
nginx_exporter_build_info{branch="HEAD",goarch="amd64",goos="linux",goversion="go1.22.5",revision="9522f4e39ee1aed817d7d70a89514ccc0ae1594a",tags="unknown",version="1.3.0"} 1
# HELP nginx_http_requests_total Total http requests
# TYPE nginx_http_requests_total counter
nginx_http_requests_total 6
# HELP nginx_up Status of the last metric scrape
# TYPE nginx_up gauge
nginx_up 1
# HELP process_cpu_seconds_total Total user and system CPU time spent in seconds.
# TYPE process_cpu_seconds_total counter
process_cpu_seconds_total 0.01
# HELP process_max_fds Maximum number of open file descriptors.
# TYPE process_max_fds gauge
process_max_fds 1.048576e+06
# HELP process_open_fds Number of open file descriptors.
# TYPE process_open_fds gauge
process_open_fds 11
# HELP process_resident_memory_bytes Resident memory size in bytes.
# TYPE process_resident_memory_bytes gauge
process_resident_memory_bytes 1.1513856e+07
# HELP process_start_time_seconds Start time of the process since unix epoch in seconds.
# TYPE process_start_time_seconds gauge
process_start_time_seconds 1.72812581329e+09
# HELP process_virtual_memory_bytes Virtual memory size in bytes.
# TYPE process_virtual_memory_bytes gauge
process_virtual_memory_bytes 1.26662656e+09
# HELP process_virtual_memory_max_bytes Maximum amount of virtual memory available in bytes.
# TYPE process_virtual_memory_max_bytes gauge
process_virtual_memory_max_bytes 1.8446744073709552e+19
# HELP promhttp_metric_handler_requests_in_flight Current number of scrapes being served.
# TYPE promhttp_metric_handler_requests_in_flight gauge
promhttp_metric_handler_requests_in_flight 1
# HELP promhttp_metric_handler_requests_total Total number of scrapes by HTTP status code.
# TYPE promhttp_metric_handler_requests_total counter
promhttp_metric_handler_requests_total{code="200"} 2
promhttp_metric_handler_requests_total{code="500"} 0
promhttp_metric_handler_requests_total{code="503"} 0
```
---

# HW7 –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ CRD.

## –í –ø—Ä–æ—Ü–µ—Å—Å–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –î–ó –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è:

### 1. –°–æ–∑–¥–∞–Ω –º–∞–Ω–∏—Ñ–µ—Å—Ç –æ–±—ä–µ–∫—Ç–∞ `CustomResourceDefinition` —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—è—é—â–∏–π —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –î–ó.

**1.1 CustomResourceDefinition (CRD) –¥–ª—è MySQL**

```yaml
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: mysqls.otus.homework
spec:
  group: otus.homework
  versions:
    - name: v1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          required:
            - spec
          properties:
            spec:
              type: object
              required:
                - image
                - database
                - password
                - storage_size
              properties:
                image:
                  type: string
                database:
                  type: string
                password:
                  type: string
                storage_size:
                  type: string
  scope: Namespaced
  names:
    plural: mysqls
    singular: mysql
    kind: MySQL
    shortNames:
      - my
```

---

**1.2 ServiceAccount, ClusterRole –∏ ClusterRoleBinding**

- **ServiceAccount**

  ```yaml
  apiVersion: v1
  kind: ServiceAccount
  metadata:
    name: mysql-operator
    namespace: default
  ```

- **ClusterRole —Å –ø–æ–ª–Ω—ã–º –¥–æ—Å—Ç—É–ø–æ–º**

  ```yaml
  apiVersion: rbac.authorization.k8s.io/v1
  kind: ClusterRole
  metadata:
    name: mysql-operator
  rules:
    - apiGroups: ["*"]
      resources: ["*"]
      verbs: ["*"]
  ```

- **ClusterRoleBinding**

  ```yaml
  apiVersion: rbac.authorization.k8s.io/v1
  kind: ClusterRoleBinding
  metadata:
    name: mysql-operator
  subjects:
    - kind: ServiceAccount
      name: mysql-operator
      namespace: default
  roleRef:
    kind: ClusterRole
    name: mysql-operator
    apiGroup: rbac.authorization.k8s.io
  ```

---

**1.3 Deployment –¥–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞**

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mysql-operator
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      name: mysql-operator
  template:
    metadata:
      labels:
        name: mysql-operator
    spec:
      serviceAccountName: mysql-operator
      containers:
        - name: mysql-operator
          image: roflmaoinmysoul/mysql-operator:1.0.0
```

---

**1.4 –ö–∞—Å—Ç–æ–º–Ω—ã–π —Ä–µ—Å—É—Ä—Å —Ç–∏–ø–∞ MySQL**

```yaml
apiVersion: otus.homework/v1
kind: MySQL
metadata:
  name: mysql-instance
  namespace: default
spec:
  image: mysql:5.7
  database: mydb
  password: mypassword
  storage_size: 1Gi
```

---

**–ü–æ—è—Å–Ω–µ–Ω–∏–µ:**

- **CRD:** –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –Ω–æ–≤—ã–π –∫–∞—Å—Ç–æ–º–Ω—ã–π —Ä–µ—Å—É—Ä—Å `MySQL` —Å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º–∏ —Å—Ç—Ä–æ–∫–æ–≤—ã–º–∏ –∞—Ç—Ä–∏–±—É—Ç–∞–º–∏: `image`, `database`, `password` –∏ `storage_size`.
- **ServiceAccount, ClusterRole, ClusterRoleBinding:** –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç —Å–µ—Ä–≤–∏—Å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç `mysql-operator` —Å –ø–æ–ª–Ω—ã–º –¥–æ—Å—Ç—É–ø–æ–º –∫ API.
- **Deployment:** –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–µ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä, –∏—Å–ø–æ–ª—å–∑—É—è —É–∫–∞–∑–∞–Ω–Ω—ã–π –æ–±—Ä–∞–∑ –∏ —Å–µ—Ä–≤–∏—Å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç.
- **–ö–∞—Å—Ç–æ–º–Ω—ã–π —Ä–µ—Å—É—Ä—Å:** –≠–∫–∑–µ–º–ø–ª—è—Ä `MySQL`, –∫–æ—Ç–æ—Ä—ã–º –±—É–¥–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å –æ–ø–µ—Ä–∞—Ç–æ—Ä.


**–ü—Ä–∏–º–µ–Ω—è–µ–º –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–±–æ—Ç—É –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞**

–ü—Ä–æ–≤–µ—Ä–∫—É –ø—Ä–æ–≤–æ–¥–∏–º –≤ `Minikube`

- **–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤**

```bash
./kubernetes-operators$ kubectl apply -f CRD_MySQL.yaml 
customresourcedefinition.apiextensions.k8s.io/mysqls.otus.homework created

./kubernetes-operators$ kubectl apply -f SA_MySQL.yaml 
serviceaccount/mysql-operator created

./kubernetes-operators$ kubectl apply -f CR_MySQL_old.yaml 
clusterrole.rbac.authorization.k8s.io/mysql-operator created

./kubernetes-operators$ kubectl apply -f CRB_MySQL.yaml 
clusterrolebinding.rbac.authorization.k8s.io/mysql-operator created

./kubernetes-operators$ kubectl apply -f Deployment_MySQL.yaml 
deployment.apps/mysql-operator created

./kubernetes-operators$ kubectl apply -f MySQL.yaml 
mysql.otus.homework/mysql-instance created
```

- **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è CRD**

```bash
$ kubectl get crd mysqls.otus.homework
NAME                   CREATED AT
mysqls.otus.homework   2024-10-01T12:43:58Z
```

- **–ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ Deployment –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç**

```bash
$ kubectl get deployments
NAME             READY   UP-TO-DATE   AVAILABLE   AGE
mysql-instance   1/1     1            1           2m24s
mysql-operator   1/1     1            1           4m43s
```

- **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ —Ä–µ—Å—É—Ä—Å–∞**

```bash
$ kubectl get mysqls
NAME             AGE
mysql-instance   3m55s
```

- **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º Deployment, Service, PV –∏ PVC**

```bash
$ kubectl get deployments
NAME             READY   UP-TO-DATE   AVAILABLE   AGE
mysql-instance   1/1     1            1           4m57s
mysql-operator   1/1     1            1           7m16s

$ kubectl get service
NAME             TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)    AGE
kubernetes       ClusterIP   10.96.0.1    <none>        443/TCP    10m
mysql-instance   ClusterIP   None         <none>        3306/TCP   5m5s

$ kubectl get pv
NAME                CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                        STORAGECLASS   REASON   AGE
mysql-instance-pv   1Gi        RWO            Retain           Bound    default/mysql-instance-pvc   standard                5m13s

$ kubectl get pvc
NAME                 STATUS   VOLUME              CAPACITY   ACCESS MODES   STORAGECLASS   AGE
mysql-instance-pvc   Bound    mysql-instance-pv   1Gi        RWO            standard       5m19s

$ kubectl get pod
NAME                              READY   STATUS    RESTARTS   AGE
mysql-instance-6d64c5596f-lfz4r   1/1     Running   0          5m26s
mysql-operator-68b4cf86d-hnrvc    1/1     Running   0          7m45s\
```

- **–£–¥–∞–ª–µ–Ω–∏–µ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ —Ä–µ—Å—É—Ä—Å–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ—á–∏—Å—Ç–∫–∏**

```bash
$ kubectl delete -f MySQL.yaml 
mysql.otus.homework "mysql-instance" deleted

$ kubectl get deployments
NAME             READY   UP-TO-DATE   AVAILABLE   AGE
mysql-operator   1/1     1            1           10m

$ kubectl get service
NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
kubernetes   ClusterIP   10.96.0.1    <none>        443/TCP   13m

$ kubectl get pv
No resources found

$ kubectl get pvc
No resources found in default namespace.
```
### 2. –ò–∑–º–µ–Ω–µ–Ω –º–∞–Ω–∏—Ñ–µ—Å—Ç `ClusterRole`, –¥–ª—è –æ–ø–∏—Å–∞–Ω–∏—è –≤ –Ω–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –Ω–∞–±–æ—Ä–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–ª—è –Ω–∞—à–µ–≥–æ CRD.

**–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –º–∞–Ω–∏—Ñ–µ—Å—Ç ClusterRole —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º –Ω–∞–±–æ—Ä–æ–º –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞:**

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: mysql-operator
rules:
  - apiGroups:
      - "otus.homework"
    resources:
      - mysqls
      - mysqls/status
    verbs:
      - get
      - list
      - watch
      - create
      - update
      - patch
      - delete
  - apiGroups:
      - ""
    resources:
      - pods              # –¥–∞–Ω–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–æ–±–∞–≤–ª–µ–Ω –¥–ª—è –¥–ª—è –Ω–∞–±–ª—é–¥–µ–Ω–∏—è –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ —Ä–µ—Å—É—Ä—Å–æ–≤ (—Å–æ–∑–¥–∞–Ω–∏–µ, —É–¥–∞–ª–µ–Ω–∏–µ, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ). –ò–Ω–∞—á–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å —Ä–µ—Å—É—Ä—Å—ã —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ.
      - events
      - pods/status        
      - services          # –¥–∞–Ω–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–æ–±–∞–≤–ª–µ–Ω –¥–ª—è –¥–ª—è –Ω–∞–±–ª—é–¥–µ–Ω–∏—è –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ —Ä–µ—Å—É—Ä—Å–æ–≤ (—Å–æ–∑–¥–∞–Ω–∏–µ, —É–¥–∞–ª–µ–Ω–∏–µ, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ). –ò–Ω–∞—á–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å —Ä–µ—Å—É—Ä—Å—ã —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ.
      - persistentvolumeclaims
      - persistentvolumes # –µ—Å–ª–∏ PV –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å
    verbs:
      - get
      - list
      - watch
      - create
      - update
      - patch
      - delete
  - apiGroups:
      - "apps"
    resources:
      - deployments      # –¥–∞–Ω–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–æ–±–∞–≤–ª–µ–Ω –¥–ª—è –¥–ª—è –Ω–∞–±–ª—é–¥–µ–Ω–∏—è –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ —Ä–µ—Å—É—Ä—Å–æ–≤ (—Å–æ–∑–¥–∞–Ω–∏–µ, —É–¥–∞–ª–µ–Ω–∏–µ, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ). –ò–Ω–∞—á–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å —Ä–µ—Å—É—Ä—Å—ã —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ.
      - deployments/status
    verbs:
      - get
      - list
      - watch
      - create
      - update
      - patch
      - delete
```

**–ü–æ—è—Å–Ω–µ–Ω–∏–µ:**

**2.1 –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–º CRD (`MySQL`):**

   - **apiGroups:** `otus.homework`
   - **resources:** `mysqls` , `mysqls/status`
   - **verbs:** `get`, `list`, `watch`, `create`, `update`, `patch`, `delete`

   –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä—É —É–ø—Ä–∞–≤–ª—è—Ç—å —Å–≤–æ–∏–º–∏ –∫–∞—Å—Ç–æ–º–Ω—ã–º–∏ —Ä–µ—Å—É—Ä—Å–∞–º–∏ `MySQL`, –≤–∫–ª—é—á–∞—è –∏—Ö —Å–æ–∑–¥–∞–Ω–∏–µ, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏ —É–¥–∞–ª–µ–Ω–∏–µ.

**2.2 –°–æ–∑–¥–∞–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Deployment:**

   - **apiGroups:** `apps`
   - **resources:** `deployments` , `deployments/status`
   - **verbs:** `get`, `list`, `watch`, `create`, `update`, `patch`, `delete`

   –û–ø–µ—Ä–∞—Ç–æ—Ä —Å–æ–∑–¥–∞–µ—Ç Deployment –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ MySQL, –ø–æ—ç—Ç–æ–º—É –µ–º—É –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã —ç—Ç–∏ –ø—Ä–∞–≤–∞.

**2.3 –°–æ–∑–¥–∞–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Service –∏ PersistentVolumeClaim (PVC):**

   - **apiGroups:** `""` (core API group)
   - **resources:** `services`, `persistentvolumeclaims` , `pods` , `events` , `pods/status` , `persistentvolumes`
   - **verbs:** `get`, `list`, `watch`, `create`, `update`, `patch`, `delete`



**–ü—Ä–æ–≤–µ—Ä—è–µ–º**

```bash
kubectl apply -f CR_MySQL.yaml

kubectl apply -f CRB_MySQL.yaml
   ```

**–°–º–æ—Ç—Ä–∏–º –ª–æ–≥ –ø–æ–¥–∞ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ —Ä–µ—Å—É—Ä—Å–∞**

```bash
$ kubectl logs mysql-instance-6d64c5596f-fs6dm
2024-10-01 13:00:24+00:00 [Note] [Entrypoint]: Entrypoint script for MySQL Server 5.7.44-1.el7 started.
2024-10-01 13:00:24+00:00 [Note] [Entrypoint]: Switching to dedicated user 'mysql'
2024-10-01 13:00:24+00:00 [Note] [Entrypoint]: Entrypoint script for MySQL Server 5.7.44-1.el7 started.
'/var/lib/mysql/mysql.sock' -> '/var/run/mysqld/mysqld.sock'
2024-10-01T13:00:24.846002Z 0 [Warning] TIMESTAMP with implicit DEFAULT value is deprecated. Please use --explicit_defaults_for_timestamp server option (see documentation for more details).
2024-10-01T13:00:24.846830Z 0 [Note] mysqld (mysqld 5.7.44) starting as process 1 ...
2024-10-01T13:00:24.849048Z 0 [Note] InnoDB: PUNCH HOLE support available
2024-10-01T13:00:24.849061Z 0 [Note] InnoDB: Mutexes and rw_locks use GCC atomic builtins
2024-10-01T13:00:24.849064Z 0 [Note] InnoDB: Uses event mutexes
2024-10-01T13:00:24.849066Z 0 [Note] InnoDB: GCC builtin __atomic_thread_fence() is used for memory barrier
2024-10-01T13:00:24.849068Z 0 [Note] InnoDB: Compressed tables use zlib 1.2.13
2024-10-01T13:00:24.849070Z 0 [Note] InnoDB: Using Linux native AIO
2024-10-01T13:00:24.849248Z 0 [Note] InnoDB: Number of pools: 1
2024-10-01T13:00:24.849334Z 0 [Note] InnoDB: Using CPU crc32 instructions
2024-10-01T13:00:24.850284Z 0 [Note] InnoDB: Initializing buffer pool, total size = 128M, instances = 1, chunk size = 128M
2024-10-01T13:00:24.855467Z 0 [Note] InnoDB: Completed initialization of buffer pool

...

```
### 3. –°–æ–∑–¥–∞–Ω —Å–≤–æ–π –æ–ø–µ—Ä–∞—Ç–æ—Ä, –∫–æ—Ç–æ—Ä—ã–π —Ä–µ–∞–ª–∏–∑–æ–≤—ã–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—è—é—â–∏–π —É—Å–ª–æ–≤–∏—è–º –î–ó.

- –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –æ–±—ä–µ–∫—Ç–∞ `MySQL` –æ–ø–µ—Ä–∞—Ç–æ—Ä –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å:
  - Deployment —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º –æ–±—Ä–∞–∑–æ–º MySQL.
  - Service —Ç–∏–ø–∞ `ClusterIP`.
  - PersistentVolume (PV) –∏ PersistentVolumeClaim (PVC) —Å –∑–∞–¥–∞–Ω–Ω—ã–º —Ä–∞–∑–º–µ—Ä–æ–º –∏ `StorageClass`.
- –ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –æ–±—ä–µ–∫—Ç–∞ `MySQL` –æ–ø–µ—Ä–∞—Ç–æ—Ä –±—É–¥–µ—Ç —É–¥–∞–ª—è—Ç—å —Å–æ–∑–¥–∞–Ω–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã.

---

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Operator SDK

1. **–£—Å—Ç–∞–Ω–æ–≤–∫–∞ `Go` (–Ω–µ–æ–±—Ö–æ–¥–∏–º –¥–ª—è Operator SDK):**

```bash
wget https://golang.org/dl/go1.17.6.linux-amd64.tar.gz
sudo tar -C /usr/local -xzf go1.17.6.linux-amd64.tar.gz
export PATH=$PATH:/usr/local/go/bin
```

2. **–£—Å—Ç–∞–Ω–æ–≤–∫–∞ `Operator SDK`:**

```bash
curl -LO https://github.com/operator-framework/operator-sdk/releases/download/v1.15.0/operator-sdk_linux_amd64
chmod +x operator-sdk_linux_amd64
sudo mv operator-sdk_linux_amd64 /usr/local/bin/operator-sdk
```

3.   **–ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏:**

```bash
operator-sdk version
```

---

### –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞

1. **–°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –Ω–µ–µ:**

```bash
mkdir mysql-operator
cd mysql-operator
```

2. **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–æ–≤—ã–π `Ansible-–æ–ø–µ—Ä–∞—Ç–æ—Ä`:**

```bash
operator-sdk init --plugins=ansible --domain=otus.homework 
```

---

### –°–æ–∑–¥–∞–Ω–∏–µ API –∏ CRD

1. **–°–æ–∑–¥–∞–π—Ç–µ API –¥–ª—è —Ä–µ—Å—É—Ä—Å–∞ `MySQL`:**

```bash
operator-sdk create api --group=otus.homework --version=v1 --kind=MySQL --generate-role
```

  –≠—Ç–æ —Å–æ–∑–¥–∞—Å—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–∞—Ç–∞–ª–æ–≥–æ–≤ –∏ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –≤–∞—à–µ–≥–æ CRD –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö Ansible-—Ä–æ–ª–µ–π.

2. **–û–±–Ω–æ–≤–ª–µ–Ω CRD —Å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º–∏ –ø–æ–ª—è–º–∏ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π. –§–∞–π–ª `config/crd/bases/mysql.otus.homework_mysqls.yaml`.**

```yaml
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: mysqls.mysql.otus.homework
spec:
  group: mysql.otus.homework
  names:
    kind: MySQL
    listKind: MySQLList
    plural: mysqls
    singular: mysql
  scope: Namespaced
  versions:
    - name: v1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              required:
                - image
                - database
                - password
                - storage_size
                - storageClassName
              properties:
                image:
                  type: string
                database:
                  type: string
                password:
                  type: string
                storage_size:
                  type: string
                storageClassName:
                  type: string
      subresources:
        status: {}
```
---

### –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ Ansible-—Ä–æ–ª–µ–π

1. **–ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Ä–æ–ª–∏:**

```bash
cd roles/mysql
```

2. **–†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Ñ–∞–π–ª `tasks/main.yml`, —á—Ç–æ–±—ã –æ–ø–∏—Å–∞—Ç—å –ª–æ–≥–∏–∫—É —Å–æ–∑–¥–∞–Ω–∏—è –∏ —É–¥–∞–ª–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤.**

   **–°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ `tasks/main.yml`:**

```yaml
---

- name: Print available variables
  debug:
    var: vars

- name: Check if resource is being deleted
  when: meta.deletionTimestamp is defined
  include_tasks: "../handlers/main.yml"

- name: Exit if resource is being deleted and skip further tasks
  when: meta.deletionTimestamp is defined
  debug:
    msg: "Resource is being deleted"
  vars:
    ansible_skip_tasks: true

# +kubebuilder:permissions:verbs=create;update;delete;get;list;watch,resources=persistentvolumeclaims
- name: Create PVC
  k8s:
    state: present
    definition:
      apiVersion: v1
      kind: PersistentVolumeClaim
      metadata:
        name: "{{ meta.name }}-pvc"
        namespace: "{{ meta.namespace }}"
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: "{{ spec.storage_size }}"
        storageClassName: "{{ spec.storageClassName }}"

- name: Create Deployment
  k8s:
    state: present
    definition:
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: "{{ meta.name }}"
        namespace: "{{ meta.namespace }}"
      spec:
        replicas: 1
        selector:
          matchLabels:
            app: "{{ meta.name }}"
        template:
          metadata:
            labels:
              app: "{{ meta.name }}"
          spec:
            containers:
              - name: mysql
                image: "{{ spec.image }}"
                env:
                  - name: MYSQL_DATABASE
                    value: "{{ spec.database }}"
                  - name: MYSQL_ROOT_PASSWORD
                    value: "{{ spec.password }}"
                ports:
                  - containerPort: 3306
                volumeMounts:
                  - name: mysql-storage
                    mountPath: /var/lib/mysql
            volumes:
              - name: mysql-storage
                persistentVolumeClaim:
                  claimName: "{{ meta.name }}-pvc"

- name: Create Service
  k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Service
      metadata:
        name: "{{ meta.name }}"
        namespace: "{{ meta.namespace }}"
      spec:
        type: ClusterIP
        selector:
          app: "{{ meta.name }}"
        ports:
          - protocol: TCP
            port: 3306
            targetPort: 3306

```

   **–£–¥–∞–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ CR:**

   Ansible –æ–ø–µ—Ä–∞—Ç–æ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ —Ä–µ—Å—É—Ä—Å–∞, –µ—Å–ª–∏ –≤—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ `k8s` –º–æ–¥—É–ª—å —Å `state: absent`. –û–¥–Ω–∞–∫–æ –≤ –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ, –ø–æ—Å–∫–æ–ª—å–∫—É –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º `state: present`, –Ω–∞–º –Ω—É–∂–Ω–æ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —É–¥–∞–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

   **–î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª `handlers/main.yml`:**

```yaml
---

- name: Delete Deployment
  k8s:
    state: absent
    kind: Deployment
    name: "{{ meta.name }}"
    namespace: "{{ meta.namespace }}"

- name: Delete Service
  k8s:
    state: absent
    kind: Service
    name: "{{ meta.name }}"
    namespace: "{{ meta.namespace }}"

- name: Delete PVC
  k8s:
    state: absent
    kind: PersistentVolumeClaim
    name: "{{ meta.name }}-pvc"
    namespace: "{{ meta.namespace }}"

```

**–°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ `./watches.yaml` (–ß—Ç–æ–±—ã —É–ø—Ä–æ—Å—Ç–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º –∏–∑ metadata –∏ spec, —è–≤–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ `meta` –∏ `spec` –≤ —Ñ–∞–π–ª–µ watches.yaml):**

```yaml
---
# Use the 'create api' subcommand to add watches to this file.
- version: v1
  group: mysql.otus.homework
  kind: MySQL
  role: mysql
  vars:
    meta: "{{ _mysql_otus_homework_mysql.metadata }}"
    spec: "{{ _mysql_otus_homework_mysql.spec }}"
#+kubebuilder:scaffold:watch
```

### –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ (RBAC)

1. **–û–±–Ω–æ–≤–∏—Ç–µ —Ñ–∞–π–ª `config/rbac/role.yaml` —Å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏:**

```yaml
   apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: manager-role
rules:
  - apiGroups:
      - ""
    resources:
      - pods
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - ""
    resources:
      - persistentvolumeclaims
      - services
    verbs:
      - get
      - list
      - watch
      - create
      - update
      - patch
      - delete
  - apiGroups:
      - apps
    resources:
      - deployments
    verbs:
      - get
      - list
      - watch
      - create
      - update
      - patch
      - delete
```
---

### –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞

1. **–°–æ–±–∏—Ä–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–Ω—ã–π –æ–±—Ä–∞–∑ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞:**

   –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–∞–π–ª `Makefile`, —É–∫–∞–∑–∞–≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:

```makefile
IMG=<your-dockerhub-username>/mysql-operator:latest
```

   –°—Ç—Ä–æ–∏–º –æ–±—Ä–∞–∑:

```bash
make docker-build docker-push IMG=<your-dockerhub-username>/mysql-operator:latest
```

2. **–†–∞–∑–≤–µ—Ä–Ω–∏—Ç–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä –≤ –∫–ª–∞—Å—Ç–µ—Ä (—Å–µ—Ä–≤–∏—Å `k8s` –æ—Ç `YC`):**

```bash
$ make deploy IMG=skyfly534/mysql-operator:01.10.6
cd config/manager && /home/roman/Infr_k8s/skyfly535_repo/kubernetes-operators/mysql-operator/bin/kustomize edit set image controller=skyfly534/mysql-operator:01.10.6
/home/roman/Infr_k8s/skyfly535_repo/kubernetes-operators/mysql-operator/bin/kustomize build config/default | kubectl apply -f -
namespace/mysql-operator-system created
customresourcedefinition.apiextensions.k8s.io/mysqls.mysql.otus.homework created
serviceaccount/mysql-operator-controller-manager created
role.rbac.authorization.k8s.io/mysql-operator-leader-election-role created
clusterrole.rbac.authorization.k8s.io/mysql-operator-manager-role created
clusterrole.rbac.authorization.k8s.io/mysql-operator-metrics-reader created
clusterrole.rbac.authorization.k8s.io/mysql-operator-proxy-role created
rolebinding.rbac.authorization.k8s.io/mysql-operator-leader-election-rolebinding created
clusterrolebinding.rbac.authorization.k8s.io/mysql-operator-manager-rolebinding created
clusterrolebinding.rbac.authorization.k8s.io/mysql-operator-proxy-rolebinding created
configmap/mysql-operator-manager-config created
service/mysql-operator-controller-manager-metrics-service created
deployment.apps/mysql-operator-controller-manager created

$ kubectl logs deployment/mysql-operator-controller-manager -n mysql-operator-system -c manager
{"level":"info","ts":1727791527.5388258,"logger":"cmd","msg":"Version","Go Version":"go1.16.13","GOOS":"linux","GOARCH":"amd64","ansible-operator":"v1.15.0","commit":"f6326e832a8a5e5453d0ad25e86714a0de2c0fc8"}
{"level":"info","ts":1727791527.539148,"logger":"cmd","msg":"Watch namespaces not configured by environment variable WATCH_NAMESPACE or file. Watching all namespaces.","Namespace":""}
{"level":"info","ts":1727791527.5794044,"logger":"controller-runtime.metrics","msg":"metrics server is starting to listen","addr":"127.0.0.1:8080"}
{"level":"info","ts":1727791527.5800602,"logger":"watches","msg":"Environment variable not set; using default value","envVar":"ANSIBLE_VERBOSITY_MYSQL_MYSQL_OTUS_HOMEWORK","default":2}
{"level":"info","ts":1727791527.5801437,"logger":"cmd","msg":"Environment variable not set; using default value","Namespace":"","envVar":"ANSIBLE_DEBUG_LOGS","ANSIBLE_DEBUG_LOGS":false}
{"level":"info","ts":1727791527.5801656,"logger":"ansible-controller","msg":"Watching resource","Options.Group":"mysql.otus.homework","Options.Version":"v1","Options.Kind":"MySQL"}
{"level":"info","ts":1727791527.5818841,"logger":"proxy","msg":"Starting to serve","Address":"127.0.0.1:8888"}
I1001 14:05:27.582040       7 leaderelection.go:248] attempting to acquire leader lease mysql-operator-system/mysql-operator...
{"level":"info","ts":1727791527.5821953,"msg":"starting metrics server","path":"/metrics"}
```

**–û–±—Ä–∞–∑ –≤ –º–æ–µ–π —Ä–µ–ø–µ Docker Hub**

### skyfly534/mysql-operator:01.10.6
---

### –°–æ–∑–¥–∞–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ MySQL

1. **–°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª `config/samples/otus.homework_v1_mysql.yaml`:**

   ```yaml
   apiVersion: otus.homework/v1
   kind: MySQL
   metadata:
     name: mysql-instance
     namespace: default
   spec:
     image: mysql:5.7
     database: mydb
     password: mypassword
     storage_size: 1Gi
     storageClassName: yc-network-hdd
   ```

2. **–ü—Ä–∏–º–µ–Ω—è–µ–º –º–∞–Ω–∏—Ñ–µ—Å—Ç:**

```bash
kubectl apply -f config/samples/mysql_v1_mysql.yaml
```

---

### –ü—Ä–æ–≤–µ—Ä—è–µ–º

```bash
$ kubectl get pods -n default
NAME                             READY   STATUS     RESTARTS      AGE
mysql-instance-5fd67b867-w6dr5   1/1     Running    0             70s

$ kubectl get services
NAME             TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)    AGE
kubernetes       ClusterIP   10.96.128.1    <none>        443/TCP    80m
mysql-instance   ClusterIP   10.96.144.83   <none>        3306/TCP   105s

$ kubectl get pvc
NAME                 STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS     AGE
mysql-instance-pvc   Bound    pvc-647c2ea0-3f69-4302-9093-0c7a5e05024e   2Gi        RWO            yc-network-hdd   115s
```
  
–ú–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –æ–ø–µ—Ä–∞—Ç–æ—Ä –¥–ª—è —Ä–∞–±–æ—Ç—ã –≤ –∫–ª–∞—Å—Ç–µ—Ä–Ω–æ–º —Ä–µ–∂–∏–º–µ, –∏–∑–º–µ–Ω–∏–≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ `config/manager/manager.yaml`.

---

# HW6 –®–∞–±–ª–æ–Ω–∏–∑–∞—Ü–∏—è –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Helm. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ community Helm charts.

## –í –ø—Ä–æ—Ü–µ—Å—Å–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –î–ó –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è:

### 1. –°–æ–∑–¥–∞–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞-–∑–∞–≥–æ—Ç–æ–≤–∫–∞ –¥–ª—è –Ω–æ–≤–æ–≥–æ `Helm chart`, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ–º–∞–Ω–¥–∞ `helm create`. 

```bash
helm create homework-app-chart
Creating homework-app-chart
```

–≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—ë—Ç –±–∞–∑–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ñ–∞–π–ª–æ–≤ –∏ –ø–∞–ø–æ–∫, –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–ª—è Helm chart.

Helm —Å–æ–∑–¥–∞—Å—Ç –ø–∞–ø–∫—É —Å –∏–º–µ–Ω–µ–º `homework-app-chart` (–∏–ª–∏ –¥—Ä—É–≥–∏–º –∏–º–µ–Ω–µ–º, —É–∫–∞–∑–∞–Ω–Ω—ã–º –≤–∞–º–∏) –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç –µ—ë —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π:

```
homework-app-chart/
  Chart.yaml          # –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏ —á–∞—Ä—Ç–∞ (–Ω–∞–∑–≤–∞–Ω–∏–µ, –≤–µ—Ä—Å–∏—è –∏ —Ç.–¥.)
  values.yaml         # –§–∞–π–ª —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –¥–ª—è —à–∞–±–ª–æ–Ω–æ–≤
  charts/             # –ü–∞–ø–∫–∞ –¥–ª—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π —á–∞—Ä—Ç–∞ (–¥—Ä—É–≥–∏—Ö Helm charts)
  templates/          # –ü–∞–ø–∫–∞ –¥–ª—è –≤—Å–µ—Ö Kubernetes –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤ –≤ –≤–∏–¥–µ —à–∞–±–ª–æ–Ω–æ–≤ (deployment.yaml, service.yaml –∏ —Ç.–¥.)
  .helmignore         # –§–∞–π–ª, —É–∫–∞–∑—ã–≤–∞—é—â–∏–π, –∫–∞–∫–∏–µ —Ñ–∞–π–ª—ã –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞—Ä—Ö–∏–≤–∞ —á–∞—Ä—Ç–∞
```

### –û–ø–∏—Å–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤:
- **Chart.yaml**: –°–æ–¥–µ—Ä–∂–∏—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —á–∞—Ä—Ç–∞, —Ç–∞–∫–∏–µ –∫–∞–∫ –∏–º—è, –≤–µ—Ä—Å–∏—è, –æ–ø–∏—Å–∞–Ω–∏–µ –∏ —Ç.–¥.
- **values.yaml**: –°–æ–¥–µ—Ä–∂–∏—Ç –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ —á–∞—Ä—Ç–∞.
- **templates/**: –°–æ–¥–µ—Ä–∂–∏—Ç —Ñ–∞–π–ª—ã —à–∞–±–ª–æ–Ω–æ–≤ Kubernetes-—Ä–µ—Å—É—Ä—Å–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, Deployment, Service, ConfigMap –∏ –¥—Ä—É–≥–∏–µ).
- **charts/**: –≠—Ç–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —É–∫–∞–∑–∞–Ω–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π, —Ç–æ –µ—Å—Ç—å –¥—Ä—É–≥–∏—Ö —á–∞—Ä—Ç–æ–≤, –æ—Ç –∫–æ—Ç–æ—Ä—ã—Ö –∑–∞–≤–∏—Å–∏—Ç —Ç–µ–∫—É—â–∏–π —á–∞—Ä—Ç.
- **.helmignore**: –°–æ–¥–µ—Ä–∂–∏—Ç —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∏—Å–∫–ª—é—á–µ–Ω—ã –∏–∑ –ø–∞–∫–µ—Ç–∞ —á–∞—Ä—Ç–∞ –ø—Ä–∏ –µ–≥–æ —Å–±–æ—Ä–∫–µ.

–î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ —Ñ–∞–π–ª—ã

```bash
./kubernetes-templating/homework-app-chart/templates$ touch configmap.yaml pvc.yaml storageclass.yaml

./kubernetes-templating/homework-app-chart$ tree
.
‚îú‚îÄ‚îÄ charts
‚îú‚îÄ‚îÄ Chart.yaml
‚îú‚îÄ‚îÄ templates
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ configmap.yaml
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ deployment.yaml
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ _helpers.tpl
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ hpa.yaml
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ ingress.yaml
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ NOTES.txt
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ pvc.yaml
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ service.yaml
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ storageclass.yaml
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ tests
‚îÇ¬†¬†     ‚îî‚îÄ‚îÄ test-connection.yaml
‚îî‚îÄ‚îÄ values.yaml
```
---
### 2. –ü–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –î–ó. –°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª `values.yaml`c–æ–¥–µ—Ä–∂–∞—â–∏–π –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ —á–∞—Ä—Ç–∞.

–ß–∞—Ä—Ç –≤–∫–ª—é—á–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–∞—Ü–∏—é –∫–ª—é—á–µ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π, –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤–∫–ª—é—á–µ–Ω–∏—è/–æ—Ç–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–æ–±, –≤–∫–ª—é—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏, –∞ —Ç–∞–∫–∂–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç `Redis` –∏–∑ community-—á–∞—Ä—Ç–æ–≤.
---

### **Chart.yaml**

```yaml
apiVersion: v2
name: homework-app
description: Helm-—á–∞—Ä—Ç –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Homework
type: application
version: 0.1.0
appVersion: "1.0"
dependencies:    #–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç Redis
  - name: redis
    version: ">=14.8.12"
    repository: "https://charts.bitnami.com/bitnami"
```

---

### **values.yaml**

```yaml
replicaCount: 3

image:
  repository: nginx
  tag: alpine
  pullPolicy: IfNotPresent

imagePullSecrets: []

nameOverride: ""
fullnameOverride: ""

podAnnotations: {}
podSecurityContext: {}
securityContext: {}

service:
  type: ClusterIP
  port: 80

ingress:
  enabled: true
  className: ""
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /index.html
  hosts:
    - host: homework.otus
      paths:
        - path: /index.html
          pathType: Prefix
        - path: /homepage
          pathType: Prefix
  tls: []

metricsIngress:
  enabled: true
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /metrics.html
  hosts:
    - host: homework.otus
      paths:
        - path: /metrics
          pathType: Exact
  tls: []

resources: {}

autoscaling:
  enabled: false

nodeSelector: 
  homework: "true"

tolerations: []

affinity: {}

message: "Hello, OTUS! Homework 6! PVC Text."

readinessProbe:
  enabled: true
  initialDelaySeconds: 5
  periodSeconds: 10
  exec:
    command:
      - cat
      - /homework/index.html

livenessProbe:
  enabled: false

persistence:
  enabled: true
  storageClass: my-storage-class
  accessModes:
    - ReadWriteOnce
  size: 1Gi

configMap:
  name: my-config
  data:
    text: "Hello, OTUS! Homework 6! ConfigMap Text."

redis:
  enabled: true

storageClass:
  enabled: true
  name: my-storage-class
  provisioner: k8s.io/minikube-hostpath
  reclaimPolicy: Retain
  volumeBindingMode: Immediate
```

---
### 3. –ü—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–æ –¥–∞–ª—å–Ω–µ–π—à–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —á–∞—Ä—Ç–∞ —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—è—é—â–µ–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –î–ó.

### **templates/_helpers.tpl**

–≠—Ç–æ —à–∞–±–ª–æ–Ω–Ω—ã–π —Ñ–∞–π–ª Helm, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è `–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–º—ë–Ω` –æ–±—ä–µ–∫—Ç–æ–≤ Kubernetes (—Ç–∞–∫–∏—Ö –∫–∞–∫ Deployment, Service –∏ —Ç.–¥.) –∏ –¥—Ä—É–≥–∏—Ö –≤–∞–∂–Ω—ã—Ö –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ —á–∞—Ä—Ç–∞. –û–Ω –ø–æ–∑–≤–æ–ª—è–µ—Ç –≥–∏–±–∫–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –Ω–∞–∑–≤–∞–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –∏ –∏—Ö –≤–µ—Ä—Å–∏–π, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ —Å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ —Ä–µ—Å—É—Ä—Å–∞–º–∏, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å, –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç—å –∏ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å.

```yaml
{{/*
–ó–∞–¥–∞–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –º–µ—Ç–∫–∏ –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
*/}}
{{- define "homework-app.labels" -}}
app.kubernetes.io/name: {{ include "homework-app.name" . }}
app.kubernetes.io/instance: {{ .Release.Name }}
app.kubernetes.io/version: {{ .Chart.AppVersion }}
app.kubernetes.io/managed-by: {{ .Release.Service }}
{{- end -}}

{{/*
–ó–∞–¥–∞–µ—Ç –∏–º—è –¥–ª—è ServiceAccount
*/}}
{{- define "homework-app.serviceAccountName" -}}
{{- if .Values.serviceAccount.name }}
  {{- .Values.serviceAccount.name }}
{{- else }}
  {{ include "homework-app.fullname" . }}-sa
{{- end -}}
{{- end -}}

{{/*
–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏–º–µ–Ω–∏ —á–∞—Ä—Ç–∞ (homework-app.name)
*/}}
{{- define "homework-app.name" -}}
{{- default .Chart.Name .Values.nameOverride | trunc 63 | trimSuffix "-" -}}
{{- end -}}

{{/*
–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ –∏–º–µ–Ω–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (homework-app.fullname)
*/}}
{{- define "homework-app.fullname" -}}
{{- $name := default .Chart.Name .Values.nameOverride -}}
{{- if .Values.fullnameOverride -}}
{{- .Values.fullnameOverride | trunc 63 | trimSuffix "-" -}}
{{- else -}}
{{- printf "%s-%s" .Release.Name $name | trunc 63 | trimSuffix "-" -}}
{{- end -}}
{{- end -}}

{{/*
–í–∫–ª—é—á–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏ —á–∞—Ä—Ç–∞ (homework-app.chart)
*/}}
{{- define "homework-app.chart" -}}
{{- printf "%s-%s" .Chart.Name .Chart.Version -}}
{{- end -}}
```
---

### **templates/NOTES.txt**

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ `templates/NOTES.txt` –≤ Helm

–≠—Ç–æ—Ç —Ñ–∞–π–ª Helm-—á–∞—Ä—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –≤–∞–∂–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –≠—Ç–æ—Ç —Ñ–∞–π–ª –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã–≤–æ–¥–∏—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –ø–æ–ª–µ–∑–Ω—ã–º–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏ –∏–ª–∏ —Å—Å—ã–ª–∫–∞–º–∏, —á—Ç–æ –¥–µ–ª–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –±–æ–ª–µ–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–º –∏ —É–¥–æ–±–Ω—ã–º –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

### –û–ø–∏—Å–∞–Ω–∏–µ —Ñ–∞–π–ª `NOTES.txt`:

1. **–í—ã–≤–æ–¥ –ø–æ–ª–µ–∑–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è**: –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ Kubernetes, Helm –≤—ã–≤–æ–¥–∏—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ `NOTES.txt` –≤ –∫–æ–Ω—Å–æ–ª—å. –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –æ —Ç–æ–º, –∫–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é, –ø—Ä–æ–≤–µ—Ä–∫–∞ –µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–ª–∏ –¥–∞–ª—å–Ω–µ–π—à–∏–µ —à–∞–≥–∏ –¥–ª—è –µ–≥–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.
  
2. **–ì–∏–±–∫–æ—Å—Ç—å –¥–ª—è –≤—ã–≤–æ–¥–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏**: –¢–∞–∫ –∫–∞–∫ Helm –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —à–∞–±–ª–æ–Ω—ã, –º–æ–∂–Ω–æ –≤—ã–≤–æ–¥–∏—Ç—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –∑–∞–≤–∏—Å—è—â—É—é –æ—Ç –∑–Ω–∞—á–µ–Ω–∏–π –≤ `values.yaml`. –ù–∞–ø—Ä–∏–º–µ—Ä, URL –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é —á–µ—Ä–µ–∑ Ingress, –∫–æ—Ç–æ—Ä—ã–π –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤–∫–ª—é—á—ë–Ω–Ω–æ–≥–æ –∏–ª–∏ –æ—Ç–∫–ª—é—á—ë–Ω–Ω–æ–≥–æ Ingress –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö —Ö–æ—Å—Ç–æ–≤.

3. **–£–ª—É—á—à–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–ø—ã—Ç–∞**: –≠—Ç–æ—Ç —Ñ–∞–π–ª –ø–æ–∑–≤–æ–ª—è–µ—Ç —É–ª—É—á—à–∏—Ç—å –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏–≤ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä—É—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±—ã—á–Ω–æ –∏—â–µ—Ç –ø–æ—Å–ª–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, URL –¥–ª—è –¥–æ—Å—Ç—É–ø–∞, –ø–æ—Ä—Ç—ã, —Å—Ç–∞—Ç—É—Å –∏ —Ç.–¥.).

---

#### –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
- –í—ã–≤–æ–¥ –ø–æ–ª–µ–∑–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —á–∞—Ä—Ç–∞.
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –≤—ã–≤–æ–¥–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏–∑ `values.yaml`.
- –£–ª—É—á—à–µ–Ω–∏–µ —É–¥–æ–±—Å—Ç–≤–∞ –∏ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ –¥–µ–ø–ª–æ—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

–ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –∏–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –∫–∞–∫–æ–≥–æ-–ª–∏–±–æ –∞—Å–ø–µ–∫—Ç–∞, –¥–∞–π—Ç–µ –∑–Ω–∞—Ç—å!

```
1. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ!

–í—ã –º–æ–∂–µ—Ç–µ –ø–æ–ª—É—á–∏—Ç—å –∫ –Ω–µ–º—É –¥–æ—Å—Ç—É–ø –ø–æ —Å–ª–µ–¥—É—é—â–µ–º—É URL:

{{- if and .Values.ingress.enabled .Values.ingress.hosts }}
{{ range .Values.ingress.hosts }}
  http{{ if $.Values.ingress.tls }}s{{ end }}://{{ .host }}{{ (index .paths 0).path }}
{{- end }}
{{- else }}
  –ü–†–ò–ú–ï–ß–ê–ù–ò–ï: Ingress –æ—Ç–∫–ª—é—á–µ–Ω –∏–ª–∏ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã —Ö–æ—Å—Ç—ã.
{{- end }}
```

---

### **–ü–æ—è—Å–Ω–µ–Ω–∏–µ**

- **–ü–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–∞—Ü–∏—è**: –í—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, —Ç–∞–∫–∏–µ –∫–∞–∫ –∏–º–µ–Ω–∞ –æ–±—ä–µ–∫—Ç–æ–≤, –∏–º–µ–Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤, –æ–±—Ä–∞–∑—ã, —Ö–æ—Å—Ç—ã, –ø–æ—Ä—Ç—ã, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–ø–ª–∏–∫, —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è index.html –∏ nodeSelector –∑–∞–¥–∞–Ω—ã –∫–∞–∫ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ —à–∞–±–ª–æ–Ω–∞—Ö. –í—ã –º–æ–∂–µ—Ç–µ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∏—Ö —á–µ—Ä–µ–∑ `values.yaml` –∏–ª–∏ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∏—Ö, –∏—Å–ø–æ–ª—å–∑—É—è –ø–∞—Ä–∞–º–µ—Ç—Ä—ã `--set` –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ —Ä–µ–ª–∏–∑–∞.

- **–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∏ —Ç–µ–≥ –æ–±—Ä–∞–∑–∞**: –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∏ —Ç–µ–≥ –æ–±—Ä–∞–∑–∞ –∑–∞–¥–∞–Ω—ã –æ—Ç–¥–µ–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ (`image.repository` –∏ `image.tag` –≤ `values.yaml`).

- **–í–∫–ª—é—á–µ–Ω–∏–µ/–û—Ç–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ–±**: –ú–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å –∏–ª–∏ –æ—Ç–∫–ª—é—á–∏—Ç—å readiness –∏ liveness –ø—Ä–æ–±—ã, –∏—Å–ø–æ–ª—å–∑—É—è —Ñ–ª–∞–≥–∏ `readinessProbe.enabled` –∏ `livenessProbe.enabled` –≤ `values.yaml`.

- **–°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏**: –ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ä–µ–ª–∏–∑–∞ –≤—ã–≤–æ–¥–∏—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ, –æ—Ç–æ–±—Ä–∞–∂–∞—é—â–µ–µ –∞–¥—Ä–µ—Å, –ø–æ –∫–æ—Ç–æ—Ä–æ–º—É –º–æ–∂–Ω–æ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–∏—Å—É. –≠—Ç–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è —à–∞–±–ª–æ–Ω–æ–º `NOTES.txt`.

- **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å**: –ß–∞—Ä—Ç –≤–∫–ª—é—á–∞–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç Redis, –∫–æ—Ç–æ—Ä–∞—è —É–∫–∞–∑–∞–Ω–∞ –≤ `Chart.yaml` –∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤–∫–ª—é—á–µ–Ω–∞ –∏–ª–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∞ —á–µ—Ä–µ–∑ `values.yaml`.

---

### **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π**

–ü–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π —á–∞—Ä—Ç–∞ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –æ–±–Ω–æ–≤–∏–ª–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:

```bash
helm dependency update ./homework-app
```

### **–ü—Ä–æ–≤–µ—Ä–∫–∞**

–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —á–∞—Ä—Ç —Å –∏–º–µ–Ω–µ–º —Ä–µ–ª–∏–∑–∞ `otusi-dev-release`:

```bash
/kubernetes-templating$ helm install otusi-dev-release ./homework-app
W0925 20:50:52.183012  163911 warnings.go:70] path /index.html cannot be used with pathType Prefix
NAME: otusi-dev-release
LAST DEPLOYED: Wed Sep 25 20:50:50 2024
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ!

–í—ã –º–æ–∂–µ—Ç–µ –ø–æ–ª—É—á–∏—Ç—å –∫ –Ω–µ–º—É –¥–æ—Å—Ç—É–ø –ø–æ —Å–ª–µ–¥—É—é—â–µ–º—É URL:

  http://homework.otus/index.html

$ kubectl get pod
NAME                                             READY   STATUS    RESTARTS   AGE
otusi-dev-release-homework-app-f49fdf946-fpdvd   1/1     Running   0          17m
otusi-dev-release-homework-app-f49fdf946-j2b56   1/1     Running   0          17m
otusi-dev-release-homework-app-f49fdf946-xmv55   1/1     Running   0          17m
otusi-dev-release-redis-master-0                 1/1     Running   0          17m
otusi-dev-release-redis-replicas-0               1/1     Running   0          17m
otusi-dev-release-redis-replicas-1               1/1     Running   0          16m
otusi-dev-release-redis-replicas-2               1/1     Running   0          15m

$ curl http://homework.otus/index.html
Hello, OTUS! Homework 6! ConfigMap Text.
```

–ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, –∏—Å–ø–æ–ª—å–∑—É—è `--set`, –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º –∫–æ–ª–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–ø–ª–∏–∫:

```bash
$ helm upgrade otusi-dev-release ./homework-app \
>   --set replicaCount=2
Release "otusi-dev-release" has been upgraded. Happy Helming!
NAME: otusi-dev-release
LAST DEPLOYED: Wed Sep 25 21:16:47 2024
NAMESPACE: default
STATUS: deployed
REVISION: 2
NOTES:
1. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ!

–í—ã –º–æ–∂–µ—Ç–µ –ø–æ–ª—É—á–∏—Ç—å –∫ –Ω–µ–º—É –¥–æ—Å—Ç—É–ø –ø–æ —Å–ª–µ–¥—É—é—â–µ–º—É URL:

  http://homework.otus/index.html


$ kubectl get pod
NAME                                             READY   STATUS    RESTARTS   AGE
otusi-dev-release-homework-app-f49fdf946-fpdvd   1/1     Running   0          26m
otusi-dev-release-homework-app-f49fdf946-xmv55   1/1     Running   0          26m
otusi-dev-release-redis-master-0                 0/1     Running   0          10s
otusi-dev-release-redis-replicas-0               1/1     Running   0          26m
otusi-dev-release-redis-replicas-1               1/1     Running   0          24m
otusi-dev-release-redis-replicas-2               0/1     Running   0          11s
```

---

–ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º –≤—ã–≤–æ–¥–∏–º—ã–π –≤ –±—Ä–∞—É–∑–µ—Ä —Ç–µ–∫—Å—Ç:

```bash
$ helm upgrade otusi-dev-release ./homework-app \
>   --set configMap.data.text="Updated OTUS ConfigMap text"
Release "otusi-dev-release" has been upgraded. Happy Helming!
NAME: otusi-dev-release
LAST DEPLOYED: Wed Sep 25 21:23:21 2024
NAMESPACE: default
STATUS: deployed
REVISION: 4
NOTES:
1. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ!

–í—ã –º–æ–∂–µ—Ç–µ –ø–æ–ª—É—á–∏—Ç—å –∫ –Ω–µ–º—É –¥–æ—Å—Ç—É–ø –ø–æ —Å–ª–µ–¥—É—é—â–µ–º—É URL:

  http://homework.otus/index.html

$ curl http://homework.otus/index.html
Updated OTUS ConfigMap text
```
---

```bash
$ kubectl describe pod kafka-prod-controller-0 -n prod | grep "Image:"
    Image:         docker.io/bitnami/kafka:3.5.2-debian-11-r0
    Image:         docker.io/bitnami/kafka:3.5.2-debian-11-r0
```
### 4. –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã 2 —Ä–µ–ª–∏–∑–∞ `kafka` –∏–∑ `bitnami helm-—á–∞—Ä—Ç–∞`c —Å–ª–µ–¥—É—é—â–∏–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –ø—Ä–∏ –ø–æ–º–æ—â–∏ `helmfile`:

1.1 –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ namespace `prod`
 
1.2 –î–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ `5` –±—Ä–æ–∫–µ—Ä–æ–≤

1.3 –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ kafka –≤–µ—Ä—Å–∏–∏ `3.5.2`
 
1.4 –î–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö –∏ –º–µ–∂–±—Ä–æ–∫–µ—Ä–Ω—ã—Ö –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π
–¥–æ–ª–∂–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –ø—Ä–æ—Ç–æ–∫–æ–ª `SASL_PLAINTEXT`

---

2.1 –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ namespace `dev`

2.2 –î–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç `1` –±—Ä–æ–∫–µ—Ä

2.3 –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ `–ø–æ—Å–ª–µ–¥–Ω—è—è` –¥–æ—Å—Ç—É–ø–Ω–∞—è
–≤–µ—Ä—Å–∏—è kafka

2.4 –î–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö –∏ –º–µ–∂–±—Ä–æ–∫–µ—Ä–Ω—ã—Ö –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π
–¥–æ–ª–∂–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –ø—Ä–æ—Ç–æ–∫–æ–ª `PLAINTEXT`,
`–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è` –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –∫ –∫–ª–∞—Å—Ç–µ—Ä—É `–æ—Ç–∫–ª—é—á–µ–Ω–∞`

–î–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–∞–ª—å–Ω–µ–π—à–µ–µ –∫–∞—Å—Ç–æ–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–ª–∏ –≤–∫–ª—é—á–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å—Ä–µ–¥—ã, —Å–æ–∑–¥–∞–Ω `Helmfile` —Å —Å—ãk–∫–∞–º–∏ –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö  `values-prod.yaml` –∏ `values-dev.yaml`.

```yaml
releases:
  - name: kafka-prod
    namespace: prod
    createNamespace: true
    chart: bitnami/kafka
    version: 25.3.5
    values:
      - values-prod.yaml

  - name: kafka-dev
    namespace: dev
    createNamespace: true
    chart: bitnami/kafka
    values:
      - values-dev.yaml
```

–ó–∞ –æ—Å–Ω–æ–≤—É —Ñ–∞–π–ª–æ–≤ `values-prod.yaml` –∏ `values-dev.yaml` –≤–∑—è—Ç—ã –∫–∞—Å—Ç–æ–º–Ω—ã–µ values —Ñ–∞–π–ª—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –≤–µ—Ä—Å–∏–π Helm —á–∞—Ä—Ç–æ–≤ –∏ –∫–∞—Å—Ç–æ–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã.

**–î–ª—è –æ–∫—Ä—É–∂–µ–Ω–∏—è prod:**
 
1.1 –î–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ `5` –±—Ä–æ–∫–µ—Ä–æ–≤

```yaml
broker:
  replicaCount: 5
```
1.2 –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ kafka –≤–µ—Ä—Å–∏–∏ `3.5.2`
 
```yaml
image:
  registry: docker.io
  repository: bitnami/kafka
  tag: 3.5.2-debian-11-r0
  digest: ""
```
1.3 –î–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö –∏ –º–µ–∂–±—Ä–æ–∫–µ—Ä–Ω—ã—Ö –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π
–¥–æ–ª–∂–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –ø—Ä–æ—Ç–æ–∫–æ–ª `SASL_PLAINTEXT`

```yaml
client:
    containerPort: 9092
    protocol: SASL_PLAINTEXT
    name: CLIENT
    sslClientAuth: ""

...

  interbroker:
    containerPort: 9094
    protocol: SASL_PLAINTEXT
    name: INTERNAL
    sslClientAuth: ""
```
**–î–ª—è –æ–∫—Ä—É–∂–µ–Ω–∏—è dev:**

2.1 –î–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç `1` –±—Ä–æ–∫–µ—Ä

```yaml
broker:
  replicaCount: 1
```

2.3 –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ `–ø–æ—Å–ª–µ–¥–Ω—è—è` –¥–æ—Å—Ç—É–ø–Ω–∞—è
–≤–µ—Ä—Å–∏—è kafka

```yaml
image:
  registry: docker.io
  repository: bitnami/kafka
  tag: latest
  digest: ""
```

2.4 –î–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö –∏ –º–µ–∂–±—Ä–æ–∫–µ—Ä–Ω—ã—Ö –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π
–¥–æ–ª–∂–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –ø—Ä–æ—Ç–æ–∫–æ–ª `PLAINTEXT`,
`–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è` –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –∫ –∫–ª–∞—Å—Ç–µ—Ä—É `–æ—Ç–∫–ª—é—á–µ–Ω–∞`

```yaml
  client:
    containerPort: 9092
    protocol: PLAINTEXT
    name: CLIENT
    sslClientAuth: ""
  
...

  interbroker:
    containerPort: 9094
    protocol: PLAINTEXT
    name: INTERNAL
    sslClientAuth: ""

...

auth:
  client:
    enabled: false
```
---
–ó–∞–ø—É—Å–∫–∞–µ–º:

```bash
./kubernetes-templating/kafka$ helmfile sync
```
---

–ü—Ä–æ–≤–µ—Ä—è–µ–º

```bash
$ kubectl describe pod kafka-prod-broker-0 -n prod | grep "Image:"
    Image:         docker.io/bitnami/kafka:3.5.2-debian-11-r0
    Image:         docker.io/bitnami/kafka:3.5.2-debian-11-r0

$ kubectl get pod -n prod
NAME                      READY   STATUS    RESTARTS  AGE
kafka-prod-broker-0       1/1     Running   0         35m
kafka-prod-broker-1       1/1     Running   0         35m
kafka-prod-broker-2       1/1     Running   0         35m
kafka-prod-broker-3       1/1     Running   0         35m
kafka-prod-broker-4       1/1     Running   0         35m
kafka-prod-controller-0   1/1     Running   0         35m

$ kubectl get pod -n dev
NAME                     READY   STATUS    RESTARTS   AGE
kafka-dev-broker-0       1/1     Running   0          35m
kafka-dev-controller-0   1/1     Running   0          35m
```
# HW5 –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Ä–≤–∏—Å–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø—Ä–∞–≤ –¥–ª—è –Ω–∏—Ö.

## –í –ø—Ä–æ—Ü–µ—Å—Å–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –î–ó –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è:

### 1. –°–æ–∑–¥–∞–Ω `ServiceAccount` —Å –∏–º–µ–Ω–µ–º `monitoring` –≤ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ –∏–º–µ–Ω `homework` –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω –¥–æ—Å—Ç—É–ø –∫ —ç–Ω–¥–ø–æ–∏–Ω—Ç—É `/metrics` –∫–ª–∞—Å—Ç–µ—Ä–∞.

**a. –°–æ–∑–¥–∞–Ω ServiceAccount:**

```yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: monitoring
  namespace: homework
```

**b. –°–æ–∑–¥–∞–Ω ClusterRole –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ `/metrics`:**

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: metrics-reader
rules:
  - nonResourceURLs: ["/metrics"]
    verbs: ["get"]
```

**c. –ü—Ä–∏–≤—è–∑–∞–Ω ClusterRole –∫ ServiceAccount `monitoring`:**

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: monitoring-metrics-reader
subjects:
  - kind: ServiceAccount
    name: monitoring
    namespace: homework
roleRef:
  kind: ClusterRole
  name: metrics-reader
  apiGroup: rbac.authorization.k8s.io
```
---
–ü—Ä–∏–º–µ–Ω—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:

```bash
kubectl apply -f sa_monitoring.yaml
kubectl apply -f cr_monitoring.yaml
kubectl apply -f crb_monitoring.yaml
```
---

### 2. –ò–∑–º–µ–Ω –º–∞–Ω–∏—Ñ–µ—Å—Ç Deployment, —á—Ç–æ–±—ã –ø–æ–¥—ã –∑–∞–ø—É—Å–∫–∞–ª–∏—Å—å –ø–æ–¥ `ServiceAccount` `monitoring`.

```yaml
spec:
  template:
    spec:
      serviceAccountName: monitoring  # –î–æ–±–∞–≤–ª–µ–Ω–∞ —ç—Ç–∞ —Å—Ç—Ä–æ–∫–∞
      containers:
      - name: web-server
        # ... –æ—Å—Ç–∞–ª—å–Ω–∞—è —á–∞—Å—Ç—å —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
```
–ü—Ä–∏–º–µ–Ω—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é:

```bash
kubectl apply -f deployment.yaml
```
–ü—Ä–æ–≤–µ—Ä—è–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Ä–µ—Å—É—Ä—Å–∞ `deployment homework-deployment`

```bash
$ kubectl get deployment homework-deployment -o yaml -n homework | grep monitoring
      {"apiVersion":"apps/v1","kind":"Deployment","metadata":{"annotations":{},"name":"homework-deployment","namespace":"homework"},"spec":{"replicas":3,"selector":{"matchLabels":{"app":"homework-app"}},"strategy":{"rollingUpdate":{"maxUnavailable":1},"type":"RollingUpdate"},"template":{"metadata":{"labels":{"app":"homework-app"}},"spec":{"containers":[{"args":["cp /homework/conf/text /homework/index.html \u0026\u0026 \\\ncp /homework/index.html /usr/share/nginx/html/index.html \u0026\u0026 \\\nexec nginx -g 'daemon off;' -c /etc/nginx/nginx.conf\n"],"command":["/bin/sh","-c"],"image":"nginx:alpine","lifecycle":{"preStop":{"exec":{"command":["rm","/homework/index.html"]}}},"name":"web-server","ports":[{"containerPort":80}],"readinessProbe":{"exec":{"command":["cat","/homework/index.html"]},"initialDelaySeconds":5,"periodSeconds":10},"volumeMounts":[{"mountPath":"/homework/pvc","name":"homework-volume"},{"mountPath":"/homework/conf","name":"config-volume"}]}],"initContainers":[{"args":["echo \"Hello, OTUS! Homework 4! PVC Text.\" \u003e /init/index.html"],"command":["/bin/sh","-c"],"image":"busybox","name":"init-container","volumeMounts":[{"mountPath":"/init","name":"homework-volume"}]}],"nodeSelector":{"homework":"true"},"serviceAccountName":"monitoring","volumes":[{"name":"homework-volume","persistentVolumeClaim":{"claimName":"my-pvc"}},{"configMap":{"name":"my-config"},"name":"config-volume"}]}}}}
      serviceAccount: monitoring
      serviceAccountName: monitoring
```
---

### 3. –°–æ–∑–¥–∞–Ω `ServiceAccount` —Å –∏–º–µ–Ω–µ–º `cd` –≤ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ –∏–º–µ–Ω `homework` –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∞ —Ä–æ–ª—å `admin` –≤ —Ä–∞–º–∫–∞—Ö —ç—Ç–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ –∏–º–µ–Ω.

**a. –°–æ–∑–¥–∞–Ω ServiceAccount:**

```yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: cd
  namespace: homework
```

**b. –ü—Ä–∏–≤—è–∑–∞–Ω ClusterRole `admin` –∫ ServiceAccount `cd` –≤ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ –∏–º–µ–Ω `homework`:**

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: cd-admin-binding
  namespace: homework
subjects:
  - kind: ServiceAccount
    name: cd
    namespace: homework
roleRef:
  kind: ClusterRole
  name: admin
  apiGroup: rbac.authorization.k8s.io
```
---
–ü—Ä–∏–º–µ–Ω—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:

```bash
kubectl apply -f sa_cd.yaml
kubectl apply -f rb_cd.yaml
```
–î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–º–∞–Ω–¥—É `kubectl describe`, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –ø—Ä–∏–≤—è–∑–∫–µ —Ä–æ–ª–µ–π –¥–ª—è `RoleBinding`:

```bash
$ kubectl describe rolebinding cd-admin-binding -n homework
Name:         cd-admin-binding
Labels:       <none>
Annotations:  <none>
Role:
  Kind:  ClusterRole
  Name:  admin
Subjects:
  Kind            Name  Namespace
  ----            ----  ---------
  ServiceAccount  cd    homework
```
---

### 4. –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω kubeconfig –¥–ª—è ServiceAccount cd. –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω —Ç–æ–∫–µ–Ω —Å–æ —Å—Ä–æ–∫–æ–º –¥–µ–π—Å—Ç–≤–∏—è 1 –¥–µ–Ω—å –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ —Ñ–∞–π–ª token.

**a. –ü–æ–ª—É—á–µ–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–ª–∞—Å—Ç–µ—Ä–µ:**

```bash
CLUSTER_NAME=$(kubectl config view --raw --flatten --minify -o jsonpath='{.clusters[0].name}')
SERVER=$(kubectl config view --raw --flatten --minify -o jsonpath='{.clusters[0].cluster.server}')
CA_CERT=$(kubectl config view --raw --flatten --minify -o jsonpath='{.clusters[0].cluster.certificate-authority-data}')
```

**b. –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω —Ç–æ–∫–µ–Ω –¥–ª—è ServiceAccount `cd` —Å–æ —Å—Ä–æ–∫–æ–º –¥–µ–π—Å—Ç–≤–∏—è 1 –¥–µ–Ω—å –∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –µ–≥–æ –≤ —Ñ–∞–π–ª `token`:**

```bash
kubectl -n homework create token cd --duration=24h > token
```

**c. –°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª kubeconfig:**

```bash
TOKEN=$(cat token)
cat <<EOF > kubeconfig
apiVersion: v1
kind: Config
clusters:
- cluster:
    certificate-authority-data: $CA_CERT
    server: $SERVER
  name: $CLUSTER_NAME
contexts:
- context:
    cluster: $CLUSTER_NAME
    user: cd
    namespace: homework
  name: cd-context
current-context: cd-context
users:
- name: cd
  user:
    token: $TOKEN
EOF
```
–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è `KUBECONFIG`, —á—Ç–æ–±—ã –∫–æ–º–∞–Ω–¥—ã kubectl –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ `kubeconfig —Ñ–∞–π–ª`

```bash
$ export KUBECONFIG=~/skyfly535_repo/kubernetes-security/kubeconfig
```
---
–ü—Ä–æ–≤–µ—Ä—è–µ–º:

```bash
kubectl get all
NAME                                       READY   STATUS    RESTARTS   AGE
pod/homework-deployment-5f96bddf87-bdjq2   1/1     Running   0          90m
pod/homework-deployment-5f96bddf87-gr4vc   1/1     Running   0          90m
pod/homework-deployment-5f96bddf87-rbd2n   1/1     Running   0          90m

$ kubectl config current-context
cd-context

$ kubectl config get-contexts
CURRENT   NAME         CLUSTER    AUTHINFO   NAMESPACE
*         cd-context   minikube   cd         homework
```
---
### 5. –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω Deployment —Ç–∞–∫, —á—Ç–æ–±—ã –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø–æ–¥–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫ —ç–Ω–¥–ø–æ–∏–Ω—Ç—É `/metrics` –∫–ª–∞—Å—Ç–µ—Ä–∞, —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω—è–ª—Å—è –≤ —Ñ–∞–π–ª `metrics.html`, –∏ —ç—Ç–æ—Ç —Ñ–∞–π–ª –º–æ–∂–Ω–æ –±—ã–ª–æ –ø–æ–ª—É—á–∏—Ç—å –ø–æ –∞–¥—Ä–µ—Å—É `/metrics.html`.

 –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è Deployment –¥–ª—è –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ `/metrics` –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è `metrics.html`

–û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–¥–µ–ª `args` –≤ –≤–∞—à–µ–º Deployment:

- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º `curl` –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ (–ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏).
- –û–±—Ä–∞—â–∞–µ–º—Å—è –∫ —ç–Ω–¥–ø–æ–∏–Ω—Ç—É `/metrics`, –∏—Å–ø–æ–ª—å–∑—É—è —Ç–æ–∫–µ–Ω –∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç ServiceAccount.
- –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –≤ `metrics.html` –∏ —Å–∫–æ–ø–∏—Ä—É–µ–º –µ–≥–æ –≤ HTML-–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é `NGINX`.

**–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –º–∞–Ω–∏—Ñ–µ—Å—Ç Deployment:**

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: homework-deployment
  namespace: homework
spec:
  replicas: 3
  selector:
    matchLabels:
      app: homework-app
  template:
    metadata:
      labels:
        app: homework-app
    spec:
      serviceAccountName: monitoring  # –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–∞ —Å—Ç—Ä–æ–∫–∞ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç
      containers:
      - name: web-server
        image: nginx:alpine
        ports:
        - containerPort: 80
        volumeMounts:
        - name: homework-volume
          mountPath: /homework/pvc
        - name: config-volume
          mountPath: /homework/conf
        lifecycle:
          preStop:
            exec:
              command: ["rm", "/homework/index.html"]
        command: ["/bin/sh", "-c"]
        args:
          - |
            apk add --no-cache curl && \
            cp /homework/conf/text /homework/index.html && \
            cp /homework/index.html /usr/share/nginx/html/index.html && \
            curl --cacert /var/run/secrets/kubernetes.io/serviceaccount/ca.crt \
                 -H "Authorization: Bearer $(cat /var/run/secrets/kubernetes.io/serviceaccount/token)" \
                 https://kubernetes.default.svc/metrics -o /usr/share/nginx/html/metrics.html && \
            exec nginx -g 'daemon off;' -c /etc/nginx/nginx.conf
        readinessProbe:
          exec:
            command:
            - cat
            - /homework/index.html
          initialDelaySeconds: 5
          periodSeconds: 10
      initContainers:
      - name: init-container
        image: busybox
        command: ["/bin/sh", "-c"]
        args:
          - echo "Hello, OTUS! Homework 4! PVC Text." > /init/index.html
        volumeMounts:
        - name: homework-volume
          mountPath: /init
      volumes:
      - name: homework-volume
        persistentVolumeClaim:
          claimName: my-pvc
      - name: config-volume
        configMap:
          name: my-config
      nodeSelector:
        homework: "true"
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
```
---

### –ü–æ—è—Å–Ω–µ–Ω–∏–µ

- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ ServiceAccount:**
  - –ü–æ–ª–µ `serviceAccountName: monitoring` –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –ø–æ–¥—ã –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –ø–æ–¥ `ServiceAccount` `monitoring`.
- **–î–æ—Å—Ç—É–ø –∫ —ç–Ω–¥–ø–æ–∏–Ω—Ç—É `/metrics`:**
  - –£—Å—Ç–∞–Ω–æ–≤–∫–∞ `curl` —Å –ø–æ–º–æ—â—å—é `apk add --no-cache curl`.
  - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `curl` —Å —Ç–æ–∫–µ–Ω–æ–º –∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–º ServiceAccount –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ —ç–Ω–¥–ø–æ–∏–Ω—Ç—É `/metrics`:
    ```bash
    curl --cacert /var/run/secrets/kubernetes.io/serviceaccount/ca.crt \
         -H "Authorization: Bearer $(cat /var/run/secrets/kubernetes.io/serviceaccount/token)" \
         https://kubernetes.default.svc/metrics -o /usr/share/nginx/html/metrics.html
    ```
  - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –≤ `/usr/share/nginx/html/metrics.html`, —á—Ç–æ–±—ã –æ–Ω –±—ã–ª –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É `http://homework.otus/metrics`.

### –î–æ–±–∞–≤–ª—è–µ–º `Ingress` —á—Ç–æ–±—ã –æ–±—Å–ª—É–∂–∏—Ç—å –ø—É—Ç—å `/metrics`, –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞—è –µ–≥–æ –Ω–∞ /metrics.html


```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: metrics-ingress
  namespace: homework
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /metrics.html
spec:
  rules:
  - host: homework.otus
    http:
      paths:
      - path: /metrics
        pathType: Exact
        backend:
          service:
            name: my-service
            port:
              number: 80
```
---

–ü—Ä–æ–≤–µ—Ä—è–µ–º:

```bash
$ curl http://homework.otus/metrics
{
  "kind": "Status",
  "apiVersion": "v1",
  "metadata": {},
  "status": "Failure",
  "message": "forbidden: User \"system:serviceaccount:homework:monitoring\" cannot get path \"/metrics\"",
  "reason": "Forbidden",
  "details": {},
  "code": 403
```
# HW4 Volumes, StorageClass, PV, PVC.

## –í –ø—Ä–æ—Ü–µ—Å—Å–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –î–ó –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è:

1. –°–æ–∑–¥–∞–Ω –º–∞–Ω–∏—Ñ–µ—Å—Ç `pvc.yaml`, –æ–ø–∏—Å—ã–≤–∞—é—â–∏–π `PersistentVolumeClaim`, –∑–∞–ø—Ä–∞—à–∏–≤–∞—é—â–∏–π —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Å `storageClass` –ø–æ-—É–º–æ–ª—á–∞–Ω–∏—é.

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: my-pvc
  namespace: homework
spec:
  storageClassName: my-storage-class
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
```

–≠—Ç–æ—Ç `PersistentVolumeClaim` (PVC) –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –∏–ª–∏ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ Kubernetes. –í–æ—Ç –µ–≥–æ –æ–ø–∏—Å–∞–Ω–∏–µ:

### –ü–æ—è—Å–Ω–µ–Ω–∏–µ:

- **spec:**
  - **storageClassName:** `my-storage-class` ‚Äî –£–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ `StorageClass`, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞. –í —ç—Ç–æ–º —Å–ª—É—á–∞–µ PVC –ø—ã—Ç–∞–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ö—Ä–∞–Ω–∏–ª–∏—â–µ, —Å–æ–∑–¥–∞–Ω–Ω–æ–µ —Å –ø–æ–º–æ—â—å—é `StorageClass` —Å –∏–º–µ–Ω–µ–º `my-storage-class`.
  - **accessModes:**
    - `ReadWriteOnce` ‚Äî –£–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ PVC –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è —á—Ç–µ–Ω–∏—è –∏ –∑–∞–ø–∏—Å–∏ —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∏–º —É–∑–ª–æ–º –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.
  - **resources:**
    - **requests:** 
      - **storage:** `1Gi` ‚Äî –ó–∞–ø—Ä–æ—Å –Ω–∞ –æ–±—ä–µ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–∞, –∫–æ—Ç–æ—Ä—ã–π —Ç—Ä–µ–±—É–µ—Ç—Å—è. –í –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç—Å—è 1 –≥–∏–≥–∞–±–∞–π—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞.

### –î–∞–ª—å–Ω–µ–π—à–∏–µ –¥–µ–π—Å—Ç–≤–∏—è:

- PVC –±—É–¥–µ—Ç –∂–¥–∞—Ç—å, –ø–æ–∫–∞ `PersistentVolume` (PV), —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —ç—Ç–∏–º –∑–∞–ø—Ä–æ—Å–∞–º, –Ω–µ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω. –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ, `StorageClass` —Å—Ä–∞–±–æ—Ç–∞–µ—Ç –∏ —Å–æ–∑–¥–∞—Å—Ç PV –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
- –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∏ —Å–≤—è–∑—ã–≤–∞–Ω–∏—è PV —Å —ç—Ç–∏–º PVC, –æ–Ω –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –ø–æ–¥–æ–≤ –≤ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ –∏–º–µ–Ω `homework` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –∫–∞—á–µ—Å—Ç–≤–µ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞.

2. –°–æ–∑–¥–∞–Ω –º–∞–Ω–∏—Ñ–µ—Å—Ç `cm.yaml` –¥–ª—è –æ–±—ä–µ–∫—Ç–∞ —Ç–∏–ø–∞ `configMap`, –æ–ø–∏—Å—ã–≤–∞—é—â–∏–π –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä –ø–∞—Ä –∫–ª—é—á-–∑–Ω–∞—á–µ–Ω–∏–µ.

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: my-config
  namespace: homework
data:
  text: Hello, OTUS! Homework 4! ConfigMap Text.
```

### –ü–æ—è—Å–Ω–µ–Ω–∏–µ:

–≠—Ç–æ—Ç `ConfigMap` –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –≤–∏–¥–µ –ø–∞—Ä –∫–ª—é—á-–∑–Ω–∞—á–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã –ø–æ–¥–∞–º–∏ –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ Kubernetes.

–í –Ω–∞—à–µ–º —Å–ª—É—á–∞–µ `ConfigMap` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ `—Ñ–∞–π–ª` –∏ –º–æ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è –≤ –ø–æ–¥ –∫–∞–∫ `volume`,–∞ –∑–Ω–∞—á–µ–Ω–∏–µ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ –∫–∞–∫ —Ñ–∞–π–ª.

3. –í –º–∞–Ω–∏—Ñ–µ—Å—Ç–µ `deployment.yaml` –∏–∑–º–µ–Ω–µ–Ω–∞ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è `volume` —Å —Ç–∏–ø–∞ `emptyDir`, –∫–æ—Ç–æ—Ä—ã–π –º–æ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è –≤ init –∏ –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –Ω–∞ `pvc`, —Å–æ–∑–¥–∞–Ω–Ω—ã–π –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º
–ø—É–Ω–∫—Ç–µ. –î–æ–±–∞–≤–ª–µ–Ω–æ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–Ω–µ–µ —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ `configMap` –∫–∞–∫ `volume` –∫ –æ—Å–Ω–æ–≤–Ω–æ–º—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É –ø–æ–¥–∞ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é `/homework/conf`.

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: homework-deployment
  namespace: homework
spec:
  replicas: 3
  selector:
    matchLabels:
      app: homework-app
  template:
    metadata:
      labels:
        app: homework-app
    spec:
      containers:
      - name: web-server
        image: nginx:alpine
        ports:
        - containerPort: 80
        volumeMounts:
        - name: homework-volume
          mountPath: /homework/pvc    # –ú–æ–Ω—Ç–∏—Ä—É–µ–º PVC
        - name: config-volume
          mountPath: /homework/conf   # –ú–æ–Ω—Ç–∏—Ä—É–µ–º ConfigMap –∫–∞–∫ volume
        lifecycle:
          preStop:
            exec:
              command: ["rm", "/homework/index.html"]
        command: ["/bin/sh", "-c"]
        args:
          - |
            cp /homework/conf/text /homework/index.html && \
            cp /homework/index.html /usr/share/nginx/html/index.html && \
            exec nginx -g 'daemon off;' -c /etc/nginx/nginx.conf
        readinessProbe:
          exec:
            command:
            - cat
            - /homework/index.html
          initialDelaySeconds: 5
          periodSeconds: 10
      initContainers:
      - name: init-container
        image: busybox
        command: ["/bin/sh", "-c"]
        args:
          - echo "Hello, OTUS! Homework 4! PVC Text." > /init/index.html
        volumeMounts:
        - name: homework-volume
          mountPath: /init
      volumes:
      - name: homework-volume
        persistentVolumeClaim:
          claimName: my-pvc     # –ó–¥–µ—Å—å –æ–±—ä—è–≤–ª—è–µ—Ç—Å—è PVC 
      - name: config-volume 
        configMap:
          name: my-config       # –ó–¥–µ—Å—å –º–æ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è ConfigMap
      nodeSelector:
        homework: "true"
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
```

### –ü–æ—è—Å–Ω–µ–Ω–∏–µ:

1. **–ó–∞–º–µ–Ω–∞ `emptyDir` –Ω–∞ `PersistentVolumeClaim`:** –¢–µ–ø–µ—Ä—å volume `homework-volume` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç PVC —Å –∏–º–µ–Ω–µ–º `my-pvc`.
2. **–î–æ–±–∞–≤–ª–µ–Ω ConfigMap:** –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π volume `config-volume`, –∫–æ—Ç–æ—Ä—ã–π –º–æ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è –≤ –ø–∞–ø–∫—É `/homework/conf`.

–≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç –ø–æ–¥—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –∏ –∏–º–µ—Ç—å –¥–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º –∏–∑ ConfigMap.

–í –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ `ConfigMap` –ø—Ä–æ–±—Ä–æ—à–µ–Ω–Ω–æ –≤ –∫–∞—Ç–∞–ª–æ–≥ `/usr/share/nginx/html/index.html` –∏ –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ, –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –ø–æ –∞–¥—Ä–µ—Å—É `http://homework.otus/homepage`.
–§–∞–π–ª —Ö—Ä–∞–Ω—è—â–∏–π—Å—è –≤ `persistentVolumeClaim` –∏ –ø–æ–¥–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤ –∫–∞—Ç–∞–ª–æ–≥ –ø–æ–¥–∞ `/homework/pvc` –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –∏ –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è Deployment, –∏ –ø–æ—Å–ª–µ –≤—ã–∫–∞—Ç–∫–∏ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏.

4. –°–æ–∑–¥–∞–Ω –º–∞–Ω–∏—Ñ–µ—Å—Ç `storageClass.yaml` –æ–ø–∏—Å—ã–≤–∞—é—â–∏–π –æ–±—ä–µ–∫—Ç —Ç–∏–ø–∞ `storageClass` —Å provisioner https://k8s.io/minikube-hostpath –∏ `reclaimPolicy Retain`.

```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: my-storage-class
provisioner: k8s.io/minikube-hostpath
reclaimPolicy: Retain
volumeBindingMode: Immediate
```
–≠—Ç–æ—Ç `StorageClass` –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö —Ç–æ–º–æ–≤ —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ Kubernetes. –û–Ω –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Å–ø–æ—Å–æ–± –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–∏–ø–∞–º–∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –≤—ã–¥–µ–ª–µ–Ω—ã –¥–ª—è –ø–æ–¥–æ–≤. –í–æ—Ç –ø–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —ç—Ç–æ–≥–æ `StorageClass`:

### –ü–æ—è—Å–Ω–µ–Ω–∏–µ:

- **provisioner:** `k8s.io/minikube-hostpath` ‚Äî –ò–º—è –ø—Ä–æ–≤–∏–∂–µ–Ω–µ—Ä–∞, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–º–æ–≤ —Ö—Ä–∞–Ω–µ–Ω–∏—è. –í –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–æ–≤–∏–∂–µ–Ω–µ—Ä `minikube-hostpath`, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è Minikube –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–æ–º–æ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –Ω–∞ —É–∑–ª–∞—Ö Minikube.
- **reclaimPolicy:** `Retain` ‚Äî –ü–æ–ª–∏—Ç–∏–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞, –æ–ø—Ä–µ–¥–µ–ª—è—é—â–∞—è, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å —Ç–æ–º–æ–º –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è `PersistentVolumeClaim` (PVC):
  - `Retain` ‚Äî –ü–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è PVC —Ç–æ–º –Ω–µ —É–¥–∞–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è, —á—Ç–æ–±—ã –¥–∞–Ω–Ω—ã–µ –º–æ–≥–ª–∏ –±—ã—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã —Å–Ω–æ–≤–∞.
  - –î—Ä—É–≥–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã ‚Äî `Delete` (—Ç–æ–º —É–¥–∞–ª—è–µ—Ç—Å—è) –∏ `Recycle` (—Ç–æ–º –æ—á–∏—â–∞–µ—Ç—Å—è –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –ø—É–ª –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–æ–º–æ–≤).
- **volumeBindingMode:** `Immediate` ‚Äî –£–∫–∞–∑—ã–≤–∞–µ—Ç, –∫–æ–≥–¥–∞ `PersistentVolume` (PV) –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—Ä–∏–≤—è–∑–∞–Ω –∫ `PersistentVolumeClaim` (PVC):
  - `Immediate` ‚Äî –ü—Ä–∏–≤—è–∑–∫–∞ PV –∫ PVC –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è PVC.
  - –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç ‚Äî `WaitForFirstConsumer`, –≥–¥–µ –ø—Ä–∏–≤—è–∑–∫–∞ PV –æ—Ç–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è –¥–æ —Ç–µ—Ö –ø–æ—Ä, –ø–æ–∫–∞ –ø–æ–¥, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–π PVC, –Ω–µ –±—É–¥–µ—Ç –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω –Ω–∞ —É–∑–µ–ª.

### –ü—Ä–æ–≤–µ—Ä–∫–∞

–ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–æ–≤—ã–µ –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã –∏ –æ–±–Ω–æ–≤–ª—è–µ–º Deployment

```bash
/kubernetes-volumes$ kubectl apply -f ./
```
—Å–º–æ—Ç—Ä–∏–º

```bash
$ curl http://homework.otus/homepage
Hello, OTUS! Homework 4! ConfigMap Text.

$ kubectl exec -it homework-deployment-79bddf547f-blpg6 /bin/sh -n homework
kubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl exec [POD] -- [COMMAND] instead.
Defaulted container "web-server" out of: web-server, init-container (init)
/ # cat /homework/pvc/index.html
Hello, OTUS! Homework 4! PVC Text.
```
–£–¥–∞–ª—è–µ–º —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

```bash
$ kubectl delete -f deployment.yaml 
deployment.apps "homework-deployment" deleted
```
–ö–æ–º–µ–Ω—Ç–∏–º —Å–µ–∫—Ü–∏—é —Å `initContainers` –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç–µ `deployment` –∏ —Å–æ–∑–¥–∞–µ–º –∑–∞–Ω–æ–≤–æ

```bash
$ kubectl apply -f deployment.yaml 
deployment.apps/homework-deployment created
```
–ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞ –≤ –ø—Ä–∏–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–º `volume homework-volume`

```bash
$ kubectl exec -it homework-deployment-86dccd98f7-cjf9r /bin/sh -n homework
kubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl exec [POD] -- [COMMAND] instead.
/ # cat /homework/pvc/index.html
Hello, OTUS! Homework 4! PVC Text.
```

# HW3 –°–µ—Ç–µ–≤–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ Pod, —Å–µ—Ä–≤–∏—Å—ã.

## –í –ø—Ä–æ—Ü–µ—Å—Å–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –î–ó –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è:

1. –í –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞—Ö –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –î–ó –≤ `service.yaml` –ø–æ–º–µ–Ω—è–Ω —Ç–∏–ø `type: LoadBalancer` –Ω–∞ `type: ClusterIP`.

```yaml
apiVersion: v1
kind: Service
metadata:
  name: my-service
  namespace: homework
  labels:
    app: homework-app
spec:
  selector:
    app: homework-app
  ports:
    - protocol: TCP
      port: 80
      targetPort: 80
  #type: LoadBalancer
  type: ClusterIP
```
2. –í –∫–ª–∞—Å—Ç–µ—Ä —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω  `ingress-–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä nginx`.

–¢–∞–∫ –∫–∞–∫ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –î–ó –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `minikube` –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ `addon ingress`

```bash
$ minikube addons list
|-----------------------------|----------|--------------|--------------------------------|
|         ADDON NAME          | PROFILE  |    STATUS    |           MAINTAINER           |
|-----------------------------|----------|--------------|--------------------------------|
| ambassador                  | minikube | disabled     | 3rd party (Ambassador)         |
| auto-pause                  | minikube | disabled     | minikube                       |
| cloud-spanner               | minikube | disabled     | Google                         |
| csi-hostpath-driver         | minikube | disabled     | Kubernetes                     |
| dashboard                   | minikube | disabled     | Kubernetes                     |
| default-storageclass        | minikube | enabled ‚úÖ   | Kubernetes                     |
| efk                         | minikube | disabled     | 3rd party (Elastic)            |
| freshpod                    | minikube | disabled     | Google                         |
| gcp-auth                    | minikube | disabled     | Google                         |
| gvisor                      | minikube | disabled     | minikube                       |
| headlamp                    | minikube | disabled     | 3rd party (kinvolk.io)         |
| helm-tiller                 | minikube | disabled     | 3rd party (Helm)               |
| inaccel                     | minikube | disabled     | 3rd party (InAccel             |
|                             |          |              | [info@inaccel.com])            |
| ingress                     | minikube | enabled ‚úÖ   | Kubernetes                     |
| ingress-dns                 | minikube | disabled     | minikube                       |
| inspektor-gadget            | minikube | disabled     | 3rd party                      |
|                             |          |              | (inspektor-gadget.io)          |
| istio                       | minikube | disabled     | 3rd party (Istio)              |
| istio-provisioner           | minikube | disabled     | 3rd party (Istio)              |
| kong                        | minikube | disabled     | 3rd party (Kong HQ)            |
| kubeflow                    | minikube | disabled     | 3rd party                      |
| kubevirt                    | minikube | disabled     | 3rd party (KubeVirt)           |
| logviewer                   | minikube | disabled     | 3rd party (unknown)            |
| metallb                     | minikube | disabled     | 3rd party (MetalLB)            |
| metrics-server              | minikube | disabled     | Kubernetes                     |
| nvidia-device-plugin        | minikube | disabled     | 3rd party (NVIDIA)             |
| nvidia-driver-installer     | minikube | disabled     | 3rd party (Nvidia)             |
| nvidia-gpu-device-plugin    | minikube | disabled     | 3rd party (Nvidia)             |
| olm                         | minikube | disabled     | 3rd party (Operator Framework) |
| pod-security-policy         | minikube | disabled     | 3rd party (unknown)            |
| portainer                   | minikube | disabled     | 3rd party (Portainer.io)       |
| registry                    | minikube | disabled     | minikube                       |
| registry-aliases            | minikube | disabled     | 3rd party (unknown)            |
| registry-creds              | minikube | disabled     | 3rd party (UPMC Enterprises)   |
| storage-provisioner         | minikube | enabled ‚úÖ   | minikube                       |
| storage-provisioner-gluster | minikube | disabled     | 3rd party (Gluster)            |
| storage-provisioner-rancher | minikube | disabled     | 3rd party (Rancher)            |
| volumesnapshots             | minikube | disabled     | Kubernetes                     |
|-----------------------------|----------|--------------|--------------------------------|
```
–∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∑–∞–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å –µ–≥–æ

```bash
minikube addons enable ingress
```

3. –ù–∞–ø–∏—Å–∞–Ω –º–∞–Ω–∏—Ñ–µ—Å—Ç `ingress.yaml` —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—è—é—â–∏–π —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –î–ó.

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: my-ingress
  namespace: homework
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /index.html
    #nginx.ingress.kubernetes.io/rewrite-target: /$2
spec:
  rules:
  - host: homework.otus
    http:
      paths:
      - path: /index.html
        pathType: Prefix
        #pathType: ImplementationSpecific
        backend:
          service:
            name: my-service
            port:
              number: 80
      - path: /homepage
        pathType: Prefix
        #pathType: ImplementationSpecific
        backend:
          service:
            name: my-service
            port:
              number: 80
```
### –ü–æ—è—Å–Ω–µ–Ω–∏–µ:

1. **–ê–Ω–Ω–æ—Ç–∞—Ü–∏—è `nginx.ingress.kubernetes.io/rewrite-target: /index.html`** —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ —Ç–æ, —á—Ç–æ –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã, —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—è—é—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞–º, –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–µ—Ä–µ–ø–∏—Å–∞–Ω—ã –Ω–∞ –ø—É—Ç—å `/index.html`.
2. **–ü—É—Ç—å `/homepage`** –≤ Ingress-—Ä–µ—Å—É—Ä—Å–µ —É–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã, –ø—Ä–∏—Ö–æ–¥—è—â–∏–µ –ø–æ —ç—Ç–æ–º—É URL, –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ —Ç–æ—Ç –∂–µ —Å–µ—Ä–≤–∏—Å (`my-service`), –Ω–æ –ø—Ä–∏ —ç—Ç–æ–º —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø—É—Ç—å –∏–∑–º–µ–Ω–∏—Ç—Å—è –Ω–∞ `/index.html`.

–ü—Ä–∏–º–µ–Ω—è–µ–º:

```bash
$ kubectl apply -f ingress.yaml
```

–ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ:

```bash
$ kubectl get ingress -n homework

NAME         CLASS   HOSTS           ADDRESS          PORTS   AGE
my-ingress   nginx   homework.otus   192.168.59.103   80      26m
```

–¥–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É `192.168.59.103  homework.otus` —Å —ç—Ç–∏–º IP –≤ —Ñ–∞–π–ª `/etc/hosts` –Ω–∞ —Ö–æ—Å—Ç–æ–≤–æ–π –º–∞—à–∏–Ω–µ:

```bash
sudo nano /etc/hosts
```
–ø—Ä–æ–≤–µ—Ä—è–µ–º:

```bash
$ curl http://homework.otus/index.html
Hello, OTUS! Homework 3!

$ curl http://homework.otus/homepage
Hello, OTUS! Homework 3!
```
–ù–ï –∑–∞–±—ã–≤–∞–µ–º –≤–∫–ª—é—á–∏—Ç—å `minikube tunnel`:

```bash
$  minikube tunnel
```

# HW2 Kubernetes controllers. ReplicaSet, Deployment, DaemonSet.

## –í –ø—Ä–æ—Ü–µ—Å—Å–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –î–ó –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è:

1. –ú–∞–Ω–∏—Ñ–µ—Å—Ç –¥–ª—è `namespace` —Å –∏–º–µ–Ω–µ–º `homework` –≤–∑—è—Ç –∏–∑ –î–ó ‚Ññ1 ./kubernetes-intro/namespace.yaml.

### 1. `namespace.yaml`
```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: homework
```

2. –°–æ–∑–¥–∞–Ω –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞ ./kubernetes-controllers/pod.yaml, –æ–ø–∏—Å—ã–≤–∞—é—â–∏–π –ø–æ–¥–Ω–∏–º–∞–µ–º—ã–π `deployment` –∏ —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—è—é—â–∏–π —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –î–ó.

### 2. `deployment.yaml`
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: homework-deployment
  namespace: homework
spec:
  replicas: 3
  selector:
    matchLabels:
      app: homework-app
  template:
    metadata:
      labels:
        app: homework-app
    spec:
      containers:
      - name: web-server
        image: nginx:alpine
        ports:
        - containerPort: 80
        volumeMounts:
        - name: homework-volume
          mountPath: /homework
        lifecycle:
          preStop:
            exec:
              command: ["rm", "/homework/index.html"]
        command: ["/bin/sh", "-c"]
        args:
          - |
            cp /homework/index.html /usr/share/nginx/html/index.html && \
            exec nginx -g 'daemon off;' -c /etc/nginx/nginx.conf
        readinessProbe:
          exec:
            command:
            - cat
            - /homework/index.html
          initialDelaySeconds: 5
          periodSeconds: 10
      initContainers:
      - name: init-container
        image: busybox
        command: ["/bin/sh", "-c"]
        args:
          - echo "Hello, OTUS! Homework 1!" > /init/index.html
        volumeMounts:
        - name: homework-volume
          mountPath: /init
      volumes:
      - name: homework-volume
        emptyDir: {}
      nodeSelector:
        homework: "true"
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
```
### –ü–æ—è—Å–Ω–µ–Ω–∏–µ:
**Deployment**:
   - **replicas: 3**: –°–æ–∑–¥–∞—é—Ç—Å—è `3` —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –ø–æ–¥–æ–≤.
   - **readinessProbe**: –ü—Ä–æ–±–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞ `/homework/index.html` –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ.
   - **strategy**: –°—Ç—Ä–∞—Ç–µ–≥–∏—è `RollingUpdate` –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ —Ç–∞–∫, —á—Ç–æ –≤–æ –≤—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–µ –±–æ–ª–µ–µ –æ–¥–Ω–æ–≥–æ –ø–æ–¥–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (`maxUnavailable: 1`).
   
### –ó–∞–¥–∞–Ω–∏–µ —Å * 

- **nodeSelector**: –£–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ –ø–æ–¥—ã –º–æ–≥—É—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ `–Ω–æ–¥–∞—Ö` —Å –º–µ—Ç–∫–æ–π `homework=true`. 

### –ü—Ä–æ–≤–µ—Ä–∫–∞

–ü—Ä–æ–∏–∑–≤–æ–¥–∏–º —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∏ –≤–∏–¥–∏–º, —á—Ç–æ –ø–æ–¥—ã –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ `Pending` 

```
$ kubectl get pods -n homework
NAME                                   READY   STATUS    RESTARTS   AGE
homework-deployment-64cbbd86f8-2wv6v   0/1     Pending   0          41s
homework-deployment-64cbbd86f8-b4bfz   0/1     Pending   0          41s
homework-deployment-64cbbd86f8-tfdsp   0/1     Pending   0          41s
```
–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ Kubernetes –Ω–µ –º–æ–∂–µ—Ç –Ω–∞–∑–Ω–∞—á–∏—Ç—å –∏—Ö –Ω–∞ –Ω–æ–¥—ã –∫–ª–∞—Å—Ç–µ—Ä–∞ –±–µ–∑ –º–µ—Ç–∫–∏ `homework`.

–ò—Å–ø—Ä–∞–≤–ª—è–µ–º

```
$ kubectl label node minikube homework=true
node/minikube labeled
```
–ü—Ä–æ–≤–µ—Ä—è–µ–º

```
$ kubectl get pods -n homework
NAME                                   READY   STATUS    RESTARTS   AGE
homework-deployment-64cbbd86f8-2wv6v   1/1     Running   0          2m57s
homework-deployment-64cbbd86f8-b4bfz   0/1     Running   0          2m57s
homework-deployment-64cbbd86f8-tfdsp   0/1     Running   0          2m57s

$ kubectl get pods -n homework
NAME                                   READY   STATUS    RESTARTS   AGE
homework-deployment-64cbbd86f8-2wv6v   1/1     Running   0          2m58s
homework-deployment-64cbbd86f8-b4bfz   0/1     Running   0          2m58s
homework-deployment-64cbbd86f8-tfdsp   0/1     Running   0          2m58s

$ kubectl get pods -n homework
NAME                                   READY   STATUS    RESTARTS   AGE
homework-deployment-64cbbd86f8-2wv6v   1/1     Running   0          3m23s
homework-deployment-64cbbd86f8-b4bfz   1/1     Running   0          3m23s
homework-deployment-64cbbd86f8-tfdsp   1/1     Running   0          3m23s
```

–í—ã–≤–æ–¥ —Ç–æ—Ç –∂–µ, —á—Ç–æ –∏ –≤ –ø–µ—Ä–≤–æ–º –î–ó

![Alt text](./kubernetes-controllers/HW2-1.jpg)

–ú–µ–Ω—è–µ–º –≤—ã–≤–æ–¥–∏–º—ã–π —Ç–µ–∫—Å—Ç `Hello, OTUS! Homework 2!` –≤ `deployment.yaml` 

–≤—ã–ø–æ–ª–Ω—è–µ–º

```
$ kubectl apply -f ./
deployment.apps/homework-deployment configured
namespace/homework unchanged
service/homework-service unchanged
```
–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∫ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è `RollingUpdate`

```
$ kubectl get pods -n homework
NAME                                   READY   STATUS     RESTARTS   AGE
homework-deployment-6449cb7fc6-p5r6d   0/1     Init:0/1   0          2s
homework-deployment-6449cb7fc6-v9b6q   0/1     Init:0/1   0          2s
homework-deployment-7c6dd4d867-bzp8v   1/1     Running    0          3m40s
homework-deployment-7c6dd4d867-nfw28   1/1     Running    0          3m40s

$ kubectl get pods -n homework
NAME                                   READY   STATUS     RESTARTS   AGE
homework-deployment-6449cb7fc6-p5r6d   0/1     Running    0          8s
homework-deployment-6449cb7fc6-v9b6q   0/1     Init:0/1   0          8s
homework-deployment-7c6dd4d867-bzp8v   1/1     Running    0          3m46s
homework-deployment-7c6dd4d867-nfw28   1/1     Running    0          3m46s

$ kubectl get pods -n homework
NAME                                   READY   STATUS     RESTARTS   AGE
homework-deployment-6449cb7fc6-kf762   0/1     Init:0/1   0          4s
homework-deployment-6449cb7fc6-p5r6d   1/1     Running    0          14s
homework-deployment-6449cb7fc6-v9b6q   0/1     Running    0          14s
homework-deployment-7c6dd4d867-bzp8v   1/1     Running    0          3m52s

$ kubectl get pods -n homework
NAME                                   READY   STATUS    RESTARTS   AGE
homework-deployment-6449cb7fc6-kf762   0/1     Running   0          7s
homework-deployment-6449cb7fc6-p5r6d   1/1     Running   0          17s
homework-deployment-6449cb7fc6-v9b6q   0/1     Running   0          17s
homework-deployment-7c6dd4d867-bzp8v   1/1     Running   0          3m55s

$ kubectl get pods -n homework
NAME                                   READY   STATUS        RESTARTS   AGE
homework-deployment-6449cb7fc6-kf762   0/1     Running       0          11s
homework-deployment-6449cb7fc6-p5r6d   1/1     Running       0          21s
homework-deployment-6449cb7fc6-v9b6q   1/1     Running       0          21s
homework-deployment-7c6dd4d867-bzp8v   1/1     Terminating   0          3m59s

$ kubectl get pods -n homework
NAME                                   READY   STATUS    RESTARTS   AGE
homework-deployment-6449cb7fc6-kf762   1/1     Running   0          24s
homework-deployment-6449cb7fc6-p5r6d   1/1     Running   0          34s
homework-deployment-6449cb7fc6-v9b6q   1/1     Running   0          34s
```
![Alt text](./kubernetes-controllers/HW2-2.jpg)

–ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–±–æ—Ç—É `readinessProbe` —É–¥–∞–ª–µ–Ω–∏–µ–º —É –æ–¥–Ω–æ–≥–æ –∏–∑ –ø–æ–¥–æ–≤ —Ñ–∞–π–ª–∞ `/homework/index.html`

```
kubectl exec -it homework-deployment-7c6dd4d867-242mx -n homework -- rm /homework/index.html
```
–≤–∏–¥–∏–º 

```
$ kubectl get pods -n homework
NAME                                   READY   STATUS    RESTARTS   AGE
homework-deployment-7c6dd4d867-242mx   0/1     Running   0          19h
homework-deployment-7c6dd4d867-pcfw6   1/1     Running   0          19h
homework-deployment-7c6dd4d867-zw8l4   1/1     Running   0          19h
```

### 1. **Readiness Probe –Ω–µ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∞**
–£ –∫–∞–∂–¥–æ–≥–æ –ø–æ–¥–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ `readinessProbe`, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞ `/homework/index.html`. –ï—Å–ª–∏ —ç—Ç–æ—Ç —Ñ–∞–π–ª –∏—Å—á–µ–∑–Ω–µ—Ç, –∫–æ–º–∞–Ω–¥–∞ `cat /homework/index.html`, —É–∫–∞–∑–∞–Ω–Ω–∞—è –≤ `readinessProbe`, –Ω–µ —Å–º–æ–∂–µ—Ç –Ω–∞–π—Ç–∏ —Ñ–∞–π–ª –∏ –≤–µ—Ä–Ω–µ—Ç –æ—à–∏–±–∫—É.

–≠—Ç–æ –ø—Ä–∏–≤–µ–¥–µ—Ç –∫ —Ç–æ–º—É, —á—Ç–æ `readinessProbe` –±—É–¥–µ—Ç —Å—á–∏—Ç–∞—Ç—å—Å—è –Ω–µ—É—Å–ø–µ—à–Ω–æ–π –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–¥–∞.

### 2. **–ü–æ—Ç–µ—Ä—è —Å—Ç–∞—Ç—É—Å–∞ "Ready"**
–ö–æ–≥–¥–∞ `readinessProbe` –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, Kubernetes –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–Ω–∏–º–∞–µ—Ç —Å—Ç–∞—Ç—É—Å `Ready` —Å –ø–æ–¥–∞, –∏ –ø–æ–¥ –ø–µ—Ä–µ—Å—Ç–∞–µ—Ç —Å—á–∏—Ç–∞—Ç—å—Å—è –≥–æ—Ç–æ–≤—ã–º –∫ –ø—Ä–∏–µ–º—É —Ç—Ä–∞—Ñ–∏–∫–∞. –í –≤—ã–≤–æ–¥–µ –∫–æ–º–∞–Ω–¥—ã `kubectl get pods` —Å—Ç–∞—Ç—É—Å –ø–æ–¥–∞ –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∫–∞–∫ `0/1 Ready`.

### 3. **–¢—Ä–∞—Ñ–∏–∫ –ø–µ—Ä–µ—Å—Ç–∞–Ω–µ—Ç –Ω–∞–ø—Ä–∞–≤–ª—è—Ç—å—Å—è –Ω–∞ –ø–æ–¥**
Kubernetes –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `readinessProbe` –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–µ–º, –∫–∞–∫–∏–µ –ø–æ–¥—ã –º–æ–≥—É—Ç –ø—Ä–∏–Ω–∏–º–∞—Ç—å —Ç—Ä–∞—Ñ–∏–∫. –ö–∞–∫ —Ç–æ–ª—å–∫–æ –ø–æ–¥ —Ç–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å "Ready", —Å–µ—Ä–≤–∏—Å—ã –∏ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫–∏ –Ω–∞–≥—Ä—É–∑–∫–∏ Kubernetes (–Ω–∞–ø—Ä–∏–º–µ—Ä, `Service` –∏–ª–∏ `Ingress`) –ø–µ—Ä–µ—Å—Ç–∞—é—Ç –Ω–∞–ø—Ä–∞–≤–ª—è—Ç—å —Ç—Ä–∞—Ñ–∏–∫ –Ω–∞ —ç—Ç–æ—Ç –ø–æ–¥. –≠—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –≤—ã—Å–æ–∫–æ–π –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–ø—Ä–∞–≤–ª—è–ª–∏—Å—å –Ω–∞ –ø–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –º–æ–∂–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã.

### 4. **–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ "Ready"**
–ï—Å–ª–∏ —Ñ–∞–π–ª `/homework/index.html` –±—É–¥–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, `readinessProbe` —Å–Ω–æ–≤–∞ –ø—Ä–æ–π–¥–µ—Ç —É—Å–ø–µ—à–Ω–æ, –∏ –ø–æ–¥ –≤–Ω–æ–≤—å —Å—Ç–∞–Ω–µ—Ç "Ready", –ø–æ—Å–ª–µ —á–µ–≥–æ –Ω–∞ –Ω–µ–≥–æ –≤–æ–∑–æ–±–Ω–æ–≤–∏—Ç—Å—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞—Ñ–∏–∫–∞.

–≠—Ç–æ—Ç –ø—Ä–æ—Ü–µ—Å—Å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ –ø—Ä–æ–ø–∞–∂–∞ —Ñ–∞–π–ª–∞ —è–≤–ª—è–µ—Ç—Å—è —Å–∏–≥–Ω–∞–ª–æ–º –¥–ª—è Kubernetes, —á—Ç–æ –ø–æ–¥ –Ω–µ –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤ –ø–æ–ª–Ω–æ–º –æ–±—ä–µ–º–µ, –∏ –æ–Ω –∏—Å–∫–ª—é—á–∞–µ—Ç—Å—è –∏–∑ —Ä–æ—Ç–∞—Ü–∏–∏ —Ç—Ä–∞—Ñ–∏–∫–∞ –¥–æ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã.

# HW1 –ó–Ω–∞–∫–æ–º—Å—Ç–≤–æ —Å —Ä–µ—à–µ–Ω–∏—è–º–∏ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ Kubernetes –∫–ª–∞—Å—Ç–µ—Ä–∞, —Å–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Ä–≤–æ–≥–æ pod.

## –í –ø—Ä–æ—Ü–µ—Å—Å–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –î–ó –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è:

1. –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Kubernetes.

- kubectl - –≥–ª–∞–≤–Ω–∞—è —É—Ç–∏–ª–∏—Ç–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Kubernets API (–≤—Å–µ, —á—Ç–æ –¥–µ–ª–∞–µ—Ç kubectl, –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —Å –ø–æ–º–æ—â—å—é HTTP-–∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API k8s)

- minikube - —É—Ç–∏–ª–∏—Ç–∞ –¥–ª—è —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è –ª–æ–∫–∞–ª—å–Ω–æ–π –∏–Ω—Å—Ç–∞–ª–ª—è—Ü–∏–∏ Kubernetes

- ~/.kube - –∫–∞—Ç–∞–ª–æ–≥, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–ª—É–∂–µ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è kubectl (–∫–æ–Ω—Ñ–∏–≥–∏, –∫–µ—à–∏, —Å—Ö–µ–º—ã API);

2. –ü–æ–¥–Ω—è—Ç –∫–ª–∞—Å—Ç–µ—Ä –≤ `minikube`.

–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –¥—Ä–∞–π–≤–µ—Ä –¥–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –∫–ª–∞—Å—Ç–µ—Ä–∞ –≤ minikube docker. –í –¥–∞–Ω–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞ —É –º–µ–Ω—è –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ –æ–±—Ä–∞–∑–∞–º –º–æ–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ –≤ `Docker Hub`, –ø–æ—ç—Ç–æ–º—É –∫–ª–∞—Å—Ç–µ—Ä –±—ã–ª –ø–æ–¥–Ω—è—Ç —Å –¥—Ä–∞–π–≤–µ—Ä–æ–º `Virtualbox` (—Å –Ω–∏–º –ø—Ä–æ–±–ª–µ–º –Ω–µ –±—ã–ª–æ).

```bash
$ minikube start --driver=virtualbox
```
–í –ø—Ä–æ—Ü–µ—Å—Å–µ –ø–æ–¥–Ω—è—Ç–∏—è –∫–ª–∞—Å—Ç–µ—Ä–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è `kubectl`.

```bash
$ kubectl get nodes
NAME       STATUS   ROLES           AGE   VERSION
minikube   Ready    control-plane   32s   v1.28.3
```
3. C–æ–∑–¥–∞–Ω –º–∞–Ω–∏—Ñ–µ—Å—Ç `./kubernetes-intro/namespace.yaml` –¥–ª—è namespace —Å –∏–º–µ–Ω–µ–º `homework`.

```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: homework
```

4. –°–æ–∑–¥–∞–Ω –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞ `./kubernetes-intro/pod.yaml`, –æ–ø–∏—Å—ã–≤–∞—é—â–∏–π –ø–æ–¥–Ω–∏–º–∞–µ–º—ã–π Pod –∏ —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—è—é—â–∏–π —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –î–ó.

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: homework-pod
  namespace: homework
  labels:
    app: homework-pod
spec:
  containers:
  - name: web-server
    image: nginx:alpine
    ports:
    - containerPort: 8000
    volumeMounts:
    - name: homework-volume
      mountPath: /homework
    lifecycle:
      preStop:
        exec:
          command: ["rm", "/homework/index.html"]
    command: ["/bin/sh", "-c"]
    args:
    - |
      cp /homework/index.html /usr/share/nginx/html/index.html && \
      exec nginx -g 'daemon off;' -c /etc/nginx/nginx.conf
  initContainers:
  - name: init-container
    image: busybox
    command: ["/bin/sh", "-c"]
    args:
      - echo "Hello, OTUS! Homework 1!" > /init/index.html
    volumeMounts:
    - name: homework-volume
      mountPath: /init
  volumes:
  - name: homework-volume
    emptyDir: {}
```

### –ü–æ—è—Å–Ω–µ–Ω–∏–µ:

1. **Namespace**: Pod —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤ namespace `homework`.

2. **Init-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä**: 
    - –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä `init-container` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –æ–±—Ä–∞–∑ `busybox` –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ñ–∞–π–ª `index.html` —Å —Ç–µ–∫—Å—Ç–æ–º "Hello, OTUS! Homework 1", —Å–æ—Ö—Ä–∞–Ω—è—è –µ–≥–æ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é `/init`.
3. **–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä `web-server`**:
    - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –æ–±—Ä–∞–∑ `nginx:alpine` –∏ –ø–æ–¥–Ω–∏–º–∞–µ—Ç –≤–µ–±-—Å–µ—Ä–≤–µ—Ä –Ω–∞ –ø–æ—Ä—Ç—É `8000`.
    - –§–∞–π–ª `index.html` –∫–æ–ø–∏—Ä—É–µ—Ç—Å—è –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ Nginx `/usr/share/nginx/html/`.
    - –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω —Ç–∞–∫, —á—Ç–æ–±—ã —É–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª `index.html` –∏–∑ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `/homework` –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ Pod (—Ñ–∞–∑–∞ `preStop`).
4. **–û–±—â–∏–π —Ç–æ–º**:
    - –¢–æ–º `homework-volume` —è–≤–ª—è–µ—Ç—Å—è –æ–±—â–∏–º –¥–ª—è –æ–±–æ–∏—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤. –û–Ω –º–æ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è –∫–∞–∫ `/homework` –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –∏ –∫–∞–∫ `/init` –≤ init-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ.
    - –¢–æ–º —Å–æ–∑–¥–∞–µ—Ç—Å—è –∫–∞–∫ `emptyDir`, —á—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –æ–Ω —è–≤–ª—è–µ—Ç—Å—è –ø—É—Å—Ç—ã–º –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–º.

```bash
$ kubectl get pods -n homework
NAME           READY   STATUS    RESTARTS   AGE
homework-pod   1/1     Running   0          22h
```

5. –î–ª—è –æ—Ç—Ä–∞–±–æ—Ç–∫–∏ —Å–µ—Ç–µ–≤–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –ø–æ–¥–Ω—è—Ç–æ–≥–æ Pod –∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ –∫ –Ω–µ–º—É —á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä –Ω–∞ —Ö–æ—Å—Ç–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ, –Ω–∞–ø–∏—Å–∞–Ω –º–∞–Ω–∏—Ñ–µ—Å—Ç `./kubernetes-intro/service.yaml` –¥–ª—è `Service` —Å —Ç–∏–ø–æ–º `LoadBalancer`.

```yaml
apiVersion: v1
kind: Service
metadata:
  name: homework-service
  namespace: homework
spec:
  type: LoadBalancer
  selector:
    app: homework-pod
  ports:
    - protocol: TCP
      port: 8000
      targetPort: 80
```

### –ü–æ—è—Å–Ω–µ–Ω–∏–µ:

1. **Selector**: 
   - `Service` –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç Pod, –∫–æ—Ç–æ—Ä—ã–π –µ–º—É –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ–±—Å–ª—É–∂–∏–≤–∞—Ç—å –ø—Ä–∏ –ø–æ–º–æ—â–∏ –º–µ—Ç–∫–∏ `app: homework-pod`.
   
2. **Ports**:
   - `port: 8000`: –ü–æ—Ä—Ç, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º `Service` –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.
   - `targetPort: 80`: –ü–æ—Ä—Ç –≤–Ω—É—Ç—Ä–∏ Pod, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –∑–∞–ø—É—â–µ–Ω –≤–µ–±-—Å–µ—Ä–≤–µ—Ä.


–ü—Ä–∏–º–µ–Ω—è–µ–º –º–∞–Ω–∏—Ñ–µ—Å—Ç –¥–ª—è Service:
   ```bash
   $ kubectl apply -f service.yaml
   ```

–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –ø–æ–ª—É—á–∞–µ–º IP-–∞–¥—Ä–µ—Å, –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–π –¥–ª—è Service:
   ```bash
   $ minikube service homework-service -n homework --url
   http://192.168.59.102:31810

$ minikube service list
|----------------------|---------------------------|--------------|-----------------------------|
|      NAMESPACE       |           NAME            | TARGET PORT  |             URL             |
|----------------------|---------------------------|--------------|-----------------------------|
| default              | kubernetes                | No node port |                             |
| homework             | homework-service          |         8000 | http://192.168.59.102:31810 |
| kube-system          | kube-dns                  | No node port |                             |
| kubernetes-dashboard | dashboard-metrics-scraper | No node port |                             |
| kubernetes-dashboard | kubernetes-dashboard      | No node port |                             |
|----------------------|---------------------------|--------------|-----------------------------|

$ minikube service homework-service -n homework
|-----------|------------------|-------------|-----------------------------|
| NAMESPACE |       NAME       | TARGET PORT |             URL             |
|-----------|------------------|-------------|-----------------------------|
| homework  | homework-service |        8000 | http://192.168.59.102:31810 |
|-----------|------------------|-------------|-----------------------------|
üéâ  Opening service homework/homework-service in default browser...
Found ffmpeg: /opt/yandex/browser-beta/libffmpeg.so
	avcodec: 3876708
	avformat: 3874148
	avutil: 3743332
Ffmpeg version is OK! Let's use it.
```
–í `minikube` —Ç–∏–ø `LoadBalancer` —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—É—Ç–µ–º –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–∞ `NodePort`, –∏ minikube service –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç `URL` –≤ `–±—Ä–∞—É–∑–µ—Ä–µ` –∏–ª–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∫–æ–º–∞–Ω–¥—É –¥–ª—è –µ–≥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è.

![Alt text](./kubernetes-intro/HW1_image.jpg)

–í—ã–≤–æ–¥ –±—Ä–∞—É–∑–µ—Ä–∞.